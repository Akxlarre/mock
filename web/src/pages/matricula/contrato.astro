---
/**
 * RF-083: Contrato Digital con Firma Electr√≥nica
 * Permite al alumno revisar y aceptar el contrato de matr√≠cula antes de finalizar.
 */
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import Card from "../../components/ui/Card.astro";
import Button from "../../components/ui/Button.astro";
import { ESCUELA_ACTUAL } from "../../lib/mockData";

const basePath = "";
---

<DashboardLayout title="Contrato Digital" escuela={ESCUELA_ACTUAL}>
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center gap-2 text-sm text-secondary mb-2">
                <a href={`${basePath}/dashboard`} class="hover:text-gray-900"
                    >Inicio</a
                >
                <span>/</span>
                <a href={`${basePath}/matricula`} class="hover:text-gray-900"
                    >Matr√≠culas</a
                >
                <span>/</span>
                <span class="text-gray-900 font-medium">Contrato Digital</span>
            </div>
            <h1 class="text-3xl font-semibold text-gray-900">
                Contrato de Matr√≠cula
            </h1>
            <p class="text-secondary mt-1">
                Revise y acepte los t√©rminos del contrato de matr√≠cula
            </p>
        </div>

        <!-- Alumno Info -->
        <Card class="mb-6">
            <div id="contrato-alumno" class="flex items-center gap-4">
                <div
                    id="alumno-avatar"
                    class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg"
                >
                    M
                </div>
                <div>
                    <p
                        id="alumno-nombre"
                        class="text-lg font-semibold text-gray-900"
                    >
                        Mar√≠a Gonz√°lez P√©rez
                    </p>
                    <p id="alumno-detalle" class="text-sm text-secondary">
                        RUT: 18.234.567-8 ‚Ä¢ Clase B ‚Ä¢ Matr√≠cula #MAT-2026-0247
                    </p>
                </div>
            </div>
        </Card>

        <!-- Contrato Document -->
        <Card class="mb-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900">
                    üìÑ Contrato de Prestaci√≥n de Servicios Educativos
                </h2>
                <span
                    class="text-xs text-secondary bg-gray-100 px-3 py-1 rounded-full"
                    >v2.1 ‚Äî Febrero 2026</span
                >
            </div>

            <div
                id="contrato-contenido"
                class="prose prose-sm max-w-none border border-gray-200 rounded-lg p-6 bg-gray-50 max-h-96 overflow-y-auto"
            >
                <p class="text-xs text-secondary mb-4 italic">
                    √öltima actualizaci√≥n: 01 de Febrero de 2026
                </p>

                <h3 class="text-base font-bold text-gray-900 mt-0">
                    CL√ÅUSULA PRIMERA ‚Äî PARTES
                </h3>
                <p class="text-sm text-gray-700">
                    Entre la <strong
                        >Escuela de Conductores "AutoEscuela Profesional SpA"</strong
                    >, RUT 76.543.210-9, representada por su Director, en
                    adelante "la Escuela", y el alumno identificado en el
                    encabezado de este documento, en adelante "el Alumno", se
                    celebra el siguiente contrato de prestaci√≥n de servicios
                    educativos.
                </p>

                <h3 class="text-base font-bold text-gray-900">
                    CL√ÅUSULA SEGUNDA ‚Äî OBJETO
                </h3>
                <p class="text-sm text-gray-700">
                    La Escuela se compromete a impartir al Alumno un programa
                    te√≥rico-pr√°ctico de conducci√≥n vehicular, conforme a la
                    normativa vigente del Ministerio de Transportes y
                    Telecomunicaciones, para la obtenci√≥n de la licencia de
                    conducir correspondiente al tipo de curso contratado.
                </p>

                <h3 class="text-base font-bold text-gray-900">
                    CL√ÅUSULA TERCERA ‚Äî PROGRAMA DE FORMACI√ìN
                </h3>
                <p class="text-sm text-gray-700">El programa incluye:</p>
                <ul class="text-sm text-gray-700 list-disc pl-5 space-y-1">
                    <li>
                        Clases te√≥ricas presenciales seg√∫n plan de estudios
                        aprobado
                    </li>
                    <li>
                        Clases pr√°cticas de conducci√≥n con instructor habilitado
                    </li>
                    <li>Material did√°ctico y acceso a plataforma e-learning</li>
                    <li>Evaluaciones peri√≥dicas del avance del alumno</li>
                    <li>
                        Certificado de aprobaci√≥n al finalizar
                        satisfactoriamente el curso
                    </li>
                </ul>

                <h3 class="text-base font-bold text-gray-900">
                    CL√ÅUSULA CUARTA ‚Äî ARANCELES Y FORMA DE PAGO
                </h3>
                <p class="text-sm text-gray-700">
                    El valor total del programa se establece seg√∫n la lista de
                    precios vigente al momento de la matr√≠cula. El pago podr√°
                    realizarse al contado o en cuotas seg√∫n las modalidades
                    ofrecidas. El incumplimiento de pago faculta a la Escuela a
                    suspender las clases hasta regularizar la situaci√≥n
                    financiera.
                </p>

                <h3 class="text-base font-bold text-gray-900">
                    CL√ÅUSULA QUINTA ‚Äî OBLIGACIONES DEL ALUMNO
                </h3>
                <ul class="text-sm text-gray-700 list-disc pl-5 space-y-1">
                    <li>Asistir puntualmente a las clases programadas</li>
                    <li>Cumplir con el reglamento interno de la Escuela</li>
                    <li>
                        Presentar la documentaci√≥n requerida en los plazos
                        establecidos
                    </li>
                    <li>Mantener al d√≠a los pagos comprometidos</li>
                    <li>
                        Respetar las normas de tr√°nsito durante las clases
                        pr√°cticas
                    </li>
                </ul>

                <h3 class="text-base font-bold text-gray-900">
                    CL√ÅUSULA SEXTA ‚Äî POL√çTICA DE CANCELACI√ìN
                </h3>
                <p class="text-sm text-gray-700">
                    El Alumno podr√° desistir del contrato dentro de los 10 d√≠as
                    h√°biles siguientes a la firma, con derecho a la devoluci√≥n
                    del 100% del monto pagado. Posterior a dicho plazo, se
                    aplicar√° una retenci√≥n proporcional seg√∫n las clases
                    efectivamente realizadas.
                </p>

                <h3 class="text-base font-bold text-gray-900">
                    CL√ÅUSULA S√âPTIMA ‚Äî PROTECCI√ìN DE DATOS
                </h3>
                <p class="text-sm text-gray-700">
                    La Escuela se compromete a proteger los datos personales del
                    Alumno conforme a la Ley 19.628 sobre Protecci√≥n de la Vida
                    Privada. Los datos ser√°n utilizados exclusivamente para
                    fines educativos y administrativos relacionados con el
                    servicio contratado.
                </p>
            </div>

            <p class="text-xs text-secondary mt-3 text-center">
                üìú Scroll hacia abajo para leer el contrato completo antes de
                aceptar
            </p>
        </Card>

        <!-- Aceptaci√≥n y Firma -->
        <Card>
            <h2 class="text-lg font-semibold text-gray-900 mb-4">
                ‚úçÔ∏è Aceptaci√≥n y Firma Electr√≥nica
            </h2>

            <div class="space-y-4">
                <!-- Checkbox T√©rminos -->
                <label
                    class="flex items-start gap-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors"
                >
                    <input
                        type="checkbox"
                        id="check-terminos"
                        class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    />
                    <div>
                        <p class="text-sm font-medium text-gray-900">
                            Declaro haber le√≠do y comprendido todas las
                            cl√°usulas del contrato
                        </p>
                        <p class="text-xs text-secondary">
                            Acepto los t√©rminos y condiciones establecidos en el
                            contrato de prestaci√≥n de servicios.
                        </p>
                    </div>
                </label>

                <!-- Checkbox Datos -->
                <label
                    class="flex items-start gap-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors"
                >
                    <input
                        type="checkbox"
                        id="check-datos"
                        class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    />
                    <div>
                        <p class="text-sm font-medium text-gray-900">
                            Autorizo el tratamiento de mis datos personales
                        </p>
                        <p class="text-xs text-secondary">
                            Conforme a la Ley 19.628 de Protecci√≥n de Datos
                            Personales.
                        </p>
                    </div>
                </label>

                <!-- Checkbox Reglamento -->
                <label
                    class="flex items-start gap-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors"
                >
                    <input
                        type="checkbox"
                        id="check-reglamento"
                        class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    />
                    <div>
                        <p class="text-sm font-medium text-gray-900">
                            Me comprometo a cumplir el reglamento interno de la
                            escuela
                        </p>
                        <p class="text-xs text-secondary">
                            Incluye asistencia, puntualidad y comportamiento
                            durante las clases.
                        </p>
                    </div>
                </label>

                <!-- Firma electr√≥nica: campo nombre completo -->
                <div
                    class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200"
                >
                    <label
                        for="firma-nombre"
                        class="block text-sm font-medium text-blue-900 mb-2"
                    >
                        ‚úèÔ∏è Firma electr√≥nica ‚Äî escriba su nombre completo
                    </label>
                    <input
                        type="text"
                        id="firma-nombre"
                        placeholder="Ej: Mar√≠a Gonz√°lez P√©rez"
                        class="w-full h-11 px-4 text-sm border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white font-medium"
                    />
                    <p class="text-xs text-blue-700 mt-2">
                        Al escribir su nombre completo y confirmar, est√°
                        firmando electr√≥nicamente este contrato conforme a la
                        Ley 19.799.
                    </p>
                </div>
            </div>

            <!-- Botones -->
            <div class="flex gap-3 pt-6 mt-6 border-t border-gray-200">
                <a href={`${basePath}/matricula`} class="btn btn-ghost min-h-11"
                    >‚Üê Cancelar</a
                >
                <Button
                    id="btn-firmar"
                    variant="primary"
                    onClick="firmarContrato()"
                    class="opacity-50"
                    disabled
                >
                    üñäÔ∏è Firmar Contrato
                </Button>
            </div>

            <!-- Timestamp de firma (oculto, se muestra al firmar) -->
            <div
                id="firma-confirmada"
                class="hidden mt-6 p-4 rounded-lg bg-green-50 border-2 border-green-300"
            >
                <div class="flex items-center gap-3">
                    <svg
                        class="w-8 h-8 text-green-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                    </svg>
                    <div>
                        <p class="text-sm font-bold text-green-900">
                            ‚úÖ Contrato firmado exitosamente
                        </p>
                        <p id="firma-timestamp" class="text-xs text-green-700">
                        </p>
                        <p class="text-xs text-green-700 mt-1">
                            Se ha enviado una copia al email del alumno.
                        </p>
                    </div>
                </div>
            </div>
        </Card>
    </div>
</DashboardLayout>

<script define:vars={{ basePath }}>
    const checkTerminos = document.getElementById("check-terminos");
    const checkDatos = document.getElementById("check-datos");
    const checkReglamento = document.getElementById("check-reglamento");
    const firmaNombre = document.getElementById("firma-nombre");
    const btnFirmar = document.getElementById("btn-firmar");

    function checkCanSign() {
        const allChecked =
            checkTerminos?.checked &&
            checkDatos?.checked &&
            checkReglamento?.checked;
        const nombreLleno = (firmaNombre?.value || "").trim().length >= 5;
        const canSign = allChecked && nombreLleno;
        if (btnFirmar) {
            btnFirmar.disabled = !canSign;
            btnFirmar.classList.toggle("opacity-50", !canSign);
        }
    }

    checkTerminos?.addEventListener("change", checkCanSign);
    checkDatos?.addEventListener("change", checkCanSign);
    checkReglamento?.addEventListener("change", checkCanSign);
    firmaNombre?.addEventListener("input", checkCanSign);

    window.firmarContrato = function () {
        const nombre = (firmaNombre?.value || "").trim();
        if (!nombre || nombre.length < 5) {
            alert("‚ö†Ô∏è Debe escribir su nombre completo para firmar.");
            return;
        }
        if (
            !checkTerminos?.checked ||
            !checkDatos?.checked ||
            !checkReglamento?.checked
        ) {
            alert("‚ö†Ô∏è Debe aceptar todos los t√©rminos antes de firmar.");
            return;
        }

        const now = new Date();
        const timestamp = now.toLocaleString("es-CL", {
            dateStyle: "full",
            timeStyle: "medium",
        });

        const firmaData = {
            nombre: nombre,
            timestamp: now.toISOString(),
            ip: "192.168.1." + Math.floor(Math.random() * 254 + 1),
            hash:
                "SHA256:" +
                Array.from({ length: 16 }, () =>
                    Math.floor(Math.random() * 16).toString(16),
                ).join(""),
        };

        sessionStorage.setItem("contrato_firma", JSON.stringify(firmaData));

        // Disable form
        if (checkTerminos) checkTerminos.disabled = true;
        if (checkDatos) checkDatos.disabled = true;
        if (checkReglamento) checkReglamento.disabled = true;
        if (firmaNombre) firmaNombre.disabled = true;
        if (btnFirmar) {
            btnFirmar.disabled = true;
            btnFirmar.classList.add("opacity-50");
            btnFirmar.textContent = "‚úÖ Firmado";
        }

        // Show confirmation
        const confirmDiv = document.getElementById("firma-confirmada");
        const timestampEl = document.getElementById("firma-timestamp");
        if (confirmDiv) confirmDiv.classList.remove("hidden");
        if (timestampEl)
            timestampEl.textContent = `Firmado por "${nombre}" el ${timestamp} ‚Ä¢ Hash: ${firmaData.hash}`;
    };

    // Load student data from sessionStorage if available
    document.addEventListener("DOMContentLoaded", () => {
        try {
            const raw = sessionStorage.getItem("matricula_paso1");
            if (raw) {
                const d = JSON.parse(raw);
                const name =
                    [d.nombres, d.apellidos].filter(Boolean).join(" ") ||
                    "Alumno";
                const avatar = document.getElementById("alumno-avatar");
                const nombreEl = document.getElementById("alumno-nombre");
                if (avatar) avatar.textContent = name.charAt(0).toUpperCase();
                if (nombreEl) nombreEl.textContent = name;
            }
        } catch (_) {}
    });
</script>
