---
/**
 * Matr√≠cula Clase Profesional
 * RF-042: Validaciones especiales (edad >21, licencia B >2 a√±os)
 */
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import Card from "../../components/ui/Card.astro";
import Button from "../../components/ui/Button.astro";
import Input from "../../components/ui/Input.astro";
import { ESCUELA_ACTUAL } from "../../lib/mockData";

const PRECIO_PROFESIONAL = 450000;
---

<DashboardLayout title="Matr√≠cula Clase Profesional" escuela={ESCUELA_ACTUAL}>
    <div class="mb-8">
        <h1 class="text-3xl font-semibold text-gray-900 mb-2">
            Matr√≠cula Clase Profesional
        </h1>
        <p class="text-secondary">Camiones y veh√≠culos de carga pesada</p>
    </div>

    <!-- Alert requisitos -->
    <div class="mb-6 p-5 bg-yellow-50 border-2 border-yellow-200 rounded-lg">
        <div class="flex gap-3">
            <svg
                class="w-6 h-6 text-yellow-600 flex-shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                ></path>
            </svg>
            <div class="flex-1">
                <p class="text-sm font-bold text-yellow-900 mb-2">
                    ‚ö†Ô∏è Requisitos Obligatorios Clase Profesional
                </p>
                <ul class="text-sm text-yellow-800 space-y-1">
                    <li class="flex items-start gap-2">
                        <span class="font-bold">‚úì</span>
                        <span
                            >Edad m√≠nima: <strong>21 a√±os cumplidos</strong
                            ></span
                        >
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="font-bold">‚úì</span>
                        <span
                            >Licencia Clase B vigente con antig√ºedad m√≠nima de <strong
                                >2 a√±os</strong
                            ></span
                        >
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="font-bold">‚úì</span>
                        <span
                            >Upload obligatorio: <strong
                                >Foto de licencia anterior (ambas caras)</strong
                            ></span
                        >
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <Card class="max-w-4xl mx-auto">
        <form id="form-profesional" class="space-y-6">
            <!-- Datos Personales -->
            <div>
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    Datos del Postulante
                </h2>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="label">
                            <span class="label-text font-medium">RUT *</span>
                        </label>
                        <input
                            type="text"
                            id="rut"
                            class="input input-bordered w-full min-h-11"
                            placeholder="12.345.678-9"
                            required
                        />
                        <p id="rut-feedback" class="text-xs mt-1 hidden"></p>
                    </div>

                    <div>
                        <label class="label">
                            <span class="label-text font-medium"
                                >Nombre Completo *</span
                            >
                        </label>
                        <input
                            type="text"
                            class="input input-bordered w-full min-h-11"
                            placeholder="Juan P√©rez Gonz√°lez"
                            required
                        />
                    </div>

                    <div>
                        <label class="label">
                            <span class="label-text font-medium"
                                >Fecha de Nacimiento *</span
                            >
                        </label>
                        <input
                            type="date"
                            id="fecha-nacimiento"
                            class="input input-bordered w-full min-h-11"
                            required
                        />
                        <p id="edad-feedback" class="text-xs mt-1 hidden"></p>
                    </div>

                    <div>
                        <label class="label">
                            <span class="label-text font-medium"
                                >Tel√©fono *</span
                            >
                        </label>
                        <input
                            type="tel"
                            class="input input-bordered w-full min-h-11"
                            placeholder="+56 9 1234 5678"
                            required
                        />
                    </div>

                    <div class="md:col-span-2">
                        <label class="label">
                            <span class="label-text font-medium">Email *</span>
                        </label>
                        <input
                            type="email"
                            class="input input-bordered w-full min-h-11"
                            placeholder="juan@email.cl"
                            required
                        />
                    </div>
                </div>
            </div>

            <!-- Licencia Anterior -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    Licencia Clase B Actual
                </h3>

                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="label">
                            <span class="label-text font-medium"
                                >N√∫mero Licencia *</span
                            >
                        </label>
                        <input
                            type="text"
                            id="numero-licencia"
                            class="input input-bordered w-full min-h-11"
                            placeholder="12345678"
                            required
                        />
                    </div>

                    <div>
                        <label class="label">
                            <span class="label-text font-medium"
                                >Fecha de Emisi√≥n *</span
                            >
                        </label>
                        <input
                            type="date"
                            id="fecha-emision-licencia"
                            class="input input-bordered w-full min-h-11"
                            required
                        />
                        <p id="antiguedad-feedback" class="text-xs mt-1 hidden">
                        </p>
                    </div>

                    <div>
                        <label class="label">
                            <span class="label-text font-medium"
                                >Fecha de Vencimiento *</span
                            >
                        </label>
                        <input
                            type="date"
                            class="input input-bordered w-full min-h-11"
                            required
                        />
                    </div>

                    <div>
                        <label class="label">
                            <span class="label-text font-medium"
                                >Municipalidad Emisora *</span
                            >
                        </label>
                        <input
                            type="text"
                            class="input input-bordered w-full min-h-11"
                            placeholder="Chill√°n"
                            required
                        />
                    </div>
                </div>

                <!-- Upload licencia -->
                <div
                    class="p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300"
                >
                    <label class="block mb-2">
                        <span class="text-sm font-medium text-gray-900"
                            >Foto Licencia Clase B (ambas caras) *</span
                        >
                    </label>
                    <input
                        type="file"
                        id="upload-licencia"
                        accept=".jpg,.png,.pdf"
                        class="file-input file-input-bordered w-full min-h-11"
                        required
                    />
                    <p class="text-xs text-secondary mt-2">
                        Formatos: JPG, PNG, PDF ‚Ä¢ M√°x: 5MB ‚Ä¢ Ambas caras en un
                        solo archivo
                    </p>
                </div>
            </div>

            <!-- Precio -->
            <div class="border-t pt-6">
                <div
                    class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-6 border-2 border-purple-200"
                >
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-purple-900 font-medium mb-1">
                                Matr√≠cula Clase Profesional
                            </p>
                            <p class="text-xs text-purple-700">
                                Incluye 15 clases pr√°cticas + manual te√≥rico
                            </p>
                        </div>
                        <p class="text-4xl font-bold text-purple-600">
                            ${PRECIO_PROFESIONAL.toLocaleString("es-CL")}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Info adicional -->
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <div class="flex gap-3">
                    <svg
                        class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-blue-900 mb-1">
                            üìö Contenido del Curso
                        </p>
                        <ul class="text-xs text-blue-800 space-y-1">
                            <li>‚Ä¢ 15 clases pr√°cticas en cami√≥n</li>
                            <li>
                                ‚Ä¢ Manual te√≥rico normativa transporte de carga
                            </li>
                            <li>‚Ä¢ Simulaci√≥n examen municipal</li>
                            <li>
                                ‚Ä¢ Apoyo gesti√≥n documentaci√≥n ante municipalidad
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="flex gap-3 pt-4">
                <Button
                    href="/matricula"
                    variant="ghost"
                    class="flex-1 justify-center"
                >
                    Cancelar
                </Button>
                <Button
                    id="btn-continuar"
                    type="button"
                    variant="primary"
                    class="flex-1 justify-center"
                    disabled
                    onClick="validarYContinuar()"
                >
                    Continuar a Documentos
                </Button>
            </div>
        </form>
    </Card>
</DashboardLayout>

<script define:vars={{ PRECIO_PROFESIONAL }}>
    let validaciones = {
        rut: false,
        edad: false,
        antiguedadLicencia: false,
        uploadLicencia: false,
    };

    // RUT validation
    const rutInput = document.getElementById("rut");
    const rutFeedback = document.getElementById("rut-feedback");

    rutInput?.addEventListener("blur", () => {
        const rut = rutInput.value.trim();

        // Simplified validation (en producci√≥n usar M√≥dulo 11)
        if (rut.length >= 9) {
            validaciones.rut = true;
            rutInput.classList.add("border-green-500");
            rutInput.classList.remove("border-red-500");
            if (rutFeedback) {
                rutFeedback.textContent = "‚úì RUT v√°lido";
                rutFeedback.className = "text-xs mt-1 text-green-600";
                rutFeedback.classList.remove("hidden");
            }
        } else {
            validaciones.rut = false;
            rutInput.classList.add("border-red-500");
            if (rutFeedback) {
                rutFeedback.textContent = "‚ùå RUT inv√°lido";
                rutFeedback.className = "text-xs mt-1 text-red-600";
                rutFeedback.classList.remove("hidden");
            }
        }

        checkCanContinue();
    });

    // Edad validation
    const fechaNacInput = document.getElementById("fecha-nacimiento");
    const edadFeedback = document.getElementById("edad-feedback");

    fechaNacInput?.addEventListener("change", () => {
        const fechaNac = new Date(fechaNacInput.value);
        const hoy = new Date();
        const edad = Math.floor(
            (hoy.getTime() - fechaNac.getTime()) /
                (365.25 * 24 * 60 * 60 * 1000),
        );

        if (edad >= 21) {
            validaciones.edad = true;
            fechaNacInput.classList.add("border-green-500");
            fechaNacInput.classList.remove("border-red-500");
            if (edadFeedback) {
                edadFeedback.textContent = `‚úì ${edad} a√±os (cumple requisito)`;
                edadFeedback.className = "text-xs mt-1 text-green-600";
                edadFeedback.classList.remove("hidden");
            }
        } else {
            validaciones.edad = false;
            fechaNacInput.classList.add("border-red-500");
            if (edadFeedback) {
                edadFeedback.textContent = `‚ùå ${edad} a√±os (m√≠nimo 21 a√±os)`;
                edadFeedback.className = "text-xs mt-1 text-red-600";
                edadFeedback.classList.remove("hidden");
            }
        }

        checkCanContinue();
    });

    // Antig√ºedad licencia validation
    const fechaEmisionInput = document.getElementById("fecha-emision-licencia");
    const antiguedadFeedback = document.getElementById("antiguedad-feedback");

    fechaEmisionInput?.addEventListener("change", () => {
        const fechaEmision = new Date(fechaEmisionInput.value);
        const hoy = new Date();
        const antiguedadAnios = Math.floor(
            (hoy.getTime() - fechaEmision.getTime()) /
                (365.25 * 24 * 60 * 60 * 1000),
        );

        if (antiguedadAnios >= 2) {
            validaciones.antiguedadLicencia = true;
            fechaEmisionInput.classList.add("border-green-500");
            fechaEmisionInput.classList.remove("border-red-500");
            if (antiguedadFeedback) {
                antiguedadFeedback.textContent = `‚úì ${antiguedadAnios} a√±os de antig√ºedad (cumple requisito)`;
                antiguedadFeedback.className = "text-xs mt-1 text-green-600";
                antiguedadFeedback.classList.remove("hidden");
            }
        } else {
            validaciones.antiguedadLicencia = false;
            fechaEmisionInput.classList.add("border-red-500");
            if (antiguedadFeedback) {
                antiguedadFeedback.textContent = `‚ùå ${antiguedadAnios} a√±os (m√≠nimo 2 a√±os)`;
                antiguedadFeedback.className = "text-xs mt-1 text-red-600";
                antiguedadFeedback.classList.remove("hidden");
            }
        }

        checkCanContinue();
    });

    // Upload validation
    const uploadInput = document.getElementById("upload-licencia");
    uploadInput?.addEventListener("change", (e) => {
        const files = e.target.files;
        validaciones.uploadLicencia = files && files.length > 0;
        checkCanContinue();
    });

    function checkCanContinue() {
        const btn = document.getElementById("btn-continuar");
        const todasValidas = Object.values(validaciones).every(
            (v) => v === true,
        );

        if (btn) {
            btn.disabled = !todasValidas;
            btn.classList.toggle("opacity-50", !todasValidas);
        }
    }

    window.validarYContinuar = function () {
        if (!Object.values(validaciones).every((v) => v === true)) {
            alert("‚ö†Ô∏è Por favor completa todos los requisitos obligatorios");
            return;
        }

        alert(
            `‚úì Validaci√≥n exitosa\n\n‚Ä¢ Edad: Cumple (>21 a√±os)\n‚Ä¢ Licencia B: Antig√ºedad v√°lida (>2 a√±os)\n‚Ä¢ Documentos: Upload completo\n\nPrecio Matr√≠cula: $${PRECIO_PROFESIONAL.toLocaleString("es-CL")}\n\nRedirigiendo a upload documentos...`,
        );

        setTimeout(() => {
            // En producci√≥n ir√≠a a wizard documentos clase profesional
            window.location.href = "/matricula/profesional/documentos";
        }, 2000);
    };
</script>
