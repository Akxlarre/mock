---
/**
 * Wizard Matr√≠cula - Paso 2: Documentos (admin)
 * RF-082.1: Upload Autorizaci√≥n Notarial condicional (menores 17)
 * RF-062/RF-063: Documentos clase profesional condicionales (esProfesional)
 * RF-082.3: Hoja de Vida del Conductor + validaci√≥n 30 d√≠as
 * Clase Profesional: Hoja de Vida obligatoria; c√©dula y licencia opcionales (se permite
 * comenzar el curso aunque no tengan la licencia f√≠sicamente).
 */
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import Card from "../../../components/ui/Card.astro";
import Button from "../../../components/ui/Button.astro";
import MatriculaWizardSteps from "../../../components/matricula/MatriculaWizardSteps.astro";
import { ESCUELA_ACTUAL } from "../../../lib/mockData";

const basePath = "";

// Fallback para acceso directo a la URL (sin paso 1)
const alumnoData = {
  nombre: "Mar√≠a Gonz√°lez P√©rez",
  rut: "18.234.567-8",
  curso: "Clase B",
};
---

<DashboardLayout title="Matr√≠cula - Documentaci√≥n" escuela={ESCUELA_ACTUAL}>
  <MatriculaWizardSteps pasoActual={2} basePath={basePath} />

  <Card class="max-w-4xl mx-auto">
    <!-- Alumno info (se actualiza desde sessionStorage si viene del paso 1) -->
    <div
      id="alumno-info"
      class="bg-blue-50 rounded-lg p-4 mb-6 flex items-center gap-3"
    >
      <div
        id="alumno-inicial"
        class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold"
      >
        {alumnoData.nombre.charAt(0)}
      </div>
      <div>
        <p id="alumno-nombre" class="text-sm font-semibold text-gray-900">
          {alumnoData.nombre}
        </p>
        <p id="alumno-rut-curso" class="text-xs text-secondary">
          {alumnoData.rut} ‚Ä¢ {alumnoData.curso}
        </p>
      </div>
    </div>

    <!-- RF-082.1: Banner menor de edad (se muestra din√°micamente) -->
    <div
      id="menor-edad-banner"
      class="hidden mb-6 p-4 rounded-lg border-2 border-yellow-300 bg-yellow-50"
    >
      <div class="flex items-start gap-3">
        <svg
          class="w-6 h-6 text-yellow-600 shrink-0 mt-0.5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          ></path>
        </svg>
        <div>
          <p class="text-sm font-bold text-yellow-900">
            ‚ö†Ô∏è Alumno menor de edad ‚Äî Documentaci√≥n adicional requerida
          </p>
          <p class="text-xs text-yellow-800 mt-1">
            Se requiere <strong>Autorizaci√≥n Notarial firmada</strong> por el apoderado.
            Sin este documento no se podr√° completar la matr√≠cula.
          </p>
        </div>
      </div>
    </div>

    <h2 class="text-xl font-semibold text-gray-900 mb-6">
      Documentos Requeridos
    </h2>

    <form id="documentos-form" class="space-y-6">

      <!-- M√≥dulo 2: Foto para Carnet (c√°mara o subir archivo) -->
      <div class="border border-gray-200 rounded-lg overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 flex items-center gap-2">
          <span class="text-sm font-medium text-gray-900">Foto para Carnet</span>
          <span class="text-xs font-medium text-red-500">*</span>
          <span class="ml-auto text-xs text-gray-500">Frontal, fondo blanco</span>
        </div>
        <div class="p-4 space-y-4">

          <!-- Tabs -->
          <div class="flex gap-2">
            <button
              type="button"
              id="tab-camara"
              class="flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-md border border-gray-900 bg-gray-900 text-white transition-colors"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
              </svg>
              Tomar foto
            </button>
            <button
              type="button"
              id="tab-subir"
              class="flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-md border border-gray-200 bg-white text-gray-600 hover:bg-gray-50 transition-colors"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
              </svg>
              Subir foto
            </button>
          </div>

          <!-- Secci√≥n c√°mara -->
          <div id="seccion-camara">
            <div id="camara-idle" class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
              <svg class="w-10 h-10 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
              </svg>
              <p class="text-sm text-gray-500 mb-3">Usa la c√°mara de tu dispositivo para tomarte la foto</p>
              <button
                type="button"
                id="btn-activar-camara"
                class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-md hover:bg-gray-700 transition-colors"
              >
                Activar c√°mara
              </button>
              <p class="text-xs text-gray-400 mt-2">Se solicitar√° permiso para acceder a la c√°mara</p>
            </div>
            <div id="camara-activa" class="hidden space-y-3">
              <div class="relative rounded-lg overflow-hidden bg-black max-w-xs mx-auto">
                <video
                  id="camara-video"
                  class="w-full object-cover"
                  autoplay
                  playsinline
                  muted
                  style="aspect-ratio:4/3"
                ></video>
                <div class="absolute inset-0 border-2 border-dashed border-white/30 rounded-lg pointer-events-none m-2"></div>
              </div>
              <div class="text-center">
                <button
                  type="button"
                  id="btn-capturar"
                  class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-md hover:bg-gray-700 transition-colors"
                >
                  üì∏ Capturar foto
                </button>
              </div>
            </div>
          </div>

          <!-- Secci√≥n subir archivo -->
          <div id="seccion-subir" class="hidden">
            <div class="border-2 border-dashed border-gray-200 rounded-lg p-8 text-center hover:border-gray-300 transition-colors">
              <svg class="w-8 h-8 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
              </svg>
              <p class="text-sm text-gray-600 mb-3">Selecciona o arrastra una foto tuya</p>
              <input
                type="file"
                id="foto-upload-input"
                accept=".jpg,.jpeg,.png"
                class="hidden"
              />
              <label
                for="foto-upload-input"
                class="cursor-pointer inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md shadow-sm hover:bg-gray-50 transition-colors"
              >
                Elegir archivo
              </label>
              <p class="text-xs text-gray-400 mt-2">JPG, PNG ¬∑ M√°x: 2MB</p>
            </div>
          </div>

          <!-- Preview compartido -->
          <div id="foto-preview-wrap" class="hidden">
            <div class="flex items-start gap-4 p-4 bg-green-50 border border-green-200 rounded-lg">
              <img
                id="foto-preview-img"
                class="w-20 h-20 object-cover rounded-lg border border-gray-200 shrink-0"
                alt="Foto carnet"
              />
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-green-800">‚úì Foto lista para el carnet</p>
                <p class="text-xs text-green-700 mt-1">Tu foto fue capturada/subida correctamente. Estar√° lista para cuando llegues a tu primera clase.</p>
                <button
                  type="button"
                  id="btn-reset-foto"
                  class="mt-2 text-xs text-gray-500 underline hover:text-gray-700"
                >
                  Volver a tomar o cambiar
                </button>
              </div>
            </div>
          </div>

          <canvas id="camara-canvas" class="hidden"></canvas>
          <p id="foto-feedback" class="text-xs text-red-600 hidden">‚ö†Ô∏è La foto para el carnet es obligatoria</p>
        </div>
      </div>

      <!-- RF-062/RF-063: Documentos Clase Profesional -->
      <div id="docs-profesional-wrap" class="hidden space-y-4">
        <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-orange-600 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <div>
              <p class="text-sm font-bold text-orange-900">Clase Profesional ‚Äî Documentaci√≥n requerida</p>
              <p class="text-xs text-orange-800 mt-1">Solo la <strong>Hoja de Vida del Conductor</strong> es obligatoria. La c√©dula y licencia pueden adjuntarse si est√°n disponibles ‚Äî el alumno puede comenzar el curso aunque no las tenga f√≠sicamente.</p>
            </div>
          </div>
        </div>

        <!-- Hoja de Vida del Conductor (RF-082.3) ‚Äî OBLIGATORIA -->
        <div class="p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300" id="hvc-wrap">
          <label class="block mb-2">
            <span class="text-sm font-medium text-gray-900">üìã Hoja de Vida del Conductor *</span>
            <span class="ml-2 text-xs text-gray-500">(emitida por el Registro Civil)</span>
          </label>
          <input
            type="file"
            id="hoja-vida-conductor"
            accept=".pdf,.jpg,.png"
            class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer"
          />
          <div class="mt-3">
            <label class="block text-xs text-gray-600 mb-1">Fecha de emisi√≥n del documento <span class="text-red-500">*</span></label>
            <input
              type="date"
              id="hvc-fecha-emision"
              class="h-9 px-3 text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1 w-48"
            />
          </div>
          <!-- RF-082.3: Alerta si > 30 d√≠as -->
          <div id="hvc-alert-30dias" class="hidden mt-2 p-3 bg-yellow-50 border border-yellow-300 rounded-lg">
            <p class="text-xs font-semibold text-yellow-900">‚ö†Ô∏è Documento con m√°s de 30 d√≠as de emisi√≥n</p>
            <p class="text-xs text-yellow-800 mt-0.5">La Hoja de Vida tiene m√°s de 30 d√≠as. Se requiere una versi√≥n m√°s reciente (RF-082.3).</p>
          </div>
          <p id="hvc-feedback" class="text-xs text-red-600 mt-1 hidden">‚ö†Ô∏è Este documento es obligatorio para clase profesional</p>
          <p class="text-xs text-gray-500 mt-2">Formatos: PDF, JPG, PNG ¬∑ M√°x: 5MB</p>
        </div>

        <!-- C√©dula de Identidad ‚Äî opcional -->
        <div class="p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300" id="cedula-wrap">
          <label class="block mb-2">
            <span class="text-sm font-medium text-gray-900">ü™™ C√©dula de Identidad</span>
            <span class="ml-2 text-xs text-gray-400">opcional</span>
          </label>
          <input
            type="file"
            id="cedula-identidad"
            accept=".pdf,.jpg,.png"
            class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer"
          />
          <p class="text-xs text-gray-500 mt-2">Formatos: PDF, JPG, PNG ¬∑ M√°x: 5MB</p>
        </div>

        <!-- Licencia de Conducir ‚Äî opcional -->
        <div class="p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300" id="licencia-wrap">
          <label class="block mb-2">
            <span class="text-sm font-medium text-gray-900">üöó Licencia de Conducir</span>
            <span class="ml-2 text-xs text-gray-400">opcional</span>
          </label>
          <div class="mb-3 p-2 bg-blue-50 border border-blue-200 rounded-md">
            <p class="text-xs text-blue-800">‚ÑπÔ∏è El alumno puede realizar el curso aunque no disponga de la licencia f√≠sicamente.</p>
          </div>
          <input
            type="file"
            id="licencia-conducir"
            accept=".pdf,.jpg,.png"
            class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer"
          />
          <p class="text-xs text-gray-500 mt-2">Formatos: PDF, JPG, PNG ¬∑ M√°x: 5MB</p>
        </div>

        <!-- Resultado Examen Psicol√≥gico Interno ‚Äî PENDIENTE DE DEFINICI√ìN -->
        <!--
        <div class="p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300" id="psico-interno-wrap">
          <label class="block mb-2">
            <span class="text-sm font-medium text-gray-900">üß† Resultado Examen Psicol√≥gico Interno *</span>
          </label>
          <input
            type="file"
            id="psico-interno"
            accept=".pdf"
            class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer"
          />
          <div class="mt-2 flex items-center gap-4">
            <label class="block text-xs text-gray-600">Resultado:</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-1.5 cursor-pointer">
                <input type="radio" name="psico_resultado" value="apto" class="w-3.5 h-3.5" />
                <span class="text-xs text-green-700 font-medium">Apto</span>
              </label>
              <label class="flex items-center gap-1.5 cursor-pointer">
                <input type="radio" name="psico_resultado" value="no_apto" class="w-3.5 h-3.5" />
                <span class="text-xs text-red-700 font-medium">No apto</span>
              </label>
            </div>
          </div>
          <div id="psico-no-apto-alert" class="hidden mt-2 p-3 bg-red-50 border border-red-300 rounded-lg">
            <p class="text-xs font-semibold text-red-900">‚õî Alumno no apto</p>
            <p class="text-xs text-red-800 mt-0.5">El alumno no puede continuar el proceso de matr√≠cula con resultado "No apto".</p>
          </div>
          <p id="psico-feedback" class="text-xs text-red-600 mt-1 hidden">‚ö†Ô∏è Este documento es obligatorio para clase profesional</p>
          <p class="text-xs text-gray-500 mt-2">Formato: PDF ¬∑ M√°x: 5MB</p>
        </div>
        -->
      </div>

      <!-- RF-082.1: Upload Autorizaci√≥n Notarial (condicional, solo menores) -->
      <div id="autorizacion-notarial-wrap" class="hidden">
        <div
          class="p-4 bg-yellow-50 rounded-lg border-2 border-dashed border-yellow-400"
        >
          <label class="block mb-2">
            <span class="text-sm font-medium text-yellow-900"
              >üìã Autorizaci√≥n Notarial Firmada *</span
            >
          </label>
          <input
            type="file"
            id="autorizacion-notarial"
            accept=".jpg,.png,.pdf"
            class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-yellow-100 file:text-yellow-700 hover:file:bg-yellow-200 cursor-pointer"
          />
          <p class="text-xs text-yellow-800 mt-2">
            Documento notarial que autoriza al menor a inscribirse. Formatos:
            JPG, PNG, PDF ¬∑ M√°x: 5MB
          </p>
          <p
            id="autorizacion-feedback"
            class="text-xs text-red-600 mt-1 hidden"
          >
            ‚ö†Ô∏è Este documento es obligatorio para menores de edad
          </p>
        </div>
      </div>

      <div class="bg-gray-50 rounded-lg p-4">
        <div class="flex gap-3">
          <svg
            class="w-5 h-5 text-blue-600 shrink-0 mt-0.5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <div>
            <p class="text-sm font-medium text-gray-900 mb-1">üí° Consejos para la foto</p>
            <ul class="text-xs text-gray-700 space-y-1">
              <li>‚Ä¢ Usa buena iluminaci√≥n y fondo blanco o claro</li>
              <li>‚Ä¢ El rostro debe estar completamente visible y frontal</li>
              <li>‚Ä¢ Formato JPEG o PNG ¬∑ M√°ximo 2MB</li>
            </ul>
          </div>
        </div>
      </div>
    </form>

    <div class="flex gap-3 pt-6 mt-6 border-t border-gray-200">
      <a
        href={`${basePath}/matricula/nueva/paso-1`}
        class="btn btn-ghost min-h-11">‚Üê Anterior</a
      >
      <Button id="btn-siguiente" variant="primary" onClick="continuarPaso3()">
        Siguiente
      </Button>
    </div>
  </Card>
</DashboardLayout>

<script is:inline define:vars={{ basePath }}>
  // ‚îÄ‚îÄ‚îÄ Estado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var streamActivo = null;
  var tabActual = "camara";
  var esMenorFlag = false;
  var esProfesionalFlag = false;
  /* var psicoApto = true; */ // pendiente de definici√≥n
  var uploaded = { fotoAlumno: false, autorizacion: false, hojaVida: false, cedula: false, licencia: false /*, psicoInterno: false */ };

  // ‚îÄ‚îÄ‚îÄ Tabs foto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function switchTab(tab) {
    tabActual = tab;
    var base = "flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-md border transition-colors";
    var active = base + " border-gray-900 bg-gray-900 text-white";
    var inactive = base + " border-gray-200 bg-white text-gray-600 hover:bg-gray-50";
    document.getElementById("tab-camara").className = tab === "camara" ? active : inactive;
    document.getElementById("tab-subir").className = tab === "subir" ? active : inactive;
    document.getElementById("seccion-camara").classList.toggle("hidden", tab !== "camara");
    document.getElementById("seccion-subir").classList.toggle("hidden", tab !== "subir");
    if (tab !== "camara" && streamActivo) {
      streamActivo.getTracks().forEach(function(t) { t.stop(); });
      streamActivo = null;
      document.getElementById("camara-idle").classList.remove("hidden");
      document.getElementById("camara-activa").classList.add("hidden");
    }
  }

  // ‚îÄ‚îÄ‚îÄ C√°mara ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function iniciarCamara() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: { ideal: 640 } } })
      .then(function(stream) {
        streamActivo = stream;
        var video = document.getElementById("camara-video");
        video.srcObject = stream;
        document.getElementById("camara-idle").classList.add("hidden");
        document.getElementById("camara-activa").classList.remove("hidden");
      })
      .catch(function() {
        alert('No se pudo acceder a la c√°mara. Usa la opci√≥n "Subir foto" en su lugar.');
      });
  }

  function capturarFoto() {
    var video = document.getElementById("camara-video");
    var canvas = document.getElementById("camara-canvas");
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    canvas.getContext("2d").drawImage(video, 0, 0);
    var dataUrl = canvas.toDataURL("image/jpeg", 0.9);
    if (streamActivo) { streamActivo.getTracks().forEach(function(t) { t.stop(); }); streamActivo = null; }
    mostrarPreviewFoto(dataUrl);
  }

  function mostrarPreviewFoto(dataUrl) {
    document.getElementById("foto-preview-img").src = dataUrl;
    document.getElementById("foto-preview-wrap").classList.remove("hidden");
    document.getElementById("camara-activa").classList.add("hidden");
    document.getElementById("camara-idle").classList.add("hidden");
    document.getElementById("seccion-subir").classList.add("hidden");
    document.getElementById("foto-feedback").classList.add("hidden");
    uploaded.fotoAlumno = true;
    checkCanContinue();
  }

  function resetFoto() {
    document.getElementById("foto-preview-wrap").classList.add("hidden");
    uploaded.fotoAlumno = false;
    checkCanContinue();
    if (tabActual === "camara") {
      document.getElementById("camara-idle").classList.remove("hidden");
      document.getElementById("seccion-camara").classList.remove("hidden");
      document.getElementById("seccion-subir").classList.add("hidden");
    } else {
      document.getElementById("seccion-subir").classList.remove("hidden");
      var input = document.getElementById("foto-upload-input");
      if (input) input.value = "";
    }
  }

  // ‚îÄ‚îÄ‚îÄ Validaci√≥n continuar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function checkCanContinue() {
    var btn = document.getElementById("btn-siguiente");
    var ok = uploaded.fotoAlumno;
    if (esMenorFlag && !uploaded.autorizacion) ok = false;
    if (esProfesionalFlag) {
      if (!uploaded.hojaVida) ok = false;
      /* pendiente de definici√≥n:
      if (!uploaded.psicoInterno) ok = false;
      if (!psicoApto) ok = false;
      */
    }
    if (btn) { btn.disabled = !ok; btn.classList.toggle("opacity-50", !ok); }
  }

  window.continuarPaso3 = function () {
    if (!uploaded.fotoAlumno) { document.getElementById("foto-feedback").classList.remove("hidden"); return; }
    if (esMenorFlag && !uploaded.autorizacion) { alert("‚ö†Ô∏è Debe adjuntar la Autorizaci√≥n Notarial."); return; }
    if (esProfesionalFlag && !uploaded.hojaVida) { alert("‚ö†Ô∏è Debe adjuntar la Hoja de Vida del Conductor."); return; }
    /* pendiente de definici√≥n:
    if (esProfesionalFlag && !uploaded.psicoInterno) { alert("‚ö†Ô∏è Debe adjuntar el examen psicol√≥gico."); return; }
    */
    sessionStorage.setItem("matricula_paso2", "ok");
    window.location.href = (basePath || "") + "/matricula/nueva/paso-3";
  };

  // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener("astro:page-load", function() {
    checkCanContinue();

    // Widget foto: event listeners
    document.getElementById("tab-camara").addEventListener("click", function() { switchTab("camara"); });
    document.getElementById("tab-subir").addEventListener("click", function() { switchTab("subir"); });
    document.getElementById("btn-activar-camara").addEventListener("click", iniciarCamara);
    document.getElementById("btn-capturar").addEventListener("click", capturarFoto);
    document.getElementById("btn-reset-foto").addEventListener("click", resetFoto);
    document.getElementById("foto-upload-input").addEventListener("change", function(e) {
      var file = e.target.files && e.target.files[0];
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function(ev) { mostrarPreviewFoto(ev.target.result); };
      reader.readAsDataURL(file);
    });

    // Cargar datos paso 1
    try {
      var raw = sessionStorage.getItem("matricula_paso1");
      if (raw) {
        var data = JSON.parse(raw);
        var nombreCompleto = [data.nombres, data.apellidos].filter(Boolean).join(" ") || "Alumno";
        var cursoLabels = { clase_b:"Clase B", clase_b_sence:"Clase B + SENCE", profesional_a2:"Profesional A2", profesional_a3:"Profesional A3", profesional_a4:"Profesional A4", profesional_a5:"Profesional A5" };
        var cursoLabel = cursoLabels[String(data.tipo_curso || "")] || data.tipo_curso || "Clase B";
        var inicial = document.getElementById("alumno-inicial");
        var nombreEl = document.getElementById("alumno-nombre");
        var rutCursoEl = document.getElementById("alumno-rut-curso");
        if (inicial) inicial.textContent = nombreCompleto.charAt(0).toUpperCase();
        if (nombreEl) nombreEl.textContent = nombreCompleto;
        if (rutCursoEl) rutCursoEl.textContent = (data.rut || "") + " ‚Ä¢ " + cursoLabel;
        if (data.esMenor === true) {
          esMenorFlag = true;
          document.getElementById("menor-edad-banner").classList.remove("hidden");
          document.getElementById("autorizacion-notarial-wrap").classList.remove("hidden");
        }
        if (data.esProfesional === true) {
          esProfesionalFlag = true;
          document.getElementById("docs-profesional-wrap").classList.remove("hidden");
        }
      }
    } catch(_) {}

    // RF-082.3: HVC > 30 d√≠as
    document.getElementById("hvc-fecha-emision").addEventListener("change", function() {
      var alert30 = document.getElementById("hvc-alert-30dias");
      if (!this.value) return;
      var dias = Math.floor((new Date() - new Date(this.value)) / 86400000);
      if (alert30) alert30.classList.toggle("hidden", dias <= 30);
    });

    /* pendiente de definici√≥n ‚Äî resultado psicol√≥gico:
    document.querySelectorAll('input[name="psico_resultado"]').forEach(function(r) {
      r.addEventListener("change", function() {
        psicoApto = this.value === "apto";
        var el = document.getElementById("psico-no-apto-alert");
        if (el) el.classList.toggle("hidden", psicoApto);
        checkCanContinue();
      });
    });
    */

    // Autorizaci√≥n notarial (menores)
    document.getElementById("autorizacion-notarial").addEventListener("change", function(e) {
      uploaded.autorizacion = (e.target.files && e.target.files.length > 0);
      var fb = document.getElementById("autorizacion-feedback");
      if (fb) fb.classList.toggle("hidden", uploaded.autorizacion);
      checkCanContinue();
    });

    // Documentos profesionales
    document.getElementById("hoja-vida-conductor").addEventListener("change", function(e) {
      uploaded.hojaVida = (e.target.files && e.target.files.length > 0);
      var fb = document.getElementById("hvc-feedback");
      if (fb) fb.classList.toggle("hidden", uploaded.hojaVida);
      checkCanContinue();
    });
    // C√©dula de identidad (opcional ‚Äî no bloquea continuaci√≥n)
    document.getElementById("cedula-identidad").addEventListener("change", function(e) {
      uploaded.cedula = (e.target.files && e.target.files.length > 0);
    });
    // Licencia de conducir (opcional ‚Äî no bloquea continuaci√≥n)
    document.getElementById("licencia-conducir").addEventListener("change", function(e) {
      uploaded.licencia = (e.target.files && e.target.files.length > 0);
    });
    /* pendiente de definici√≥n ‚Äî psico interno:
    document.getElementById("psico-interno").addEventListener("change", function(e) {
      uploaded.psicoInterno = (e.target.files && e.target.files.length > 0);
      var fb = document.getElementById("psico-feedback");
      if (fb) fb.classList.toggle("hidden", uploaded.psicoInterno);
      checkCanContinue();
    });
    */
  });
</script>
