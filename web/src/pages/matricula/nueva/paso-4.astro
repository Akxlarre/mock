---
/**
 * Wizard Matr√≠cula - Paso 4: Confirmaci√≥n
 * RF-010: Confirmaci√≥n exitosa de matr√≠cula
 */
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import Card from "../../../components/ui/Card.astro";
import Button from "../../../components/ui/Button.astro";
import MatriculaWizardSteps from "../../../components/matricula/MatriculaWizardSteps.astro";
import { ESCUELA_ACTUAL } from "../../../lib/mockData";

// En producci√≥n, estos datos vendr√≠an de sessionStorage o backend
const matriculaData = {
  numero: `2026-${String(Math.floor(Math.random() * 1000) + 200).padStart(4, "0")}`,
  alumno: {
    nombre: "Mar√≠a Gonz√°lez P√©rez",
    rut: "18.234.567-8",
    email: "maria.gonzalez@email.cl",
    telefono: "+56 9 1234 5678",
    curso: "Clase B",
  },
  pago: {
    precioBase: 280000,
    descuento: 50000,
    total: 230000,
    metodo: "efectivo",
    fecha: new Date().toLocaleDateString("es-CL"),
  },
};

const metodosLabels: Record<string, string> = {
  efectivo: "Efectivo",
  transferencia: "Transferencia Bancaria",
  tarjeta: "D√©bito/Cr√©dito",
  pendiente: "Pago pendiente (cobrar despu√©s)",
};
const basePath = "";
---

<DashboardLayout title="Matr√≠cula Confirmada" escuela={ESCUELA_ACTUAL}>
  <MatriculaWizardSteps pasoActual={4} basePath={basePath} />

  <Card class="max-w-4xl mx-auto">
    <!-- Success icon -->
    <div class="text-center mb-8">
      <div
        class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"
      >
        <svg
          class="w-12 h-12 text-green-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="3"
            d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-3xl font-bold text-gray-900 mb-2">
        ¬°Matr√≠cula Confirmada!
      </h2>
      <p class="text-lg text-secondary">
        Matr√≠cula N¬∞ <span class="font-mono font-semibold text-blue-600"
          >{matriculaData.numero}</span>
      </p>
    </div>

    <!-- Resumen de Matr√≠cula -->
    <div class="bg-gray-50 rounded-lg p-6 mb-6">
      <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
        <svg
          class="w-5 h-5 text-gray-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          ></path>
        </svg>
        Resumen de Matr√≠cula
      </h3>

      <div class="grid md:grid-cols-2 gap-4">
        <!-- Columna 1: Datos Alumno (se actualizan desde sessionStorage) -->
        <div class="space-y-3">
          <div>
            <p class="text-xs text-secondary uppercase tracking-wide">Alumno</p>
            <p id="resumen-alumno-nombre" class="text-sm font-semibold text-gray-900">
              {matriculaData.alumno.nombre}
            </p>
          </div>
          <div>
            <p class="text-xs text-secondary uppercase tracking-wide">RUT</p>
            <p id="resumen-alumno-rut" class="text-sm font-medium text-gray-900">
              {matriculaData.alumno.rut}
            </p>
          </div>
          <div>
            <p class="text-xs text-secondary uppercase tracking-wide">Email</p>
            <p id="resumen-alumno-email" class="text-sm font-medium text-gray-900">
              {matriculaData.alumno.email}
            </p>
          </div>
          <div>
            <p class="text-xs text-secondary uppercase tracking-wide">
              Tel√©fono
            </p>
            <p id="resumen-alumno-telefono" class="text-sm font-medium text-gray-900">
              {matriculaData.alumno.telefono}
            </p>
          </div>
        </div>

        <!-- Columna 2: Datos Matr√≠cula (se actualizan desde sessionStorage) -->
        <div class="space-y-3">
          <div>
            <p class="text-xs text-secondary uppercase tracking-wide">Curso</p>
            <p id="resumen-curso" class="text-sm font-semibold text-gray-900">
              {matriculaData.alumno.curso}
            </p>
          </div>
          <div>
            <p class="text-xs text-secondary uppercase tracking-wide">
              M√©todo de Pago
            </p>
            <p id="resumen-metodo" class="text-sm font-medium text-gray-900">
              {metodosLabels[matriculaData.pago.metodo]}
            </p>
          </div>
          <div>
            <p class="text-xs text-secondary uppercase tracking-wide">
              Fecha Matr√≠cula
            </p>
            <p id="resumen-fecha" class="text-sm font-medium text-gray-900">
              {matriculaData.pago.fecha}
            </p>
          </div>
          <div id="resumen-descuento-wrap" class={matriculaData.pago.descuento > 0 ? "" : "hidden"}>
            <p class="text-xs text-secondary uppercase tracking-wide">
              Descuento Aplicado
            </p>
            <p id="resumen-descuento" class="text-sm font-medium text-green-600">
              -${matriculaData.pago.descuento.toLocaleString("es-CL")}
            </p>
          </div>
          <div class="pt-2 border-t border-gray-200">
            <p class="text-xs text-secondary uppercase tracking-wide">
              Total Pagado
            </p>
            <p id="resumen-total" class="text-2xl font-bold text-blue-600">
              ${matriculaData.pago.total.toLocaleString("es-CL")}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Pr√≥ximos pasos -->
    <div class="border-l-4 border-blue-600 bg-blue-50 rounded-lg p-5 mb-6">
      <h4 class="font-semibold text-blue-900 mb-3 flex items-center gap-2">
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        üìß Pr√≥ximos Pasos
      </h4>
      <ul class="space-y-2 text-sm text-blue-800">
        <li class="flex items-start gap-2">
          <svg
            class="w-4 h-4 mt-0.5 flex-shrink-0 text-blue-600"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd"></path>
          </svg>
          <span
            >Se enviar√° un <strong>email con credenciales de acceso</strong> al portal
            del alumno a <strong>{matriculaData.alumno.email}</strong></span
          >
        </li>
        <li class="flex items-start gap-2">
          <svg
            class="w-4 h-4 mt-0.5 flex-shrink-0 text-blue-600"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd"></path>
          </svg>
          <span
            >El alumno podr√° <strong>agendar su primera clase</strong> desde el portal
            en las pr√≥ximas 24 horas</span
          >
        </li>
        <li class="flex items-start gap-2">
          <svg
            class="w-4 h-4 mt-0.5 flex-shrink-0 text-blue-600"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd"></path>
          </svg>
          <span
            >Recibir√° <strong>recordatorios autom√°ticos 24hrs antes</strong> de cada
            clase programada por WhatsApp y email</span
          >
        </li>
        <li class="flex items-start gap-2">
          <svg
            class="w-4 h-4 mt-0.5 flex-shrink-0 text-blue-600"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd"></path>
          </svg>
          <span
            >El <strong>certificado</strong> estar√° disponible para descarga al completar
            las 12 clases</span
          >
        </li>
      </ul>
    </div>

    <!-- Documentos pendientes (si aplica) -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
      <div class="flex gap-3">
        <svg
          class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          ></path>
        </svg>
        <div>
          <p class="text-sm font-semibold text-yellow-900 mb-1">
            üìÑ Documentos Opcionales Pendientes
          </p>
          <p class="text-xs text-yellow-800">
            Recuerda que el <strong>certificado m√©dico psicosensom√©trico</strong
            > puede presentarse en las instalaciones de la escuela antes de la primera
            clase.
          </p>
        </div>
      </div>
    </div>

    <!-- Acciones -->
    <div class="flex flex-col sm:flex-row gap-3">
      <Button
        href={`${basePath}/matricula`}
        variant="secondary"
        class="flex-1 justify-center"
      >
        <svg
          class="w-4 h-4 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          ></path>
        </svg>
        Ver Todas las Matr√≠culas
      </Button>
      <Button
        href={`${basePath}/matricula/nueva/paso-1`}
        variant="primary"
        class="flex-1 justify-center"
      >
        <svg
          class="w-4 h-4 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"></path>
        </svg>
        Nueva Matr√≠cula
      </Button>
    </div>

    <!-- Imprimir comprobante -->
    <div class="text-center mt-6 pt-6 border-t border-gray-200">
      <button
        onclick="window.print()"
        class="text-sm text-blue-600 hover:text-blue-700 font-medium inline-flex items-center gap-2"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
          ></path>
        </svg>
        Imprimir Comprobante
      </button>
    </div>
  </Card>
</DashboardLayout>

<style>
  @keyframes bounce {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-10px);
    }
  }

  .animate-bounce {
    animation: bounce 1s ease-in-out 3;
  }

  @media print {
    header,
    button,
    .btn {
      display: none !important;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    try {
      const raw = sessionStorage.getItem("matricula_data");
      if (raw) {
        const data = JSON.parse(raw);
        const a = data.alumno || {};
        const p = data.pago || {};
        const metodos: Record<string, string> = {
          efectivo: "Efectivo",
          transferencia: "Transferencia Bancaria",
          tarjeta: "D√©bito/Cr√©dito",
          pendiente: "Pago pendiente (cobrar despu√©s)",
        };
        const set = (id: string, text: string) => {
          const el = document.getElementById(id);
          if (el) el.textContent = text;
        };
        set("resumen-alumno-nombre", a.nombre || "");
        set("resumen-alumno-rut", a.rut || "");
        set("resumen-alumno-email", a.email || "");
        set("resumen-alumno-telefono", a.telefono || "");
        set("resumen-curso", a.curso || "");
        set("resumen-metodo", metodos[p.metodo] || p.metodo || "");
        set("resumen-fecha", p.fecha || new Date().toLocaleDateString("es-CL"));
        const totalPagado = p.metodo === "pendiente" ? "Pendiente ($" + (p.total ?? 0).toLocaleString("es-CL") + " a cobrar)" : `$${(p.total ?? 0).toLocaleString("es-CL")}`;
        set("resumen-total", totalPagado);
        const descWrap = document.getElementById("resumen-descuento-wrap");
        const descEl = document.getElementById("resumen-descuento");
        if (descWrap && descEl) {
          if ((p.descuento ?? 0) > 0) {
            descWrap.classList.remove("hidden");
            descEl.textContent = `-$${(p.descuento ?? 0).toLocaleString("es-CL")}`;
          } else {
            descWrap.classList.add("hidden");
          }
        }
      }
    } catch (_) {}
    sessionStorage.removeItem("matricula_data");
    sessionStorage.removeItem("matricula_paso1");
    sessionStorage.removeItem("matricula_paso2");
  });
</script>
