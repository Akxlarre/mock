---
/**
 * Mi Certificado - Portal Alumno
 * RF-082.4: Gatillo Clase B â€” 12 clases + 100% teorÃ­a â†’ habilitar certificado
 * RF-093: Gatillo Profesional â€” 30 dÃ­as + asistencia + notas + pago total
 */
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';

const alumnoData = {
  nombre: 'Juan PÃ©rez GarcÃ­a',
  rut: '18.765.432-1',
  curso: 'Clase B', // Cambiar a 'Profesional A2' para ver requisitos profesionales
  clasesCompletadas: 8,
  clasesTotales: 12,
  certificadoDisponible: false,
  // RF-082.4: Requisitos Clase B
  asistenciaTeoria: 85, // %
  // RF-093: Requisitos adicionales Profesional
  fechaMatricula: '2026-01-05',
  asistenciaPractica: 100, // %
  notaModulos: [4.5, 3.8, 5.0, 4.2], // notas por mÃ³dulo
  estadoPago: 'parcial', // 'total' | 'parcial' | 'pendiente'
  documentacionCompleta: true,
};

const esProfesional = alumnoData.curso.startsWith('Profesional');
const progreso = Math.round((alumnoData.clasesCompletadas / alumnoData.clasesTotales) * 100);
const clasesRestantes = alumnoData.clasesTotales - alumnoData.clasesCompletadas;

// RF-082.4: CÃ¡lculo requisitos Clase B
const clasesOk = alumnoData.clasesCompletadas >= alumnoData.clasesTotales;
const teoriaOk = alumnoData.asistenciaTeoria >= 100;
const pagoOk = alumnoData.estadoPago === 'total';
const docsOk = alumnoData.documentacionCompleta;

// RF-093: CÃ¡lculo requisitos adicionales Profesional
const hoy = new Date();
const fechaMat = new Date(alumnoData.fechaMatricula);
const diasDesdeMatricula = Math.floor((hoy.getTime() - fechaMat.getTime()) / (24 * 60 * 60 * 1000));
const dias30Ok = diasDesdeMatricula >= 30;
const practicaOk = alumnoData.asistenciaPractica >= 100;
const teoriaProf75Ok = alumnoData.asistenciaTeoria >= 75;
const notasOk = alumnoData.notaModulos.every(n => n >= 4.0);
const notaMin = Math.min(...alumnoData.notaModulos);

// Determinar si el certificado se puede habilitar
let puedeHabilitar = false;
if (esProfesional) {
  puedeHabilitar = clasesOk && teoriaProf75Ok && practicaOk && notasOk && pagoOk && docsOk && dias30Ok;
} else {
  puedeHabilitar = clasesOk && teoriaOk && pagoOk && docsOk;
}
if (alumnoData.certificadoDisponible) puedeHabilitar = true;
---

<DashboardLayout title="Mi Certificado" userRole="alumno">
  <div class="mb-8">
    <h1 class="text-3xl font-semibold text-gray-900 mb-2">Mi Certificado</h1>
    <p class="text-secondary">Estado y descarga de certificado de finalizaciÃ³n</p>
  </div>

  <!-- Datos Alumno -->
  <Card class="mb-6 bg-linear-to-r from-blue-50 to-blue-100 border-l-4 border-blue-500">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-sm text-blue-900 font-semibold mb-1">ğŸ‘¤ Alumno</p>
        <p class="text-lg font-bold text-blue-900">{alumnoData.nombre}</p>
        <p class="text-sm text-blue-800">RUT: {alumnoData.rut} â€¢ Curso: {alumnoData.curso}</p>
      </div>
      <span class={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${esProfesional ? 'bg-purple-100 text-purple-800' : 'bg-blue-200 text-blue-800'}`}>
        {alumnoData.curso}
      </span>
    </div>
  </Card>

  {!alumnoData.certificadoDisponible ? (
    <>
      <!-- Progreso -->
      <Card class="mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ“š Progreso del Curso</h2>
        <div class="mb-6">
          <div class="flex items-center justify-between text-sm mb-2">
            <span class="font-medium text-gray-700">Clases completadas</span>
            <span class="font-bold text-gray-900">{alumnoData.clasesCompletadas} / {alumnoData.clasesTotales}</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
            <div class="bg-linear-to-r from-blue-500 to-blue-600 h-full rounded-full transition-all duration-300 flex items-center justify-end pr-2" style={`width: ${progreso}%`}>
              <span class="text-xs font-bold text-white">{progreso}%</span>
            </div>
          </div>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
            <p class="text-sm text-blue-900 font-semibold mb-1">Completadas</p>
            <p class="text-3xl font-bold text-blue-600">{alumnoData.clasesCompletadas}</p>
            <p class="text-xs text-blue-700 mt-1">clases prÃ¡cticas</p>
          </div>
          <div class="p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500">
            <p class="text-sm text-orange-900 font-semibold mb-1">Restantes</p>
            <p class="text-3xl font-bold text-orange-600">{clasesRestantes}</p>
            <p class="text-xs text-orange-700 mt-1">para completar</p>
          </div>
        </div>
      </Card>

      <!-- RF-082.4 / RF-093: Requisitos con chequeo automÃ¡tico -->
      <Card class="mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-2">ğŸ“‹ Requisitos para Certificado</h2>
        <p class="text-xs text-secondary mb-4">
          {esProfesional ? 'RF-093: Requisitos Licencia Profesional' : 'RF-082.4: Requisitos Clase B'} â€” El botÃ³n se habilitarÃ¡ automÃ¡ticamente al cumplir todos
        </p>
        <div class="space-y-3">
          <!-- Clases -->
          <div class={`flex items-center gap-3 p-3 rounded-lg border ${clasesOk ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
            <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${clasesOk ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{clasesOk ? 'âœ“' : 'â—‹'}</span>
            <div class="flex-1">
              <p class={`text-sm font-medium ${clasesOk ? 'text-green-900' : 'text-gray-700'}`}>Completar las {alumnoData.clasesTotales} clases prÃ¡cticas</p>
              <p class="text-xs text-secondary">{alumnoData.clasesCompletadas}/{alumnoData.clasesTotales} completadas</p>
            </div>
          </div>
          <!-- TeorÃ­a -->
          {esProfesional ? (
            <>
              <div class={`flex items-center gap-3 p-3 rounded-lg border ${teoriaProf75Ok ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
                <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${teoriaProf75Ok ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{teoriaProf75Ok ? 'âœ“' : 'â—‹'}</span>
                <div class="flex-1">
                  <p class={`text-sm font-medium ${teoriaProf75Ok ? 'text-green-900' : 'text-gray-700'}`}>Asistencia teÃ³rica â‰¥ 75%</p>
                  <p class="text-xs text-secondary">Actual: {alumnoData.asistenciaTeoria}%</p>
                </div>
              </div>
              <div class={`flex items-center gap-3 p-3 rounded-lg border ${practicaOk ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
                <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${practicaOk ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{practicaOk ? 'âœ“' : 'â—‹'}</span>
                <div class="flex-1">
                  <p class={`text-sm font-medium ${practicaOk ? 'text-green-900' : 'text-gray-700'}`}>Asistencia prÃ¡ctica 100%</p>
                  <p class="text-xs text-secondary">Actual: {alumnoData.asistenciaPractica}%</p>
                </div>
              </div>
            </>
          ) : (
            <div class={`flex items-center gap-3 p-3 rounded-lg border ${teoriaOk ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
              <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${teoriaOk ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{teoriaOk ? 'âœ“' : 'â—‹'}</span>
              <div class="flex-1">
                <p class={`text-sm font-medium ${teoriaOk ? 'text-green-900' : 'text-gray-700'}`}>100% asistencia clases teÃ³ricas</p>
                <p class="text-xs text-secondary">Actual: {alumnoData.asistenciaTeoria}%</p>
              </div>
            </div>
          )}
          <!-- RF-093: Notas -->
          {esProfesional && (
            <div class={`flex items-center gap-3 p-3 rounded-lg border ${notasOk ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
              <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${notasOk ? 'bg-green-500 text-white' : 'bg-red-400 text-white'}`}>{notasOk ? 'âœ“' : 'âœ—'}</span>
              <div class="flex-1">
                <p class={`text-sm font-medium ${notasOk ? 'text-green-900' : 'text-red-800'}`}>Notas mÃ³dulos â‰¥ 4.0</p>
                <p class="text-xs text-secondary">Notas: {alumnoData.notaModulos.map((n, i) => `M${i+1}: ${n.toFixed(1)}`).join(' â€¢ ')} â€” MÃ­n: {notaMin.toFixed(1)}</p>
              </div>
            </div>
          )}
          <!-- RF-093: 30 dÃ­as -->
          {esProfesional && (
            <div class={`flex items-center gap-3 p-3 rounded-lg border ${dias30Ok ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
              <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${dias30Ok ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{dias30Ok ? 'âœ“' : 'â—‹'}</span>
              <div class="flex-1">
                <p class={`text-sm font-medium ${dias30Ok ? 'text-green-900' : 'text-gray-700'}`}>30 dÃ­as desde promociÃ³n cumplidos</p>
                <p class="text-xs text-secondary">{diasDesdeMatricula} dÃ­as transcurridos (mÃ­nimo 30)</p>
              </div>
            </div>
          )}
          <!-- Pago -->
          <div class={`flex items-center gap-3 p-3 rounded-lg border ${pagoOk ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
            <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${pagoOk ? 'bg-green-500 text-white' : 'bg-red-400 text-white'}`}>{pagoOk ? 'âœ“' : 'âœ—'}</span>
            <div class="flex-1">
              <p class={`text-sm font-medium ${pagoOk ? 'text-green-900' : 'text-red-800'}`}>{esProfesional ? 'Estado contable "Pagado Total"' : 'No tener pagos pendientes'}</p>
              <p class="text-xs text-secondary">Estado: {alumnoData.estadoPago === 'total' ? 'âœ“ Pagado' : alumnoData.estadoPago === 'parcial' ? 'âš ï¸ Pago parcial' : 'âŒ Pendiente'}</p>
            </div>
          </div>
          <!-- DocumentaciÃ³n -->
          <div class={`flex items-center gap-3 p-3 rounded-lg border ${docsOk ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
            <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${docsOk ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{docsOk ? 'âœ“' : 'â—‹'}</span>
            <div class="flex-1">
              <p class={`text-sm font-medium ${docsOk ? 'text-green-900' : 'text-gray-700'}`}>DocumentaciÃ³n completa</p>
              <p class="text-xs text-secondary">{docsOk ? 'Expediente completo' : 'Faltan documentos en expediente'}</p>
            </div>
          </div>
        </div>
        {puedeHabilitar ? (
          <div class="mt-6 p-4 bg-green-50 rounded-lg border-2 border-green-300">
            <p class="text-sm font-bold text-green-900">ğŸ‰ Â¡Todos los requisitos cumplidos! El certificado estÃ¡ listo para generar.</p>
          </div>
        ) : (
          <div class="mt-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
            <p class="text-sm font-medium text-yellow-900">â³ AÃºn no se cumplen todos los requisitos. Complete los pendientes para habilitar la emisiÃ³n.</p>
          </div>
        )}
      </Card>

      <!-- BotÃ³n Generar -->
      <Card>
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-semibold text-gray-900">ğŸ“œ Generar Certificado</h2>
            <p class="text-xs text-secondary mt-1">Se generarÃ¡ automÃ¡ticamente al cumplir requisitos</p>
          </div>
          <Button variant="primary" class={!puedeHabilitar ? 'opacity-50 cursor-not-allowed' : ''} disabled={!puedeHabilitar} onClick="generarCertificado()">
            {puedeHabilitar ? 'âœ… Generar Certificado' : 'ğŸ”’ Requisitos pendientes'}
          </Button>
        </div>
      </Card>
    </>
  ) : (
    <>
      <!-- Certificado Disponible -->
      <Card class="mb-6 bg-linear-to-r from-green-50 to-green-100 border-l-4 border-green-500">
        <div class="flex items-start gap-4">
          <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center shrink-0">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          </div>
          <div class="flex-1">
            <p class="text-lg font-bold text-green-900 mb-1">ğŸ‰ Â¡Felicitaciones!</p>
            <p class="text-sm text-green-800 mb-4">Has completado exitosamente el curso de <strong>{alumnoData.curso}</strong>. Tu certificado estÃ¡ listo.</p>
            <div class="flex gap-3">
              <Button variant="primary" onClick="descargarCertificado()">ğŸ“„ Descargar PDF</Button>
              <Button variant="secondary" onClick="verQR()">ğŸ“± Ver QR</Button>
            </div>
          </div>
        </div>
      </Card>
      <Card>
        <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ“„ Detalles del Certificado</h2>
        <dl class="grid sm:grid-cols-2 gap-4">
          <div><dt class="text-sm text-secondary mb-1">NÃºmero</dt><dd class="text-base font-mono font-bold text-gray-900">CERT-2026-0123</dd></div>
          <div><dt class="text-sm text-secondary mb-1">Fecha EmisiÃ³n</dt><dd class="text-base font-semibold text-gray-900">03 de Febrero 2026</dd></div>
          <div><dt class="text-sm text-secondary mb-1">Curso</dt><dd class="text-base font-semibold text-gray-900">{alumnoData.curso}</dd></div>
          <div><dt class="text-sm text-secondary mb-1">Total Clases</dt><dd class="text-base font-semibold text-gray-900">{alumnoData.clasesTotales} prÃ¡cticas</dd></div>
        </dl>
      </Card>
    </>
  )}
</DashboardLayout>

<script>
  (window as any).generarCertificado = function() {
    alert('ğŸ“œ Generando Certificado...\n\nâœ“ Todos los requisitos verificados\nâœ“ Certificado generado\n\nArchivo: certificado_CERT-2026-0248.pdf\nSe ha enviado copia por email.');
  };
  (window as any).descargarCertificado = function() {
    alert('ğŸ“„ Descargando certificado_CERT-2026-0123.pdf...\n\nContenido: datos alumno, curso, fechas, QR, firma digital.');
  };
  (window as any).verQR = function() {
    alert('ğŸ“± QR de ValidaciÃ³n\n\nURL: https://escuela.cl/validar/CERT-2026-0123\n\nAl escanear: nombre, curso, fecha, escuela, âœ“ vÃ¡lido');
  };
</script>
