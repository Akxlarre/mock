---
/**
 * Mi Certificado - Portal Alumno
 * RF-082.4: Gatillo Clase B ‚Äî 12 clases + 100% teor√≠a ‚Üí habilitar certificado
 * RF-093: Gatillo Profesional ‚Äî 30 d√≠as + asistencia + notas + pago total
 */
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';

const alumnoData = {
  nombre: 'Juan P√©rez Garc√≠a',
  rut: '18.765.432-1',
  curso: 'Clase B', // Cambiar a 'Profesional A2' para ver requisitos profesionales
  clasesCompletadas: 8,
  clasesTotales: 12,
  certificadoDisponible: false,
  // RF-082.4: Requisitos Clase B
  asistenciaTeoria: 85, // %
  // RF-093: Requisitos adicionales Profesional
  fechaMatricula: '2026-01-05',
  asistenciaPractica: 100, // %
  notaModulos: [4.5, 3.8, 5.0, 4.2], // notas por m√≥dulo
  estadoPago: 'parcial', // 'total' | 'parcial' | 'pendiente'
  documentacionCompleta: true,
};

const esProfesional = alumnoData.curso.startsWith('Profesional');
const progreso = Math.round((alumnoData.clasesCompletadas / alumnoData.clasesTotales) * 100);
const clasesRestantes = alumnoData.clasesTotales - alumnoData.clasesCompletadas;

// RF-082.4: C√°lculo requisitos Clase B
const clasesOk = alumnoData.clasesCompletadas >= alumnoData.clasesTotales;
const teoriaOk = alumnoData.asistenciaTeoria >= 100;
const pagoOk = alumnoData.estadoPago === 'total';
const docsOk = alumnoData.documentacionCompleta;

// RF-093: C√°lculo requisitos adicionales Profesional
const hoy = new Date();
const fechaMat = new Date(alumnoData.fechaMatricula);
const diasDesdeMatricula = Math.floor((hoy.getTime() - fechaMat.getTime()) / (24 * 60 * 60 * 1000));
const dias30Ok = diasDesdeMatricula >= 30;
const practicaOk = alumnoData.asistenciaPractica >= 100;
const teoriaProf75Ok = alumnoData.asistenciaTeoria >= 75;
const notasOk = alumnoData.notaModulos.every(n => n >= 4.0);
const notaMin = Math.min(...alumnoData.notaModulos);

// Determinar si el certificado se puede habilitar
let puedeHabilitar = false;
if (esProfesional) {
  puedeHabilitar = clasesOk && teoriaProf75Ok && practicaOk && notasOk && pagoOk && docsOk && dias30Ok;
} else {
  puedeHabilitar = clasesOk && teoriaOk && pagoOk && docsOk;
}
if (alumnoData.certificadoDisponible) puedeHabilitar = true;
---

<DashboardLayout title="Mi Certificado" userRole="alumno">
  <div class="mb-8">
    <h1 class="text-3xl font-semibold text-gray-900 mb-2">Mi Certificado</h1>
    <p class="text-secondary">Estado y descarga de certificado de finalizaci√≥n</p>
  </div>

  <!-- Datos Alumno -->
  <Card class="mb-6 bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-500">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-sm text-blue-900 font-semibold mb-1">üë§ Alumno</p>
        <p class="text-lg font-bold text-blue-900">{alumnoData.nombre}</p>
        <p class="text-sm text-blue-800">RUT: {alumnoData.rut} ‚Ä¢ Curso: {alumnoData.curso}</p>
      </div>
      <span class={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${esProfesional ? 'bg-purple-100 text-purple-800' : 'bg-blue-200 text-blue-800'}`}>
        {alumnoData.curso}
      </span>
    </div>
  </Card>

  {!alumnoData.certificadoDisponible ? (
    <>
      <!-- Progreso -->
      <Card class="mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">üìö Progreso del Curso</h2>
        <div class="mb-6">
          <div class="flex items-center justify-between text-sm mb-2">
            <span class="font-medium text-gray-700">Clases completadas</span>
            <span class="font-bold text-gray-900">{alumnoData.clasesCompletadas} / {alumnoData.clasesTotales}</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-full rounded-full transition-all duration-300 flex items-center justify-end pr-2" style={`width: ${progreso}%`}>
              <span class="text-xs font-bold text-white">{progreso}%</span>
            </div>
          </div>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
            <p class="text-sm text-blue-900 font-semibold mb-1">Completadas</p>
            <p class="text-3xl font-bold text-blue-600">{alumnoData.clasesCompletadas}</p>
            <p class="text-xs text-blue-700 mt-1">clases pr√°cticas</p>
          </div>
          <div class="p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500">
            <p class="text-sm text-orange-900 font-semibold mb-1">Restantes</p>
            <p class="text-3xl font-bold text-orange-600">{clasesRestantes}</p>
            <p class="text-xs text-orange-700 mt-1">para completar</p>
          </div>
        </div>
      </Card>

      <!-- RF-082.4 / RF-093: Requisitos con chequeo autom√°tico -->
      <Card class="mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-2">üìã Requisitos para Certificado</h2>
        <p class="text-xs text-secondary mb-4">
          {esProfesional ? 'RF-093: Requisitos Licencia Profesional' : 'RF-082.4: Requisitos Clase B'} ‚Äî El bot√≥n se habilitar√° autom√°ticamente al cumplir todos
        </p>
        <div class="space-y-3">
          <!-- Clases -->
          <div class={`flex items-center gap-3 p-3 rounded-lg border ${clasesOk ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
            <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${clasesOk ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{clasesOk ? '‚úì' : '‚óã'}</span>
            <div class="flex-1">
              <p class={`text-sm font-medium ${clasesOk ? 'text-green-900' : 'text-gray-700'}`}>Completar las {alumnoData.clasesTotales} clases pr√°cticas</p>
              <p class="text-xs text-secondary">{alumnoData.clasesCompletadas}/{alumnoData.clasesTotales} completadas</p>
            </div>
          </div>
          <!-- Teor√≠a -->
          {esProfesional ? (
            <>
              <div class={`flex items-center gap-3 p-3 rounded-lg border ${teoriaProf75Ok ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
                <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${teoriaProf75Ok ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{teoriaProf75Ok ? '‚úì' : '‚óã'}</span>
                <div class="flex-1">
                  <p class={`text-sm font-medium ${teoriaProf75Ok ? 'text-green-900' : 'text-gray-700'}`}>Asistencia te√≥rica ‚â• 75%</p>
                  <p class="text-xs text-secondary">Actual: {alumnoData.asistenciaTeoria}%</p>
                </div>
              </div>
              <div class={`flex items-center gap-3 p-3 rounded-lg border ${practicaOk ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
                <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${practicaOk ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{practicaOk ? '‚úì' : '‚óã'}</span>
                <div class="flex-1">
                  <p class={`text-sm font-medium ${practicaOk ? 'text-green-900' : 'text-gray-700'}`}>Asistencia pr√°ctica 100%</p>
                  <p class="text-xs text-secondary">Actual: {alumnoData.asistenciaPractica}%</p>
                </div>
              </div>
            </>
          ) : (
            <div class={`flex items-center gap-3 p-3 rounded-lg border ${teoriaOk ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
              <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${teoriaOk ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{teoriaOk ? '‚úì' : '‚óã'}</span>
              <div class="flex-1">
                <p class={`text-sm font-medium ${teoriaOk ? 'text-green-900' : 'text-gray-700'}`}>100% asistencia clases te√≥ricas</p>
                <p class="text-xs text-secondary">Actual: {alumnoData.asistenciaTeoria}%</p>
              </div>
            </div>
          )}
          <!-- RF-093: Notas -->
          {esProfesional && (
            <div class={`flex items-center gap-3 p-3 rounded-lg border ${notasOk ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
              <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${notasOk ? 'bg-green-500 text-white' : 'bg-red-400 text-white'}`}>{notasOk ? '‚úì' : '‚úó'}</span>
              <div class="flex-1">
                <p class={`text-sm font-medium ${notasOk ? 'text-green-900' : 'text-red-800'}`}>Notas m√≥dulos ‚â• 4.0</p>
                <p class="text-xs text-secondary">Notas: {alumnoData.notaModulos.map((n, i) => `M${i+1}: ${n.toFixed(1)}`).join(' ‚Ä¢ ')} ‚Äî M√≠n: {notaMin.toFixed(1)}</p>
              </div>
            </div>
          )}
          <!-- RF-093: 30 d√≠as -->
          {esProfesional && (
            <div class={`flex items-center gap-3 p-3 rounded-lg border ${dias30Ok ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
              <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${dias30Ok ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{dias30Ok ? '‚úì' : '‚óã'}</span>
              <div class="flex-1">
                <p class={`text-sm font-medium ${dias30Ok ? 'text-green-900' : 'text-gray-700'}`}>30 d√≠as desde promoci√≥n cumplidos</p>
                <p class="text-xs text-secondary">{diasDesdeMatricula} d√≠as transcurridos (m√≠nimo 30)</p>
              </div>
            </div>
          )}
          <!-- Pago -->
          <div class={`flex items-center gap-3 p-3 rounded-lg border ${pagoOk ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
            <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${pagoOk ? 'bg-green-500 text-white' : 'bg-red-400 text-white'}`}>{pagoOk ? '‚úì' : '‚úó'}</span>
            <div class="flex-1">
              <p class={`text-sm font-medium ${pagoOk ? 'text-green-900' : 'text-red-800'}`}>{esProfesional ? 'Estado contable "Pagado Total"' : 'No tener pagos pendientes'}</p>
              <p class="text-xs text-secondary">Estado: {alumnoData.estadoPago === 'total' ? '‚úì Pagado' : alumnoData.estadoPago === 'parcial' ? '‚ö†Ô∏è Pago parcial' : '‚ùå Pendiente'}</p>
            </div>
          </div>
          <!-- Documentaci√≥n -->
          <div class={`flex items-center gap-3 p-3 rounded-lg border ${docsOk ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
            <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${docsOk ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'}`}>{docsOk ? '‚úì' : '‚óã'}</span>
            <div class="flex-1">
              <p class={`text-sm font-medium ${docsOk ? 'text-green-900' : 'text-gray-700'}`}>Documentaci√≥n completa</p>
              <p class="text-xs text-secondary">{docsOk ? 'Expediente completo' : 'Faltan documentos en expediente'}</p>
            </div>
          </div>
        </div>
        {puedeHabilitar ? (
          <div class="mt-6 p-4 bg-green-50 rounded-lg border-2 border-green-300">
            <p class="text-sm font-bold text-green-900">üéâ ¬°Todos los requisitos cumplidos! El certificado est√° listo para generar.</p>
          </div>
        ) : (
          <div class="mt-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
            <p class="text-sm font-medium text-yellow-900">‚è≥ A√∫n no se cumplen todos los requisitos. Complete los pendientes para habilitar la emisi√≥n.</p>
          </div>
        )}
      </Card>

      <!-- Bot√≥n Generar -->
      <Card>
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-semibold text-gray-900">üìú Generar Certificado</h2>
            <p class="text-xs text-secondary mt-1">Se generar√° autom√°ticamente al cumplir requisitos</p>
          </div>
          <Button variant="primary" class={!puedeHabilitar ? 'opacity-50 cursor-not-allowed' : ''} disabled={!puedeHabilitar} onClick="generarCertificado()">
            {puedeHabilitar ? '‚úÖ Generar Certificado' : 'üîí Requisitos pendientes'}
          </Button>
        </div>
      </Card>
    </>
  ) : (
    <>
      <!-- Certificado Disponible -->
      <Card class="mb-6 bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-500">
        <div class="flex items-start gap-4">
          <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          </div>
          <div class="flex-1">
            <p class="text-lg font-bold text-green-900 mb-1">üéâ ¬°Felicitaciones!</p>
            <p class="text-sm text-green-800 mb-4">Has completado exitosamente el curso de <strong>{alumnoData.curso}</strong>. Tu certificado est√° listo.</p>
            <div class="flex gap-3">
              <Button variant="primary" onClick="descargarCertificado()">üìÑ Descargar PDF</Button>
              <Button variant="secondary" onClick="verQR()">üì± Ver QR</Button>
            </div>
          </div>
        </div>
      </Card>
      <Card>
        <h2 class="text-xl font-semibold text-gray-900 mb-4">üìÑ Detalles del Certificado</h2>
        <dl class="grid sm:grid-cols-2 gap-4">
          <div><dt class="text-sm text-secondary mb-1">N√∫mero</dt><dd class="text-base font-mono font-bold text-gray-900">CERT-2026-0123</dd></div>
          <div><dt class="text-sm text-secondary mb-1">Fecha Emisi√≥n</dt><dd class="text-base font-semibold text-gray-900">03 de Febrero 2026</dd></div>
          <div><dt class="text-sm text-secondary mb-1">Curso</dt><dd class="text-base font-semibold text-gray-900">{alumnoData.curso}</dd></div>
          <div><dt class="text-sm text-secondary mb-1">Total Clases</dt><dd class="text-base font-semibold text-gray-900">{alumnoData.clasesTotales} pr√°cticas</dd></div>
        </dl>
      </Card>
    </>
  )}
</DashboardLayout>

<script>
  window.generarCertificado = function() {
    alert('üìú Generando Certificado...\n\n‚úì Todos los requisitos verificados\n‚úì Certificado generado\n\nArchivo: certificado_CERT-2026-0248.pdf\nSe ha enviado copia por email.');
  };
  window.descargarCertificado = function() {
    alert('üìÑ Descargando certificado_CERT-2026-0123.pdf...\n\nContenido: datos alumno, curso, fechas, QR, firma digital.');
  };
  window.verQR = function() {
    alert('üì± QR de Validaci√≥n\n\nURL: https://escuela.cl/validar/CERT-2026-0123\n\nAl escanear: nombre, curso, fecha, escuela, ‚úì v√°lido');
  };
</script>
