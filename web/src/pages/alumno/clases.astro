---
/**
 * Mis Clases - Portal Alumno (CONSOLIDADO)
 * RF-055: Dashboard de progreso con % clases prácticas y teóricas
 * RF-014: Sistema de agendamiento clase por clase
 */
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import Card from "../../components/ui/Card.astro";
import ScheduleDisplay from "../../components/schedules/ScheduleDisplay.astro";
import {
    getBookingsByStudent,
    getCompletedClassCount,
    getNextClassNumber,
} from "../../lib/mockBookings";

// Mock: Alumno actual (ID = 1 María González)
const alumno = {
  nombre: "María González",
  curso: "Clase B",
  escuela: "Conductores Chillán",
};

const currentStudentId = 1;
const studentBookings = getBookingsByStudent(currentStudentId);
const completedClasses = getCompletedClassCount(currentStudentId);
const nextClassNumber = getNextClassNumber(currentStudentId);
const totalClasses = 12;

// RF-055: Progreso de clases prácticas y teóricas
const progresoPracticas = {
  clasesCompletadas: 8,
  clasesTotal: 12,
  porcentaje: 67,
};

const progresoTeoricas = {
  clasesCompletadas: 6,
  clasesTotal: 8,
  porcentaje: 75,
};

// Convertir bookings a formato del componente
const classBookings = studentBookings.map((booking) => {
    const bookingDate = new Date(booking.bookingDate);
    const now = new Date();
    const hoursUntil =
        (bookingDate.getTime() - now.getTime()) / (1000 * 60 * 60);
    const canModify = hoursUntil > 24 && booking.status === "scheduled";

    return {
        id: booking.id,
        classNumber: booking.classNumber,
        date: booking.bookingDate,
        time: booking.startTime,
        instructor: booking.instructorName,
        vehicle: booking.vehiclePatente,
        status: booking.status,
        canCancel: canModify,
        canReschedule: canModify,
    };
});
---

<DashboardLayout title="Mis Clases - Escuela de Conductores" userRole="alumno">
  <div class="max-w-7xl mx-auto">
    <!-- Breadcrumb -->
    <div class="mb-6 flex items-center gap-2 text-sm text-secondary">
      <a href="/alumno/dashboard" class="hover:text-gray-900">Inicio</a>
      <span>/</span>
      <span class="text-gray-900 font-medium">Mis Clases</span>
    </div>

    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-3xl font-semibold text-gray-900 tracking-tight mb-1">Mis Clases</h1>
      <p class="text-secondary">{alumno.curso} - {alumno.escuela}</p>
    </div>

    <!-- RF-055: Progreso de Clases Prácticas y Teóricas -->
    <div class="grid sm:grid-cols-2 gap-6 mb-6">
      <!-- Progreso Clases Prácticas -->
      <Card>
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-xl font-semibold text-gray-900">Clases Prácticas</h2>
            <p class="text-xs text-secondary mt-0.5">De 12 clases requeridas</p>
          </div>
          <div class="text-right">
            <p class="text-5xl font-bold text-blue-600">{progresoPracticas.porcentaje}%</p>
          </div>
        </div>

        <!-- Progress bar -->
        <div class="relative w-full bg-gray-200 rounded-full h-6 mb-3">
          <div
            class="absolute inset-y-0 left-0 bg-linear-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-end px-3 transition-all duration-500"
            style={`width: ${progresoPracticas.porcentaje}%`}
          >
            <span class="text-xs font-semibold text-white">
              {progresoPracticas.clasesCompletadas}/{progresoPracticas.clasesTotal}
            </span>
          </div>
        </div>

        <div class="flex items-center justify-between text-sm">
          <span class="text-secondary">
            {progresoPracticas.clasesCompletadas} completadas
          </span>
          <span class="font-semibold text-gray-900">
            {progresoPracticas.clasesTotal - progresoPracticas.clasesCompletadas} restantes
          </span>
        </div>
      </Card>

      <!-- Progreso Clases Teóricas -->
      <Card>
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-xl font-semibold text-gray-900">Clases Teóricas</h2>
            <p class="text-xs text-secondary mt-0.5">De 8 clases requeridas</p>
          </div>
          <div class="text-right">
            <p class="text-5xl font-bold text-green-600">{progresoTeoricas.porcentaje}%</p>
          </div>
        </div>

        <!-- Progress bar -->
        <div class="relative w-full bg-gray-200 rounded-full h-6 mb-3">
          <div
            class="absolute inset-y-0 left-0 bg-linear-to-r from-green-500 to-green-600 rounded-full flex items-center justify-end px-3 transition-all duration-500"
            style={`width: ${progresoTeoricas.porcentaje}%`}
          >
            <span class="text-xs font-semibold text-white">
              {progresoTeoricas.clasesCompletadas}/{progresoTeoricas.clasesTotal}
            </span>
          </div>
        </div>

        <div class="flex items-center justify-between text-sm">
          <span class="text-secondary">
            {progresoTeoricas.clasesCompletadas} asistidas
          </span>
          <span class="font-semibold text-gray-900">
            {progresoTeoricas.clasesTotal - progresoTeoricas.clasesCompletadas} restantes
          </span>
        </div>
      </Card>
    </div>

    <!-- Componente de Agendamiento de Clases -->
    <ScheduleDisplay
      bookings={classBookings}
      completedClasses={completedClasses}
      totalClasses={totalClasses}
      nextClassNumber={nextClassNumber}
      showProgressCard={false}
    />
  </div>
</DashboardLayout>
