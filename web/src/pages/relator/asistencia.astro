---
/**
 * Registro de Asistencia - RF-067, RF-068, RF-078
 * Vista Relator: Tomar asistencia diaria/semanal de una promoción
 * - RF-067: Asistencia semanal presencial teoría online (firma física)
 * - RF-068: Asistencia diaria bloques prácticos
 * - RF-078: Marcado manual asistencia teoría Zoom
 * - RF-071: Adjuntar licencias médicas como evidencia
 */
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import Card from "../../components/ui/Card.astro";
import Button from "../../components/ui/Button.astro";
import { PROMOCIONES, RELATORES } from "../../lib/mockRelatores";

// Demo: relator Francisco Herrera (id=3)
const relatorId = 3;
const relator = RELATORES.find((r) => r.id === relatorId)!;

// Mock alumnos por curso (promo-curso como key)
const ALUMNOS_MOCK: Record<string, { id: number; nombre: string; rut: string; asistencias: Record<string, boolean>; licMedica?: boolean }[]> = {
  "4-A2": [
    { id: 1, nombre: "Carlos Soto Muñoz",    rut: "15.432.198-7", asistencias: { d1:true,d2:true,d3:false,d4:true,d5:true,d6:true,d7:false,d8:true,d9:true,d10:true,d11:true } },
    { id: 2, nombre: "Andrea Flores Vera",    rut: "16.789.234-5", asistencias: { d1:true,d2:false,d3:false,d4:true,d5:false,d6:true,d7:true,d8:true,d9:false,d10:true,d11:false }, licMedica: true },
    { id: 3, nombre: "Luis Pérez Castro",     rut: "14.567.890-3", asistencias: { d1:true,d2:true,d3:true,d4:true,d5:true,d6:true,d7:true,d8:true,d9:true,d10:true,d11:true } },
    { id: 4, nombre: "Mariana Torres Rojas",  rut: "17.234.567-K", asistencias: { d1:true,d2:true,d3:false,d4:false,d5:false,d6:false,d7:false,d8:true,d9:false,d10:false,d11:false } },
    { id: 5, nombre: "Roberto Núñez Díaz",    rut: "13.456.789-1", asistencias: { d1:true,d2:true,d3:true,d4:true,d5:true,d6:false,d7:true,d8:true,d9:true,d10:true,d11:true } },
    { id: 6, nombre: "Patricia Vargas Silva", rut: "15.678.901-2", asistencias: { d1:false,d2:true,d3:true,d4:true,d5:true,d6:true,d7:true,d8:true,d9:true,d10:true,d11:true } },
    { id: 7, nombre: "Jorge Morales Reyes",   rut: "16.901.234-6", asistencias: { d1:true,d2:true,d3:true,d4:true,d5:false,d6:true,d7:true,d8:false,d9:true,d10:true,d11:true } },
    { id: 8, nombre: "Valentina Ríos Lagos",  rut: "15.234.567-4", asistencias: { d1:true,d2:true,d3:true,d4:true,d5:true,d6:true,d7:true,d8:true,d9:true,d10:true,d11:true } },
  ],
  "4-A3": [
    { id: 9,  nombre: "Felipe Aguilar Pino",   rut: "17.345.678-9", asistencias: { d1:true,d2:true,d3:true,d4:true,d5:true,d6:true,d7:true,d8:true,d9:true,d10:true,d11:true } },
    { id: 10, nombre: "Diego Meza Fuentes",     rut: "16.456.789-0", asistencias: { d1:true,d2:false,d3:true,d4:true,d5:true,d6:true,d7:false,d8:true,d9:true,d10:true,d11:true } },
    { id: 11, nombre: "Camila Rojas Vega",      rut: "18.123.456-7", asistencias: { d1:false,d2:false,d3:false,d4:true,d5:false,d6:false,d7:false,d8:false,d9:false,d10:false,d11:false }, licMedica: true },
    { id: 12, nombre: "Sebastián Mora Castro",  rut: "17.654.321-2", asistencias: { d1:true,d2:true,d3:true,d4:true,d5:true,d6:true,d7:true,d8:true,d9:false,d10:true,d11:true } },
    { id: 13, nombre: "Claudia Herrera Díaz",   rut: "16.234.567-8", asistencias: { d1:true,d2:true,d3:false,d4:true,d5:true,d6:true,d7:true,d8:true,d9:true,d10:true,d11:false } },
    { id: 14, nombre: "Gonzalo Pinto Muñoz",    rut: "15.321.654-3", asistencias: { d1:true,d2:true,d3:true,d4:false,d5:true,d6:true,d7:true,d8:true,d9:true,d10:true,d11:true } },
  ],
  "3-A2": [
    { id: 15, nombre: "María Fernández López",  rut: "14.876.543-1", asistencias: { d1:true,d2:true,d3:true,d4:true,d5:true,d6:true,d7:true,d8:true,d9:true,d10:true,d11:true,d12:true,d13:true,d14:true,d15:true,d16:true,d17:true,d18:true,d19:true,d20:true,d21:true,d22:true,d23:true } },
    { id: 16, nombre: "Nicolás Castillo Vera",  rut: "15.987.654-2", asistencias: { d1:true,d2:true,d3:false,d4:true,d5:true,d6:true,d7:true,d8:false,d9:true,d10:true,d11:true,d12:true,d13:false,d14:true,d15:true,d16:true,d17:true,d18:true,d19:false,d20:true,d21:true,d22:true,d23:true } },
    { id: 17, nombre: "Javiera Soto Romero",    rut: "17.111.222-3", asistencias: { d1:true,d2:true,d3:true,d4:true,d5:true,d6:true,d7:true,d8:true,d9:true,d10:true,d11:true,d12:true,d13:true,d14:true,d15:true,d16:true,d17:true,d18:true,d19:true,d20:true,d21:true,d22:true,d23:true } },
  ],
};

// Promociones en curso de este relator
const promosEnCurso = PROMOCIONES.filter(
  (p) => p.estado === "en_curso" && p.cursos.some((c) => c.relatorId === relatorId)
);

const hoy = new Date();
const fechaHoy = hoy.toISOString().split("T")[0];
const diasSemana = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];
const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
const fechaFormateada = `${diasSemana[hoy.getDay()]} ${hoy.getDate()} de ${meses[hoy.getMonth()]} ${hoy.getFullYear()}`;
---

<DashboardLayout title="Registro de Asistencia" userRole="relator">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
      <a href="/relator/dashboard" class="hover:text-gray-900">Inicio</a>
      <span>/</span>
      <span class="text-gray-900 font-medium">Registro de Asistencia</span>
    </div>
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl font-semibold text-gray-900 tracking-tight text-balance">
          Registro de Asistencia
        </h1>
        <p class="text-gray-600 mt-1">
          {fechaFormateada} · {relator.nombre}
        </p>
      </div>
    </div>
  </div>

  <!-- Tabs: Selector Promo + Curso + Tipo -->
  <div class="mb-6 border border-gray-200 rounded-lg bg-white p-4 shadow-sm">
    <div class="grid sm:grid-cols-3 gap-4">
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1.5">Promoción</label>
        <select id="sel-promo" class="h-10 px-3 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900">
          <option value="">Seleccionar...</option>
          {promosEnCurso.map((p) => (
            <option value={String(p.id)} data-dia={p.diaActual}>
              {p.nombre} (Día {p.diaActual}/30)
            </option>
          ))}
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1.5">Curso</label>
        <select id="sel-curso" class="h-10 px-3 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900" disabled>
          <option value="">Primero seleccione promoción</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1.5">Tipo de sesión</label>
        <select id="sel-tipo" class="h-10 px-3 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900">
          <!-- RF-067: Teoría online semanal presencial (firma física) -->
          <option value="teoria_zoom">Teoría Zoom (marcado manual RF-078)</option>
          <!-- RF-068: Bloque práctico diario -->
          <option value="practica">Práctica presencial (diaria RF-068)</option>
          <!-- RF-067: Firma semanal presencial -->
          <option value="firma_semanal">Firma semanal presencial (RF-067)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Panel principal asistencia -->
  <div id="panel-vacio" class="border border-gray-200 rounded-lg bg-white p-12 text-center shadow-sm">
    <svg class="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
    </svg>
    <p class="text-gray-500 font-medium">Seleccione una promoción y curso para registrar asistencia</p>
  </div>

  <!-- Panel lista alumnos (oculto hasta selección) -->
  <div id="panel-asistencia" class="hidden space-y-4">

    <!-- Info sesión -->
    <div id="info-sesion" class="border border-gray-200 rounded-lg bg-white p-4 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div id="tipo-badge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            Teoría Zoom
          </div>
          <div>
            <p id="info-promo-nombre" class="text-sm font-semibold text-gray-900">—</p>
            <p id="info-dia-actual" class="text-xs text-gray-500">—</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-sm text-gray-600">
            Fecha: <span class="font-medium text-gray-900">{fechaFormateada}</span>
          </div>
          <!-- RF-067: Indicador Zoom activo para teoría -->
          <div id="zoom-indicator" class="hidden items-center gap-1.5 px-3 py-1.5 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-700 font-medium">
            <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse inline-block"></span>
            Zoom en curso
          </div>
        </div>
      </div>
    </div>

    <!-- Alertas tipo de sesión -->
    <!-- RF-078: Alerta teoría Zoom -->
    <div id="alerta-zoom" class="hidden border border-blue-200 bg-blue-50 rounded-lg p-4">
      <div class="flex gap-3">
        <svg class="w-5 h-5 text-blue-600 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.069A1 1 0 0121 8.869v6.262a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>
        <div>
          <p class="text-sm font-medium text-blue-900">Asistencia Teoría Zoom — Marcado Manual (RF-078)</p>
          <p class="text-xs text-blue-700 mt-1">Marque los alumnos que están presentes en la sesión Zoom actual. La asistencia queda registrada en el sistema.</p>
        </div>
      </div>
    </div>

    <!-- RF-067: Alerta firma semanal presencial -->
    <div id="alerta-firma" class="hidden border border-orange-200 bg-orange-50 rounded-lg p-4">
      <div class="flex gap-3">
        <svg class="w-5 h-5 text-orange-600 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
        </svg>
        <div>
          <p class="text-sm font-medium text-orange-900">Firma Semanal Presencial (RF-067)</p>
          <p class="text-xs text-orange-700 mt-1">El alumno debe firmar físicamente el libro de asistencia. Marque aquí los que firmaron en el libro de clases.</p>
        </div>
      </div>
    </div>

    <!-- RF-068: Alerta práctica presencial -->
    <div id="alerta-practica" class="hidden border border-green-200 bg-green-50 rounded-lg p-4">
      <div class="flex gap-3">
        <svg class="w-5 h-5 text-green-600 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
        </svg>
        <div>
          <p class="text-sm font-medium text-green-900">Asistencia Práctica Presencial — Diaria (RF-068)</p>
          <p class="text-xs text-green-700 mt-1">Asistencia 100% obligatoria para prácticos. Inasistencias solo justificadas con licencia médica (RF-071).</p>
        </div>
      </div>
    </div>

    <!-- Acciones rápidas -->
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex gap-2">
        <button onclick="marcarTodos(true)" class="inline-flex items-center gap-1.5 px-3 py-2 text-xs font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50 shadow-sm transition-colors">
          <svg class="w-3.5 h-3.5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
          </svg>
          Marcar todos presentes
        </button>
      </div>
      <div id="contador-asistencia" class="text-sm font-medium text-gray-700">
        0/0 presentes
      </div>
    </div>

    <!-- Tabla de alumnos -->
    <div class="border border-gray-200 rounded-lg bg-white shadow-sm overflow-hidden">
      <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
        <div class="grid grid-cols-12 gap-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">
          <div class="col-span-1 text-center">Asiste</div>
          <div class="col-span-4">Alumno</div>
          <div class="col-span-2">RUT</div>
          <div class="col-span-2 text-center">Asistencia acum.</div>
          <div class="col-span-2 text-center">Estado</div>
          <div class="col-span-1 text-center">Evidencia</div>
        </div>
      </div>
      <div id="lista-alumnos" class="divide-y divide-gray-100">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Historial días anteriores (mini tabla) -->
    <Card>
      <h3 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        Historial últimos días (teoría)
      </h3>
      <div id="historial-dias" class="overflow-x-auto">
        <!-- Populated by JS -->
      </div>
    </Card>

    <!-- Botones guardar -->
    <div class="flex flex-wrap items-center justify-between gap-4 pt-2">
      <p class="text-xs text-gray-500">
        Los registros quedan almacenados en el sistema y no pueden modificarse luego de 24 horas.
      </p>
      <div class="flex gap-3">
        <Button variant="secondary" href="/relator/dashboard">Cancelar</Button>
        <button
          id="btn-guardar"
          onclick="guardarAsistencia()"
          class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-gray-900 border border-gray-900 rounded-md hover:bg-gray-800 shadow-sm transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Guardar asistencia
        </button>
      </div>
    </div>
  </div>

  <!-- Modal licencia médica (RF-071) -->
  <div id="modal-lic-medica" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-1">Adjuntar Licencia Médica</h3>
      <p class="text-sm text-gray-600 mb-4">RF-071: Evidencia de inasistencia justificada</p>
      <p id="modal-alumno-nombre" class="text-sm font-medium text-gray-800 mb-4 p-3 bg-gray-50 rounded-lg"></p>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1.5">Documento (PDF, JPG)</label>
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors cursor-pointer" onclick="document.getElementById('lic-file').click()">
            <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p class="text-sm text-gray-500" id="lic-file-label">Click para seleccionar archivo</p>
            <p class="text-xs text-gray-400 mt-1">PDF, JPG o PNG · Máx. 5MB</p>
          </div>
          <input id="lic-file" type="file" accept=".pdf,.jpg,.jpeg,.png" class="hidden" onchange="onLicFileChange(event)"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1.5">Período cubierto</label>
          <div class="grid grid-cols-2 gap-2">
            <input type="date" id="lic-desde" class="h-10 px-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="Desde"/>
            <input type="date" id="lic-hasta" class="h-10 px-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="Hasta"/>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1.5">Observaciones</label>
          <textarea rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 resize-none" placeholder="Ej: Reposo médico por 3 días, diagnóstico..."></textarea>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="cerrarModalLicencia()" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
          Cancelar
        </button>
        <button onclick="guardarLicencia()" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-md hover:bg-gray-800 transition-colors">
          Adjuntar
        </button>
      </div>
    </div>
  </div>

  <!-- Toast confirmación -->
  <div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
    <div class="flex items-center gap-3 px-5 py-3 bg-gray-900 text-white rounded-xl shadow-lg text-sm font-medium">
      <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      <span id="toast-msg">Asistencia guardada correctamente</span>
    </div>
  </div>
</DashboardLayout>

<script define:vars={{ ALUMNOS_MOCK, PROMOCIONES_JSON: JSON.stringify(PROMOCIONES) }}>
  const PROMOCIONES = JSON.parse(PROMOCIONES_JSON);

  // Estado actual
  let promoId = null;
  let cursoCodigo = null;
  let tipoSesion = "teoria_zoom";
  let alumnosActuales = [];
  let asistenciasHoy = {}; // alumnoId → boolean
  let licenciasAdjuntas = {}; // alumnoId → true
  let alumnoModalId = null;

  // Leer query params al cargar
  const params = new URLSearchParams(window.location.search);
  if (params.get("promo")) {
    document.getElementById("sel-promo").value = params.get("promo");
    onPromoChange();
  }
  if (params.get("curso")) {
    setTimeout(() => {
      document.getElementById("sel-curso").value = params.get("curso");
      onCursoChange();
    }, 50);
  }

  document.getElementById("sel-promo").addEventListener("change", onPromoChange);
  document.getElementById("sel-curso").addEventListener("change", onCursoChange);
  document.getElementById("sel-tipo").addEventListener("change", onTipoChange);

  function onPromoChange() {
    const sel = document.getElementById("sel-promo");
    promoId = sel.value ? parseInt(sel.value) : null;
    const cursoSel = document.getElementById("sel-curso");
    cursoSel.innerHTML = '<option value="">Seleccionar curso...</option>';
    cursoSel.disabled = !promoId;

    if (promoId) {
      const promo = PROMOCIONES.find(p => p.id === promoId);
      if (promo) {
        promo.cursos.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.tipo;
          opt.textContent = `Curso ${c.tipo} — ${c.relatorNombre} (${c.alumnosInscritos} alumnos)`;
          cursoSel.appendChild(opt);
        });
      }
    }
    cursoCodigo = null;
    renderPanel();
  }

  function onCursoChange() {
    const sel = document.getElementById("sel-curso");
    cursoCodigo = sel.value || null;
    renderPanel();
  }

  function onTipoChange() {
    tipoSesion = document.getElementById("sel-tipo").value;
    renderPanel();
  }

  function renderPanel() {
    const panelVacio = document.getElementById("panel-vacio");
    const panelAsistencia = document.getElementById("panel-asistencia");

    if (!promoId || !cursoCodigo) {
      panelVacio.classList.remove("hidden");
      panelAsistencia.classList.add("hidden");
      return;
    }

    panelVacio.classList.add("hidden");
    panelAsistencia.classList.remove("hidden");

    // Info sesión
    const promo = PROMOCIONES.find(p => p.id === promoId);
    document.getElementById("info-promo-nombre").textContent = `${promo.nombre} — Curso ${cursoCodigo}`;
    document.getElementById("info-dia-actual").textContent = `Día ${promo.diaActual}/30 · Sesión de hoy`;

    // Alertas tipo sesión
    document.getElementById("alerta-zoom").classList.toggle("hidden", tipoSesion !== "teoria_zoom");
    document.getElementById("alerta-firma").classList.toggle("hidden", tipoSesion !== "firma_semanal");
    document.getElementById("alerta-practica").classList.toggle("hidden", tipoSesion !== "practica");
    document.getElementById("zoom-indicator").classList.toggle("!flex", tipoSesion === "teoria_zoom");
    document.getElementById("zoom-indicator").classList.toggle("hidden", tipoSesion !== "teoria_zoom");

    // Badge tipo
    const badge = document.getElementById("tipo-badge");
    if (tipoSesion === "teoria_zoom") { badge.textContent = "Teoría Zoom"; badge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"; }
    else if (tipoSesion === "firma_semanal") { badge.textContent = "Firma Semanal"; badge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800"; }
    else { badge.textContent = "Práctica Presencial"; badge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"; }

    // Cargar alumnos
    const key = `${promoId}-${cursoCodigo}`;
    alumnosActuales = ALUMNOS_MOCK[key] ?? [];
    // Inicializar asistencia hoy (todos presentes por defecto)
    alumnosActuales.forEach(a => {
      if (!(a.id in asistenciasHoy)) asistenciasHoy[a.id] = true;
      if (a.licMedica) licenciasAdjuntas[a.id] = true;
    });

    renderListaAlumnos();
    renderHistorial();
  }

  function renderListaAlumnos() {
    const lista = document.getElementById("lista-alumnos");
    const diaActual = PROMOCIONES.find(p => p.id === promoId)?.diaActual ?? 0;
    let presentes = 0;

    lista.innerHTML = "";
    alumnosActuales.forEach(alumno => {
      const asistenciaDias = Object.values(alumno.asistencias).filter(Boolean).length;
      const totalDias = Object.keys(alumno.asistencias).length;
      const pct = totalDias > 0 ? Math.round((asistenciaDias / totalDias) * 100) : 0;

      let estadoColor, estadoLabel;
      if (tipoSesion === "practica") {
        // Práctica: 100% requerido
        if (pct === 100) { estadoColor = "bg-green-100 text-green-800"; estadoLabel = "100% ✓"; }
        else if (pct >= 90) { estadoColor = "bg-yellow-100 text-yellow-800"; estadoLabel = `${pct}% ⚠`; }
        else { estadoColor = "bg-red-100 text-red-800"; estadoLabel = `${pct}% ✗`; }
      } else {
        // Teoría: 75% requerido
        if (pct >= 80) { estadoColor = "bg-green-100 text-green-800"; estadoLabel = `${pct}% ✓`; }
        else if (pct >= 65) { estadoColor = "bg-yellow-100 text-yellow-800"; estadoLabel = `${pct}% ⚠`; }
        else { estadoColor = "bg-red-100 text-red-800"; estadoLabel = `${pct}% ✗`; }
      }

      const presente = asistenciasHoy[alumno.id] ?? true;
      if (presente) presentes++;
      const tieneLic = licenciasAdjuntas[alumno.id] ?? false;

      const row = document.createElement("div");
      row.className = `grid grid-cols-12 gap-3 items-center px-4 py-3 hover:bg-gray-50 transition-colors ${!presente && tipoSesion === "practica" ? "bg-red-50/40" : ""}`;
      row.innerHTML = `
        <div class="col-span-1 flex justify-center">
          <input type="checkbox"
            id="chk-${alumno.id}"
            data-id="${alumno.id}"
            ${presente ? "checked" : ""}
            onchange="toggleAsistencia(${alumno.id}, this.checked)"
            class="w-5 h-5 rounded border-2 border-gray-300 text-gray-900 cursor-pointer focus:ring-2 focus:ring-gray-900 focus:ring-offset-1" />
        </div>
        <div class="col-span-4 flex items-center gap-3">
          <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-xs font-bold text-gray-600 shrink-0">
            ${alumno.nombre.charAt(0)}
          </div>
          <div>
            <p class="text-sm font-medium text-gray-900">${alumno.nombre}</p>
            ${tieneLic ? '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-blue-100 text-blue-700 font-medium">Lic. médica</span>' : ""}
          </div>
        </div>
        <div class="col-span-2 text-xs text-gray-500">${alumno.rut}</div>
        <div class="col-span-2 text-center">
          <div class="text-xs text-gray-700 font-medium">${asistenciaDias}/${totalDias}</div>
          <div class="w-full bg-gray-100 rounded-full h-1.5 mt-1">
            <div class="h-1.5 rounded-full transition-all ${pct >= 80 ? "bg-green-500" : pct >= 65 ? "bg-yellow-400" : "bg-red-500"}" style="width:${pct}%"></div>
          </div>
        </div>
        <div class="col-span-2 text-center">
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${estadoColor}">${estadoLabel}</span>
        </div>
        <div class="col-span-1 flex justify-center">
          <button
            onclick="abrirModalLicencia(${alumno.id}, '${alumno.nombre}')"
            title="Adjuntar licencia médica (RF-071)"
            class="p-1.5 rounded-md hover:bg-gray-100 transition-colors ${tieneLic ? "text-blue-600" : "text-gray-400"}"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </button>
        </div>
      `;
      lista.appendChild(row);
    });

    document.getElementById("contador-asistencia").textContent = `${presentes}/${alumnosActuales.length} presentes`;
  }

  function renderHistorial() {
    const promo = PROMOCIONES.find(p => p.id === promoId);
    if (!promo) return;
    const dias = promo.diaActual ?? 0;
    const key = `${promoId}-${cursoCodigo}`;
    const alumnos = ALUMNOS_MOCK[key] ?? [];

    // Mostrar últimos 11 días
    const diasMostrar = Math.min(dias, 11);
    const container = document.getElementById("historial-dias");

    if (diasMostrar === 0) {
      container.innerHTML = '<p class="text-sm text-gray-500">Sin historial disponible.</p>';
      return;
    }

    let html = '<div class="min-w-full">';
    // Header
    html += '<div class="flex items-center gap-0 text-xs font-semibold text-gray-500 mb-2">';
    html += '<div class="w-40 shrink-0">Alumno</div>';
    for (let d = 1; d <= diasMostrar; d++) {
      html += `<div class="w-8 text-center shrink-0 text-gray-400">D${d}</div>`;
    }
    html += '<div class="w-16 text-center shrink-0">Total</div>';
    html += '</div>';

    // Filas alumnos
    alumnos.forEach(a => {
      html += '<div class="flex items-center gap-0 py-1.5 border-t border-gray-100">';
      html += `<div class="w-40 shrink-0 text-xs text-gray-700 font-medium truncate pr-2">${a.nombre.split(" ")[0]} ${a.nombre.split(" ")[1] ?? ""}</div>`;
      const keys = Object.keys(a.asistencias);
      let total = 0;
      for (let d = 1; d <= diasMostrar; d++) {
        const k = `d${d}`;
        const asistio = a.asistencias[k];
        if (asistio) total++;
        html += `<div class="w-8 flex justify-center shrink-0">
          <span class="w-5 h-5 rounded flex items-center justify-center text-xs ${asistio ? "bg-green-100 text-green-700" : "bg-red-100 text-red-600"}">
            ${asistio ? "✓" : "✗"}
          </span>
        </div>`;
      }
      const pct = Math.round((total / diasMostrar) * 100);
      html += `<div class="w-16 text-center shrink-0 text-xs font-medium ${pct >= 75 ? "text-green-700" : pct >= 60 ? "text-yellow-600" : "text-red-600"}">${pct}%</div>`;
      html += '</div>';
    });
    html += '</div>';
    container.innerHTML = html;
  }

  function toggleAsistencia(id, presente) {
    asistenciasHoy[id] = presente;
    // Re-render contador
    let presentes = 0;
    alumnosActuales.forEach(a => { if (asistenciasHoy[a.id]) presentes++; });
    document.getElementById("contador-asistencia").textContent = `${presentes}/${alumnosActuales.length} presentes`;
    // Update row style
    const row = document.getElementById(`chk-${id}`)?.closest(".grid");
    if (row && tipoSesion === "practica") {
      row.classList.toggle("bg-red-50/40", !presente);
    }
  }

  function marcarTodos(presente) {
    alumnosActuales.forEach(a => {
      asistenciasHoy[a.id] = presente;
      const chk = document.getElementById(`chk-${a.id}`);
      if (chk) chk.checked = presente;
    });
    document.getElementById("contador-asistencia").textContent = `${presente ? alumnosActuales.length : 0}/${alumnosActuales.length} presentes`;
  }

  function abrirModalLicencia(id, nombre) {
    alumnoModalId = id;
    document.getElementById("modal-alumno-nombre").textContent = `Alumno: ${nombre}`;
    document.getElementById("modal-lic-medica").classList.remove("hidden");
    document.getElementById("modal-lic-medica").classList.add("flex");
  }

  function cerrarModalLicencia() {
    document.getElementById("modal-lic-medica").classList.add("hidden");
    document.getElementById("modal-lic-medica").classList.remove("flex");
    alumnoModalId = null;
  }

  function onLicFileChange(e) {
    const f = e.target.files[0];
    if (f) document.getElementById("lic-file-label").textContent = `✓ ${f.name}`;
  }

  function guardarLicencia() {
    if (alumnoModalId) {
      licenciasAdjuntas[alumnoModalId] = true;
    }
    cerrarModalLicencia();
    renderListaAlumnos();
    mostrarToast("Licencia médica adjuntada correctamente");
  }

  function guardarAsistencia() {
    mostrarToast("Asistencia guardada correctamente");
    // Simular feedback
    const btn = document.getElementById("btn-guardar");
    btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Guardado`;
    btn.disabled = true;
    btn.classList.add("opacity-70");
    setTimeout(() => {
      btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Guardar asistencia`;
      btn.disabled = false;
      btn.classList.remove("opacity-70");
    }, 3000);
  }

  function mostrarToast(msg) {
    const t = document.getElementById("toast");
    document.getElementById("toast-msg").textContent = msg;
    t.classList.remove("hidden");
    setTimeout(() => t.classList.add("hidden"), 3500);
  }

  // Cerrar modal al click fuera
  document.getElementById("modal-lic-medica").addEventListener("click", function(e) {
    if (e.target === this) cerrarModalLicencia();
  });
</script>

<style>
  select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
</style>
