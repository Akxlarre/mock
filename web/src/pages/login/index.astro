---
/**
 * Login - RF-003: Inicio de Sesi√≥n
 * Dise√±o Geist-inspired con validaci√≥n y estados
 */
import BaseLayout from "../../layouts/BaseLayout.astro";
import Card from "../../components/ui/Card.astro";
import Input from "../../components/ui/Input.astro";
import Button from "../../components/ui/Button.astro";
---

<BaseLayout title="Iniciar Sesi√≥n - Escuela de Conductores">
  <main
    class="min-h-screen flex items-center justify-center bg-gray-50 px-4 py-12"
  >
    <!-- Logo y marca (con transition:name para persistencia) -->
    <div class="w-full max-w-md">
      <div class="text-center mb-8" transition:name="login-brand">
        <div
          class="inline-flex items-center justify-center w-16 h-16 bg-gray-900 rounded-xl mb-4"
        >
          <svg
            class="w-8 h-8 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
            ></path>
          </svg>
        </div>
        <h1 class="text-2xl font-semibold text-gray-900">
          Escuela de Conductores
        </h1>
        <p class="text-sm text-secondary mt-1">Sistema de Gesti√≥n Integral</p>
      </div>

      <!-- Card de login -->
      <Card class="shadow-lg">
        <h2 class="text-lg font-semibold text-gray-900 mb-6">Iniciar Sesi√≥n</h2>

        <form
          id="loginForm"
          class="space-y-4"
          method="POST"
          action="/api/auth/login"
        >
          <!-- Email -->
          <div>
            <Input
              label="Correo electr√≥nico"
              id="email"
              name="email"
              type="email"
              placeholder="tu.correo@ejemplo.cl"
              required
              class="w-full"
            />
          </div>

          <!-- Password -->
          <div>
            <Input
              label="Contrase√±a"
              id="password"
              name="password"
              type="password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
              class="w-full"
            />
          </div>

          <!-- Recordarme -->
          <div class="flex items-center justify-between">
            <label class="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                name="remember"
                class="w-4 h-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900 focus:ring-offset-0"
              />
              <span class="text-sm text-secondary">Recordarme</span>
            </label>

            <a
              href="/login/recuperar-contrasena"
              class="text-sm text-gray-700 hover:text-gray-900 hover:underline focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 rounded px-1"
            >
              ¬øOlvidaste tu contrase√±a?
            </a>
          </div>

          <!-- RF-014: Error message / lockout UI -->
          <div id="loginError" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
            <p id="loginErrorText" class="text-sm text-red-800 font-medium"></p>
            <p id="loginErrorDetail" class="text-xs text-red-600 mt-1"></p>
          </div>

          <div id="lockoutMessage" class="hidden p-4 bg-orange-50 border border-orange-200 rounded-lg">
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-orange-600 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
              <div>
                <p class="text-sm font-semibold text-orange-900">Cuenta bloqueada temporalmente</p>
                <p class="text-xs text-orange-800 mt-1">Demasiados intentos fallidos. Espera <span id="lockoutTimer" class="font-mono font-bold">5:00</span> minutos antes de volver a intentar.</p>
                <p class="text-xs text-orange-700 mt-2">Si necesitas acceso inmediato, contacta al administrador.</p>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div class="pt-2 space-y-3">
            <Button type="submit" variant="primary" class="w-full">
              Ingresar
            </Button>

            <!-- Demo quick access buttons -->
            <div class="relative">
              <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-gray-200"></div>
              </div>
              <div class="relative flex justify-center text-xs">
                <span class="px-2 bg-white text-muted">Demo r√°pido</span>
              </div>
            </div>

            <div class="grid grid-cols-3 gap-2">
              <Button
                type="button"
                variant="ghost"
                class="text-xs"
                onClick="fillDemo('admin')"
              >
                Admin
              </Button>
              <Button
                type="button"
                variant="ghost"
                class="text-xs"
                onClick="fillDemo('secretaria')"
              >
                Secretaria
              </Button>
              <Button
                type="button"
                variant="ghost"
                class="text-xs"
                onClick="fillDemo('instructor')"
              >
                Instructor
              </Button>
            </div>
          </div>
        </form>

        <!-- Footer info -->
        <div class="mt-6 pt-6 border-t border-gray-200">
          <p class="text-xs text-center text-muted">
            Sistema protegido. Para soporte contacta a
            <a
              href="mailto:soporte@escuela.cl"
              class="text-gray-700 hover:text-gray-900 underline"
              >soporte@escuela.cl</a
            >
          </p>
        </div>
      </Card>

      <!-- Credenciales de prueba (solo desarrollo) -->
      <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-xs font-medium text-blue-900 mb-2">
          üîê Credenciales de prueba
        </p>
        <div class="text-xs text-blue-800 space-y-1 font-mono">
          <p><strong>Admin:</strong> admin@escuela.cl / admin123</p>
          <p><strong>Secretaria:</strong> secretaria@escuela.cl / sec123</p>
          <p><strong>Instructor:</strong> instructor@escuela.cl / inst123</p>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  // Demo quick fill
  (window as any).fillDemo = function(role: "admin" | "secretaria" | "instructor") {
    const credentials = {
      admin: { email: "admin@escuela.cl", password: "admin123" },
      secretaria: { email: "secretaria@escuela.cl", password: "sec123" },
      instructor: { email: "instructor@escuela.cl", password: "inst123" },
    };

    const creds = credentials[role];
    const emailInput = document.getElementById("email") as HTMLInputElement;
    const passwordInput = document.getElementById("password") as HTMLInputElement;

    if (emailInput && passwordInput) {
      emailInput.value = creds.email;
      passwordInput.value = creds.password;
    }
  }

  // RF-014: Brute force tracking
  let failedAttempts = 0;
  const MAX_ATTEMPTS = 3;
  let isLockedOut = false;

  const loginError = document.getElementById("loginError");
  const loginErrorText = document.getElementById("loginErrorText");
  const loginErrorDetail = document.getElementById("loginErrorDetail");
  const lockoutMessage = document.getElementById("lockoutMessage");
  const lockoutTimer = document.getElementById("lockoutTimer");

  function showError(message: string, detail: string) {
    if (loginError && loginErrorText && loginErrorDetail) {
      loginErrorText.textContent = message;
      loginErrorDetail.textContent = detail;
      loginError.classList.remove("hidden");
    }
  }

  function hideError() {
    loginError?.classList.add("hidden");
  }

  function startLockout() {
    isLockedOut = true;
    lockoutMessage?.classList.remove("hidden");
    hideError();

    let seconds = 300; // 5 minutos
    const submitBtn = document.querySelector('#loginForm button[type="submit"]') as HTMLButtonElement;
    if (submitBtn) submitBtn.disabled = true;

    const interval = setInterval(() => {
      seconds--;
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      if (lockoutTimer) {
        lockoutTimer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      }
      if (seconds <= 0) {
        clearInterval(interval);
        isLockedOut = false;
        failedAttempts = 0;
        lockoutMessage?.classList.add("hidden");
        if (submitBtn) submitBtn.disabled = false;
      }
    }, 1000);
  }

  // Form validation
  const form = document.getElementById("loginForm");
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (isLockedOut) return;

    const formData = new FormData(form as HTMLFormElement);
    const email = formData.get("email");

    // Demo: redirect based on email (valid credentials)
    if (email?.toString().includes("admin")) {
      window.location.href = "/dashboard";
    } else if (email?.toString().includes("secretaria")) {
      window.location.href = "/dashboard";
    } else if (email?.toString().includes("instructor")) {
      window.location.href = "/dashboard/instructor";
    } else {
      // RF-014: Track failed attempt
      failedAttempts++;
      const remaining = MAX_ATTEMPTS - failedAttempts;

      if (failedAttempts >= MAX_ATTEMPTS) {
        startLockout();
      } else {
        showError(
          "Credenciales inv√°lidas",
          `Intento ${failedAttempts} de ${MAX_ATTEMPTS}. Tras ${remaining} intento${remaining !== 1 ? 's' : ''} m√°s la cuenta se bloquear√° temporalmente.`
        );
      }
    }
  });
</script>

<style>
  /* Custom checkbox styling */
  input[type="checkbox"] {
    appearance: none;
    border: 1px solid rgb(209, 213, 219);
    border-radius: 0.25rem;
    width: 1rem;
    height: 1rem;
    cursor: pointer;
    position: relative;
  }

  input[type="checkbox"]:checked {
    background-color: rgb(17, 24, 39);
    border-color: rgb(17, 24, 39);
  }

  input[type="checkbox"]:checked::before {
    content: "";
    position: absolute;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3E%3C/svg%3E");
    background-size: 100% 100%;
  }

  input[type="checkbox"]:focus {
    outline: 2px solid rgb(17, 24, 39);
    outline-offset: 2px;
  }
</style>
