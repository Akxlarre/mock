---
/**
 * Archivo Histórico — Vista Secretaría (wrapper con rol correcto)
 * RF-077: Consulta de promociones finalizadas
 */
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import Card from "../../../components/ui/Card.astro";
import Button from "../../../components/ui/Button.astro";

const ARCHIVO: {
  promoId: number; codigo: string; nombre: string;
  fechaInicio: string; fechaFin: string; sede: string;
  alumnos: {
    id: number; nombre: string; rut: string; curso: string;
    asistenciaTeoria: number; asistenciaPractica: number;
    promedioNotas: number; examenFinal: "aprobado" | "reprobado";
    certificado: string | null;
  }[];
}[] = [
  {
    promoId: 1, codigo: "PROM-2025-12", nombre: "Promoción Diciembre 2025",
    fechaInicio: "24 Nov 2025", fechaFin: "27 Dic 2025", sede: "Conductores Chillán",
    alumnos: [
      { id: 1,  nombre: "Carlos Soto Muñoz",    rut: "15.432.198-7", curso: "A2", asistenciaTeoria: 88,  asistenciaPractica: 100, promedioNotas: 5.3, examenFinal: "aprobado",  certificado: "CERT-PROF-2026-001" },
      { id: 2,  nombre: "Andrea Flores Vera",    rut: "16.789.234-5", curso: "A2", asistenciaTeoria: 62,  asistenciaPractica: 82,  promedioNotas: 3.9, examenFinal: "reprobado", certificado: null },
      { id: 3,  nombre: "Luis Pérez Castro",     rut: "14.567.890-3", curso: "A2", asistenciaTeoria: 100, asistenciaPractica: 100, promedioNotas: 6.2, examenFinal: "aprobado",  certificado: "CERT-PROF-2026-003" },
      { id: 4,  nombre: "Mariana Torres Rojas",  rut: "17.234.567-K", curso: "A2", asistenciaTeoria: 40,  asistenciaPractica: 45,  promedioNotas: 3.2, examenFinal: "reprobado", certificado: null },
      { id: 5,  nombre: "Roberto Núñez Díaz",    rut: "13.456.789-1", curso: "A3", asistenciaTeoria: 87,  asistenciaPractica: 100, promedioNotas: 5.0, examenFinal: "aprobado",  certificado: "CERT-PROF-2026-002" },
      { id: 6,  nombre: "Patricia Vargas Silva", rut: "15.678.901-2", curso: "A3", asistenciaTeoria: 95,  asistenciaPractica: 100, promedioNotas: 5.8, examenFinal: "aprobado",  certificado: "CERT-PROF-2026-004" },
      { id: 7,  nombre: "Jorge Morales Reyes",   rut: "16.901.234-6", curso: "A3", asistenciaTeoria: 75,  asistenciaPractica: 100, promedioNotas: 4.5, examenFinal: "aprobado",  certificado: "CERT-PROF-2026-005" },
      { id: 8,  nombre: "Valentina Ríos Lagos",  rut: "15.234.567-4", curso: "A4", asistenciaTeoria: 100, asistenciaPractica: 100, promedioNotas: 6.0, examenFinal: "aprobado",  certificado: "CERT-PROF-2026-006" },
      { id: 9,  nombre: "Felipe Aguilar Pino",   rut: "17.345.678-9", curso: "A4", asistenciaTeoria: 80,  asistenciaPractica: 97,  promedioNotas: 4.8, examenFinal: "reprobado", certificado: null },
      { id: 10, nombre: "Diego Meza Fuentes",    rut: "16.456.789-0", curso: "A5", asistenciaTeoria: 78,  asistenciaPractica: 100, promedioNotas: 4.9, examenFinal: "aprobado",  certificado: "CERT-PROF-2026-007" },
    ],
  },
  {
    promoId: 0, codigo: "PROM-2025-10", nombre: "Promoción Octubre 2025",
    fechaInicio: "6 Oct 2025", fechaFin: "8 Nov 2025", sede: "Conductores Chillán",
    alumnos: [
      { id: 20, nombre: "Camila Rojas Vega",      rut: "18.123.456-7", curso: "A2", asistenciaTeoria: 90,  asistenciaPractica: 100, promedioNotas: 5.5, examenFinal: "aprobado",  certificado: "CERT-PROF-2025-018" },
      { id: 21, nombre: "Sebastián Mora Castro",  rut: "17.654.321-2", curso: "A2", asistenciaTeoria: 83,  asistenciaPractica: 100, promedioNotas: 4.7, examenFinal: "aprobado",  certificado: "CERT-PROF-2025-019" },
      { id: 22, nombre: "Claudia Herrera Díaz",   rut: "16.234.567-8", curso: "A3", asistenciaTeoria: 77,  asistenciaPractica: 100, promedioNotas: 4.3, examenFinal: "aprobado",  certificado: "CERT-PROF-2025-020" },
      { id: 23, nombre: "Gonzalo Pinto Muñoz",    rut: "15.321.654-3", curso: "A3", asistenciaTeoria: 55,  asistenciaPractica: 73,  promedioNotas: 3.7, examenFinal: "reprobado", certificado: null },
      { id: 24, nombre: "María Fernández López",  rut: "14.876.543-1", curso: "A4", asistenciaTeoria: 100, asistenciaPractica: 100, promedioNotas: 6.5, examenFinal: "aprobado",  certificado: "CERT-PROF-2025-021" },
      { id: 25, nombre: "Nicolás Castillo Vera",  rut: "15.987.654-2", curso: "A5", asistenciaTeoria: 83,  asistenciaPractica: 100, promedioNotas: 5.2, examenFinal: "aprobado",  certificado: "CERT-PROF-2025-022" },
    ],
  },
];

const todosAlumnos = ARCHIVO.flatMap(p => p.alumnos.map(a => ({ ...a, promo: p.nombre, codigo: p.codigo, fechaFin: p.fechaFin })));
---

<DashboardLayout title="Archivo Histórico" escuela="Conductores Chillán">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
      <a href="/secretaria/profesional/promociones" class="hover:text-gray-900">Promociones</a>
      <span>/</span>
      <span class="text-gray-900 font-medium">Archivo Histórico</span>
    </div>
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl font-semibold text-gray-900 tracking-tight text-balance">Archivo Histórico</h1>
        <p class="text-gray-600 mt-1">RF-077 — Consulta de promociones finalizadas · búsqueda por RUT o nombre</p>
      </div>
      <Button variant="secondary" onClick="alert('Exportar historial completo (mockup)')">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
        Exportar historial
      </Button>
    </div>
  </div>

  <!-- Buscador -->
  <Card class="mb-6">
    <h2 class="text-sm font-semibold text-gray-900 mb-3">Búsqueda de alumno</h2>
    <div class="flex gap-3">
      <div class="flex-1 relative">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        <input
          id="busqueda"
          type="text"
          placeholder="Buscar por nombre o RUT..."
          class="w-full pl-9 pr-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-1"
          oninput="filtrarAlumnos(this.value)"
        />
      </div>
      <button
        onclick="document.getElementById('busqueda').value=''; filtrarAlumnos('')"
        class="px-3 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 shadow-sm transition-colors"
      >
        Limpiar
      </button>
    </div>
    <div id="resultados-busqueda" class="hidden mt-4">
      <p class="text-xs text-gray-500 mb-3" id="resultados-count"></p>
      <div id="resultados-lista" class="space-y-2"></div>
    </div>
    <script is:inline define:vars={{ todosAlumnos }}>
      window._alumnosArchivo = todosAlumnos;
    </script>
  </Card>

  <!-- Stats -->
  <div class="grid sm:grid-cols-4 gap-4 mb-6">
    <div class="border border-gray-200 rounded-lg bg-white p-4 shadow-sm text-center">
      <p class="text-2xl font-bold text-gray-900">{ARCHIVO.length}</p>
      <p class="text-xs text-gray-500 mt-1">Promociones archivadas</p>
    </div>
    <div class="border border-gray-200 rounded-lg bg-white p-4 shadow-sm text-center">
      <p class="text-2xl font-bold text-gray-900">{todosAlumnos.length}</p>
      <p class="text-xs text-gray-500 mt-1">Total alumnos histórico</p>
    </div>
    <div class="border border-green-100 rounded-lg bg-green-50 p-4 text-center">
      <p class="text-2xl font-bold text-green-700">{todosAlumnos.filter(a => a.examenFinal === "aprobado").length}</p>
      <p class="text-xs text-green-600 mt-1">Egresados certificados</p>
    </div>
    <div class="border border-red-100 rounded-lg bg-red-50 p-4 text-center">
      <p class="text-2xl font-bold text-red-600">{todosAlumnos.filter(a => a.examenFinal === "reprobado").length}</p>
      <p class="text-xs text-red-500 mt-1">Reprobados</p>
    </div>
  </div>

  <!-- Histórico por promoción -->
  <div class="space-y-6">
    {ARCHIVO.map(promo => {
      const aprobados = promo.alumnos.filter(a => a.examenFinal === "aprobado").length;
      const tasa = Math.round((aprobados / promo.alumnos.length) * 100);
      return (
        <Card>
          <div class="flex flex-wrap items-start justify-between gap-4 mb-4 pb-4 border-b border-gray-200">
            <div>
              <div class="flex items-center gap-3">
                <h2 class="text-base font-semibold text-gray-900">{promo.nombre}</h2>
                <span class="inline-flex items-center px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded-full font-mono">{promo.codigo}</span>
                <span class="inline-flex items-center px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-medium">Finalizada</span>
              </div>
              <p class="text-xs text-gray-500 mt-1">{promo.fechaInicio} → {promo.fechaFin} · {promo.sede}</p>
            </div>
            <div class="text-right">
              <p class="text-2xl font-bold text-gray-900">{tasa}%</p>
              <p class="text-xs text-gray-500">tasa de aprobación ({aprobados}/{promo.alumnos.length})</p>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-gray-200">
                  <th class="text-left py-2 pr-4 text-xs font-semibold text-gray-600 uppercase tracking-wide">Alumno</th>
                  <th class="text-center py-2 px-2 text-xs font-semibold text-gray-600 uppercase tracking-wide">Curso</th>
                  <th class="text-center py-2 px-2 text-xs font-semibold text-gray-600 uppercase tracking-wide">Asist. Teoría</th>
                  <th class="text-center py-2 px-2 text-xs font-semibold text-gray-600 uppercase tracking-wide">Asist. Práctica</th>
                  <th class="text-center py-2 px-2 text-xs font-semibold text-gray-600 uppercase tracking-wide">Prom. Notas</th>
                  <th class="text-center py-2 px-2 text-xs font-semibold text-gray-600 uppercase tracking-wide">Examen Final</th>
                  <th class="text-center py-2 px-2 text-xs font-semibold text-gray-600 uppercase tracking-wide">Certificado</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                {promo.alumnos.map(a => (
                  <tr class="hover:bg-gray-50 transition-colors">
                    <td class="py-3 pr-4">
                      <p class="text-sm font-medium text-gray-900">{a.nombre}</p>
                      <p class="text-xs text-gray-400 font-mono">{a.rut}</p>
                    </td>
                    <td class="py-3 px-2 text-center">
                      <span class="inline-flex items-center px-2 py-0.5 bg-gray-100 text-gray-700 text-xs rounded font-semibold">{a.curso}</span>
                    </td>
                    <td class="py-3 px-2 text-center">
                      <span class={`text-sm font-semibold ${a.asistenciaTeoria >= 75 ? "text-green-700" : "text-red-600"}`}>{a.asistenciaTeoria}%</span>
                    </td>
                    <td class="py-3 px-2 text-center">
                      <span class={`text-sm font-semibold ${a.asistenciaPractica >= 100 ? "text-green-700" : "text-red-600"}`}>{a.asistenciaPractica}%</span>
                    </td>
                    <td class="py-3 px-2 text-center">
                      <span class={`text-sm font-semibold ${a.promedioNotas >= 4.0 ? "text-green-700" : "text-red-600"}`}>{a.promedioNotas.toFixed(1)}</span>
                    </td>
                    <td class="py-3 px-2 text-center">
                      <span class={`inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full ${a.examenFinal === "aprobado" ? "bg-green-100 text-green-800" : "bg-red-100 text-red-700"}`}>
                        {a.examenFinal === "aprobado" ? "Aprobado" : "Reprobado"}
                      </span>
                    </td>
                    <td class="py-3 px-2 text-center">
                      {a.certificado ? (
                        <button onclick={`alert('Descargando ${a.certificado}.pdf\\n\\nRF-096: Descarga registrada en historial')`} class="text-xs text-blue-600 hover:underline font-mono">{a.certificado}</button>
                      ) : (
                        <span class="text-xs text-gray-300">—</span>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>
      );
    })}
  </div>
</DashboardLayout>

<script>
  function filtrarAlumnos(query: string) {
    const resultadosDiv = document.getElementById('resultados-busqueda')!;
    const resultadosLista = document.getElementById('resultados-lista')!;
    const resultadosCount = document.getElementById('resultados-count')!;
    if (!query || query.trim().length < 2) { resultadosDiv.classList.add('hidden'); return; }
    const q = query.toLowerCase().trim();
    const alumnos: any[] = (window as any)._alumnosArchivo || [];
    const encontrados = alumnos.filter((a: any) =>
      a.nombre.toLowerCase().includes(q) || a.rut.replace(/\./g, '').replace(/-/g, '').includes(q.replace(/\./g, '').replace(/-/g, ''))
    );
    resultadosCount.textContent = `${encontrados.length} resultado(s) para "${query}"`;
    resultadosLista.innerHTML = encontrados.length === 0
      ? '<p class="text-sm text-gray-400 italic">Sin resultados</p>'
      : encontrados.map((a: any) => `
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
            <div>
              <p class="text-sm font-semibold text-gray-900">${a.nombre}</p>
              <p class="text-xs text-gray-500">${a.rut} · Curso ${a.curso} · ${a.promo} · ${a.fechaFin}</p>
            </div>
            <div class="flex items-center gap-3 text-xs">
              <span class="text-gray-500">Teoría: <strong>${a.asistenciaTeoria}%</strong></span>
              <span class="text-gray-500">Práctica: <strong>${a.asistenciaPractica}%</strong></span>
              <span class="text-gray-500">Prom: <strong>${a.promedioNotas.toFixed(1)}</strong></span>
              <span class="inline-flex px-2 py-0.5 rounded-full font-semibold ${a.examenFinal === 'aprobado' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-700'}">
                ${a.examenFinal === 'aprobado' ? 'Aprobado' : 'Reprobado'}
              </span>
              ${a.certificado ? `<span class="text-blue-600 font-mono">${a.certificado}</span>` : ''}
            </div>
          </div>
        `).join('');
    resultadosDiv.classList.remove('hidden');
  }
  (window as any).filtrarAlumnos = filtrarAlumnos;
</script>
