---
/**
 * Wizard Matrícula - Paso 1 (secretaria)
 */
import DashboardLayout from "../../../../layouts/DashboardLayout.astro";
import Card from "../../../../components/ui/Card.astro";
import Input from "../../../../components/ui/Input.astro";
import Button from "../../../../components/ui/Button.astro";
import MatriculaWizardSteps from "../../../../components/matricula/MatriculaWizardSteps.astro";
import ModalMenores17 from "../../../../components/matricula/ModalMenores17.astro";
import { ESCUELA_ACTUAL } from "../../../../lib/mockData";
import { PROMOCIONES } from "../../../../lib/mockRelatores";

/** RF-062/RF-063: Promociones con cupo disponible (totalAlumnos < 100) */
const promocionesDisponibles = PROMOCIONES.filter(
  (p) => (p.estado === "en_curso" || p.estado === "planificada") && p.totalAlumnos < 100
);

const basePath = "/secretaria";
---

<DashboardLayout
  title="Matrícula - Datos personales"
  escuela={ESCUELA_ACTUAL}
  userRole="secretaria"
>
  <MatriculaWizardSteps pasoActual={1} basePath={basePath} />

  <div class="grid lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2">
      <Card>
        <h2 class="text-lg font-semibold text-gray-900 mb-6">
          Paso 1: Datos personales
        </h2>

        <form id="matriculaForm" class="space-y-6">
          <div>
            <Input
              label="RUT del alumno"
              id="rut"
              name="rut"
              type="text"
              placeholder="12.345.678-9"
              required
            />
            <p class="text-xs text-secondary mt-1.5">
              ✓ Validación automática de RUT chileno (RF-008)
            </p>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <Input
              label="Nombres"
              id="nombres"
              name="nombres"
              type="text"
              placeholder="Juan Pablo"
              required
            />
            <Input
              label="Apellidos"
              id="apellidos"
              name="apellidos"
              type="text"
              placeholder="González Pérez"
              required
            />
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <Input
              label="Email"
              id="email"
              name="email"
              type="email"
              placeholder="alumno@ejemplo.cl"
              required
            />
            <Input
              label="Teléfono / WhatsApp"
              id="telefono"
              name="telefono"
              type="tel"
              placeholder="+56 9 1234 5678"
              required
            />
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <Input
              label="Fecha de nacimiento"
              id="fecha_nacimiento"
              name="fecha_nacimiento"
              type="date"
              required
            />
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5"
                >Sexo</label
              >
              <select
                name="sexo"
                class="h-11 px-4 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1"
              >
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
              </select>
            </div>
          </div>

          <!-- RF-082.1: Alerta edad dinámica -->
          <div
            id="edad-alert-block"
            class="hidden p-4 rounded-lg border-2 border-red-300 bg-red-50"
          >
            <div class="flex items-start gap-3">
              <svg
                class="w-6 h-6 text-red-600 shrink-0 mt-0.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"
                ></path>
              </svg>
              <div>
                <p class="text-sm font-bold text-red-900">
                  ⛔ Menor de 17 años — No se puede matricular
                </p>
                <p class="text-xs text-red-800 mt-1">
                  La edad mínima para ingresar a una escuela de conductores es
                  de 17 años cumplidos.
                </p>
              </div>
            </div>
          </div>

          <div
            id="edad-alert-menor"
            class="hidden p-4 rounded-lg border-2 border-yellow-300 bg-yellow-50"
          >
            <div class="flex items-start gap-3">
              <svg
                class="w-6 h-6 text-yellow-600 shrink-0 mt-0.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                ></path>
              </svg>
              <div>
                <p class="text-sm font-bold text-yellow-900">
                  ⚠️ Alumno de 17 años — Requiere Autorización Notarial
                </p>
                <p class="text-xs text-yellow-800 mt-1">
                  Se deberá adjuntar <strong
                    >Autorización Notarial firmada</strong
                  > por el apoderado en el paso de Documentación.
                </p>
                <a
                  href="#modal-menores17"
                  class="text-xs text-yellow-700 underline hover:text-yellow-900 mt-1 inline-block"
                  >Ver requisitos completos para menores de edad</a
                >
              </div>
            </div>
          </div>

          <div
            id="edad-alert-ok"
            class="hidden p-3 rounded-lg border border-green-200 bg-green-50"
          >
            <p class="text-sm text-green-800 flex items-center gap-2">
              <svg
                class="w-4 h-4 text-green-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"></path>
              </svg>
              <span id="edad-label">Mayor de edad — Sin restricciones</span>
            </p>
          </div>

          <p class="text-sm text-secondary">
            <a href="#modal-menores17" class="text-blue-600 hover:underline"
              >¿Menor de 17 años? Ver requisitos (RF-007)</a
            >
          </p>

          <div>
            <Input
              label="Dirección"
              id="direccion"
              name="direccion"
              type="text"
              placeholder="Calle Ejemplo 123, Depto 45"
              required
            />
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5"
                >Región</label
              >
              <select
                name="region"
                class="h-11 px-4 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1"
              >
                <option value="16">Ñuble</option>
                <option value="08">Biobío</option>
                <option value="13">Metropolitana</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5"
                >Comuna</label
              >
              <select
                name="comuna"
                class="h-11 px-4 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1"
              >
                <option value="chillan">Chillán</option>
                <option value="chillan-viejo">Chillán Viejo</option>
                <option value="barris">Barris</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5"
              >Curso</label
            >
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
              <label
                class="flex items-center gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition-colors has-checked:border-gray-900 has-checked:bg-gray-50"
              >
                <input
                  type="radio"
                  name="tipo_curso"
                  value="clase_b"
                  class="w-4 h-4 curso-radio"
                  checked
                />
                <div>
                  <p class="text-sm font-medium text-gray-900">Clase B</p><p
                    class="text-xs text-secondary"
                  >
                    Standard
                  </p>
                </div>
              </label>
              <label
                class="flex items-center gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition-colors has-checked:border-gray-900 has-checked:bg-gray-50"
              >
                <input
                  type="radio"
                  name="tipo_curso"
                  value="clase_b_sence"
                  class="w-4 h-4 curso-radio"
                />
                <div>
                  <p class="text-sm font-medium text-gray-900">Clase B</p><p
                    class="text-xs text-purple-600 font-medium"
                  >
                    + SENCE
                  </p>
                </div>
              </label>
              <label
                class="flex items-center gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition-colors has-checked:border-gray-900 has-checked:bg-gray-50"
              >
                <input
                  type="radio"
                  name="tipo_curso"
                  value="profesional_a2"
                  class="w-4 h-4 curso-radio"
                />
                <div>
                  <p class="text-sm font-medium text-gray-900">
                    Profesional A2
                  </p><p class="text-xs text-secondary">Transporte público</p>
                </div>
              </label>
              <label
                class="flex items-center gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition-colors has-checked:border-gray-900 has-checked:bg-gray-50"
              >
                <input
                  type="radio"
                  name="tipo_curso"
                  value="profesional_a3"
                  class="w-4 h-4 curso-radio"
                />
                <div>
                  <p class="text-sm font-medium text-gray-900">
                    Profesional A3
                  </p><p class="text-xs text-secondary">Vehículos pesados</p>
                </div>
              </label>
              <label
                class="flex items-center gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition-colors has-checked:border-gray-900 has-checked:bg-gray-50"
              >
                <input
                  type="radio"
                  name="tipo_curso"
                  value="profesional_a4"
                  class="w-4 h-4 curso-radio"
                />
                <div>
                  <p class="text-sm font-medium text-gray-900">
                    Profesional A4
                  </p><p class="text-xs text-secondary">
                    Transporte remunerado
                  </p>
                </div>
              </label>
              <label
                class="flex items-center gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition-colors has-checked:border-gray-900 has-checked:bg-gray-50"
              >
                <input
                  type="radio"
                  name="tipo_curso"
                  value="profesional_a5"
                  class="w-4 h-4 curso-radio"
                />
                <div>
                  <p class="text-sm font-medium text-gray-900">
                    Profesional A5
                  </p><p class="text-xs text-secondary">
                    Vehículos articulados
                  </p>
                </div>
              </label>
            </div>
          </div>

          <div id="sence-codigo-wrap" class="hidden">
            <label
              class="block text-sm font-medium text-gray-700 mb-1.5"
              for="codigo_sence">Código SENCE</label
            >
            <select
              id="codigo_sence"
              name="codigo_sence"
              class="h-11 px-4 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1"
            >
              <option value="">Seleccione código vigente</option>
              <option value="12345678-9">12345678-9 — Conducción Clase B</option
              >
              <option value="87654321-0"
                >87654321-0 — Conducción defensiva</option
              >
              <option value="11223344-5">11223344-5 — Clase B inicial</option>
              <option value="55443322-1"
                >55443322-1 — Formación conductores</option
              >
            </select>
            <p class="text-xs text-secondary mt-1.5">
              Códigos vigentes en registro SENCE
            </p>
          </div>

          <!-- ─── RF-062 / RF-063: Validaciones Clase Profesional ─── -->
          <div id="profesional-section" class="hidden space-y-5 pt-2 border-t border-gray-200">
            <p class="text-sm font-semibold text-gray-900">Requisitos Clase Profesional</p>

            <!-- Edad > 20 (A2/A4) -->
            <div id="edad-prof-alert" class="hidden p-4 rounded-lg border-2 border-red-300 bg-red-50">
              <p class="text-sm font-bold text-red-900">⛔ Edad insuficiente</p>
              <p class="text-xs text-red-800 mt-1">Para A2 y A4 se requiere ser <strong>mayor de 20 años</strong>. Para A3 y A5 mayor de 21 años.</p>
            </div>
            <div id="edad-prof-ok" class="hidden p-3 rounded-lg border border-green-200 bg-green-50">
              <p class="text-sm text-green-800 flex items-center gap-2">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                <span id="edad-prof-label">Edad válida para clase profesional</span>
              </p>
            </div>

            <!-- Licencia previa -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5">Tipo de licencia actual <span class="text-red-500">*</span></label>
              <select id="licencia_actual" name="licencia_actual"
                class="h-11 px-4 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1">
                <option value="">Seleccionar licencia...</option>
                <option value="B">Clase B (Automóvil)</option>
                <option value="A2">A2 (Transporte público)</option>
                <option value="A3">A3 (Vehículos pesados)</option>
                <option value="A4">A4 (Transporte remunerado)</option>
                <option value="A5">A5 (Vehículos articulados)</option>
                <option value="ninguna">Sin licencia vigente</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5">Fecha de emisión de la licencia <span class="text-red-500">*</span></label>
              <input id="fecha_licencia" name="fecha_licencia" type="date"
                class="h-11 px-4 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1" />
              <p class="text-xs text-gray-500 mt-1">Se valida antigüedad mínima de 2 años (RF-062)</p>
            </div>

            <div id="licencia-alert" class="hidden p-4 rounded-lg border-2 border-red-300 bg-red-50">
              <p class="text-sm font-bold text-red-900" id="licencia-alert-msg">⛔ Licencia no válida</p>
              <p class="text-xs text-red-800 mt-1" id="licencia-alert-detail"></p>
            </div>
            <div id="licencia-ok" class="hidden p-3 rounded-lg border border-green-200 bg-green-50">
              <p class="text-sm text-green-800 flex items-center gap-2">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                <span id="licencia-ok-msg">Licencia válida</span>
              </p>
            </div>

            <!-- Selector Promoción -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5">Promoción <span class="text-red-500">*</span></label>
              <select id="promocion_id" name="promocion_id"
                class="h-11 px-4 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1">
                <option value="">Seleccionar promoción...</option>
                {promocionesDisponibles.map((p) => (
                  <option value={String(p.id)} data-cursos={JSON.stringify(p.cursos)} data-estado={p.estado}>
                    {p.nombre} — {p.estado === "en_curso" ? `Día ${p.diaActual}/30` : "Planificada"} ({p.totalAlumnos}/100 alumnos)
                  </option>
                ))}
              </select>
              <p class="text-xs text-gray-500 mt-1">Solo promociones con cupo disponible (RF-062)</p>
            </div>

            <!-- Selector Curso dentro de la promoción -->
            <div id="curso-prof-wrap" class="hidden">
              <label class="block text-sm font-medium text-gray-700 mb-1.5">Curso dentro de la promoción <span class="text-red-500">*</span></label>
              <select id="curso_profesional" name="curso_profesional"
                class="h-11 px-4 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1">
                <option value="">Seleccionar curso...</option>
              </select>
              <p class="text-xs text-gray-500 mt-1">Solo cursos con cupo (&lt;25 alumnos) compatibles con la licencia (RF-063)</p>
            </div>

            <!-- ─── RF-064/RF-065/RF-066: Convalidación A2+A4 ─── -->
            <div id="convalidacion-wrap" class="hidden pt-2 border-t border-gray-200">
              <label class="flex items-start gap-3 cursor-pointer group">
                <div class="relative mt-0.5">
                  <input
                    type="checkbox"
                    id="convalidacion_check"
                    name="convalidacion"
                    class="w-5 h-5 rounded border-2 border-gray-300 text-gray-900 cursor-pointer focus:ring-2 focus:ring-gray-900 focus:ring-offset-1"
                    onchange="toggleConvalidacion(this.checked)"
                  />
                </div>
                <div>
                  <p class="text-sm font-semibold text-gray-900 group-hover:text-gray-700">
                    Convalidación A2 + A4 simultáneos
                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-purple-100 text-purple-700 font-medium">RF-064</span>
                  </p>
                  <p class="text-xs text-gray-500 mt-0.5">
                    El alumno cursa A2 y A4 al mismo tiempo. Reduce a <strong>60 horas totales</strong>. Requiere vinculación con promoción anterior (hasta 6 años).
                  </p>
                </div>
              </label>

              <!-- Detalle convalidación (se muestra al marcar) -->
              <div id="convalidacion-detalle" class="hidden mt-4 space-y-4 pl-8">
                <!-- Info reducción horas -->
                <div class="p-4 rounded-lg border border-purple-200 bg-purple-50">
                  <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-purple-600 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div class="text-sm">
                      <p class="font-semibold text-purple-900">Régimen de convalidación (RF-065)</p>
                      <ul class="text-xs text-purple-700 mt-1.5 space-y-1">
                        <li>• <strong>Total horas reducidas:</strong> 60 horas (en lugar de carga estándar)</li>
                        <li>• <strong>Libro 1:</strong> habilitado desde el inicio de la promoción</li>
                        <li>• <strong>Libro 2:</strong> se habilita automáticamente 2 semanas después del inicio (RF-066)</li>
                        <li>• La asistencia aplica por separado para cada licencia</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- Búsqueda promoción histórica (RF-064) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">
                    Promoción histórica de origen
                    <span class="ml-1 text-xs text-gray-400 font-normal">(hasta 6 años atrás, RF-064)</span>
                  </label>
                  <div class="flex gap-2">
                    <input
                      type="text"
                      id="busq_promo_historica"
                      placeholder="Buscar por código, año o nombre..."
                      class="h-10 px-3 flex-1 text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1"
                      oninput="buscarPromoHistorica(this.value)"
                    />
                    <button
                      type="button"
                      onclick="buscarPromoHistorica(document.getElementById('busq_promo_historica').value)"
                      class="h-10 px-4 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 shadow-sm transition-colors"
                    >
                      Buscar
                    </button>
                  </div>
                  <p class="text-xs text-gray-400 mt-1">Ej: "PROM-2022-01", "Enero 2023", "enero II"</p>

                  <!-- Resultados búsqueda -->
                  <div id="resultados-promo-historica" class="hidden mt-2 border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                    <!-- Populated by JS -->
                  </div>

                  <!-- Promo seleccionada -->
                  <div id="promo-historica-seleccionada" class="hidden mt-2 p-3 border border-green-200 bg-green-50 rounded-lg">
                    <p class="text-xs font-semibold text-green-800">✓ Promoción vinculada:</p>
                    <p id="promo-historica-label" class="text-sm text-green-900 mt-0.5"></p>
                    <button type="button" onclick="limpiarPromoHistorica()" class="text-xs text-green-600 hover:underline mt-1">Cambiar</button>
                  </div>
                </div>

                <!-- Selector libro habilitado actualmente -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Libro a habilitar al matricular</label>
                  <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center gap-3 p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition-colors has-checked:border-purple-600 has-checked:bg-purple-50">
                      <input type="radio" name="libro_convalidacion" value="libro_1" class="w-4 h-4" checked />
                      <div>
                        <p class="text-sm font-medium text-gray-900">Libro 1</p>
                        <p class="text-xs text-gray-500">Disponible desde inicio</p>
                      </div>
                    </label>
                    <label id="libro2-option" class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-not-allowed opacity-50">
                      <input type="radio" name="libro_convalidacion" value="libro_2" class="w-4 h-4" disabled />
                      <div>
                        <p class="text-sm font-medium text-gray-500">Libro 2</p>
                        <p class="text-xs text-gray-400">Se habilita a las 2 semanas (RF-066)</p>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <!-- ─── Fin convalidación ─── -->
          </div>
          <!-- ─── Fin validaciones profesional ─── -->

          <div
            class="flex items-center justify-between pt-6 border-t border-gray-200"
          >
            <Button href={`${basePath}/matricula`} variant="ghost"
              >Cancelar</Button
            >
            <Button type="button" variant="primary" onClick="nextStep()"
              >Siguiente paso →</Button
            >
          </div>
        </form>
      </Card>
    </div>

    <div class="space-y-4">
      <Card>
        <h3 class="text-sm font-semibold text-gray-900 mb-4">
          Resumen del curso
        </h3>
        <div class="space-y-3 text-sm">
          <div class="flex justify-between">
            <span class="text-secondary">Tipo:</span><span
              class="font-medium text-gray-900">Clase B</span>
          </div>
          <div class="flex justify-between">
            <span class="text-secondary">Duración:</span><span
              class="font-medium text-gray-900">8 semanas</span>
          </div>
          <div class="flex justify-between">
            <span class="text-secondary">Clases prácticas:</span><span
              class="font-medium text-gray-900">18 horas</span>
          </div>
          <div class="flex justify-between">
            <span class="text-secondary">Clases teóricas:</span><span
              class="font-medium text-gray-900">12 horas</span>
          </div>
          <hr class="border-gray-200" />
          <div class="flex justify-between items-baseline">
            <span class="text-secondary">Valor total:</span><span
              class="text-lg font-semibold text-gray-900">$280.000</span>
          </div>
        </div>
      </Card>
      <Card class="bg-blue-50 border-blue-200">
        <div class="flex gap-3">
          <svg
            class="w-5 h-5 text-blue-600 shrink-0 mt-0.5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <div>
            <p class="text-sm font-medium text-blue-900 mb-1">Requisitos</p>
            <ul class="text-xs text-blue-800 space-y-1">
              <li>• Mayor de 17 años</li>
              <li>• Cédula de identidad vigente</li>
              <li>• Certificado médico</li>
              <li>• Foto carnet</li>
            </ul>
          </div>
        </div>
      </Card>
    </div>
  </div>

  <ModalMenores17 />
</DashboardLayout>

<script define:vars={{ basePath }}>
  let edadValida = true;
  let esMenor = false;

  // Estado validaciones profesional
  let profEdadValida = true;
  let profLicenciaValida = true;
  let esProfesional = false;

  // Convalidación RF-064/065/066
  let convalidacionActiva = false;
  let promoHistoricaSeleccionada = null;

  // Promociones históricas mock (hasta 6 años atrás)
  const PROMOS_HISTORICAS = [
    { id:"h1", codigo:"PROM-2025-10", nombre:"Promoción Octubre 2025",   fechaInicio:"2025-10-06", cursos:["A2","A4"], alumnos:82 },
    { id:"h2", codigo:"PROM-2025-06", nombre:"Promoción Junio 2025",     fechaInicio:"2025-06-02", cursos:["A2","A3","A4"], alumnos:75 },
    { id:"h3", codigo:"PROM-2025-02", nombre:"Promoción Febrero 2025",   fechaInicio:"2025-02-03", cursos:["A2","A4","A5"], alumnos:90 },
    { id:"h4", codigo:"PROM-2024-11", nombre:"Promoción Noviembre 2024", fechaInicio:"2024-11-04", cursos:["A2","A3","A4","A5"], alumnos:88 },
    { id:"h5", codigo:"PROM-2024-07", nombre:"Promoción Julio 2024",     fechaInicio:"2024-07-01", cursos:["A2","A4"], alumnos:67 },
    { id:"h6", codigo:"PROM-2023-12", nombre:"Promoción Diciembre 2023", fechaInicio:"2023-12-04", cursos:["A2","A3"], alumnos:70 },
    { id:"h7", codigo:"PROM-2023-06", nombre:"Promoción Junio 2023",     fechaInicio:"2023-06-05", cursos:["A2","A4","A5"], alumnos:80 },
    { id:"h8", codigo:"PROM-2022-11", nombre:"Promoción Noviembre 2022", fechaInicio:"2022-11-07", cursos:["A2","A4"], alumnos:62 },
    { id:"h9", codigo:"PROM-2022-04", nombre:"Promoción Abril 2022",     fechaInicio:"2022-04-04", cursos:["A2","A3","A4","A5"], alumnos:91 },
    { id:"h10",codigo:"PROM-2021-09", nombre:"Promoción Septiembre 2021",fechaInicio:"2021-09-06", cursos:["A2","A4"], alumnos:58 },
    { id:"h11",codigo:"PROM-2021-03", nombre:"Promoción Marzo 2021",     fechaInicio:"2021-03-01", cursos:["A2","A4","A5"], alumnos:73 },
    { id:"h12",codigo:"PROM-2020-10", nombre:"Promoción Octubre 2020",   fechaInicio:"2020-10-05", cursos:["A2","A3","A4","A5"], alumnos:85 },
  ];

  function isProfesional(val) {
    return ["profesional_a2","profesional_a3","profesional_a4","profesional_a5"].includes(val);
  }
  function getTipoProfesional(val) {
    return val?.replace("profesional_","").toUpperCase(); // "A2","A3",...
  }

  // ── Convalidación RF-064/065/066 ──
  function toggleConvalidacionWrap() {
    const tipoCursoEl = document.querySelector('input[name="tipo_curso"]:checked');
    const tipo = getTipoProfesional(tipoCursoEl?.value ?? "");
    const wrap = document.getElementById("convalidacion-wrap");
    // Solo A2 o A4 pueden convalidar (se cursan simultáneos con su par)
    const puedeConvalidar = tipo === "A2" || tipo === "A4";
    if (wrap) {
      wrap.classList.toggle("hidden", !puedeConvalidar || !esProfesional);
      if (!puedeConvalidar) {
        // Desactivar si cambia a otro tipo
        const chk = document.getElementById("convalidacion_check");
        if (chk) { chk.checked = false; }
        toggleConvalidacion(false);
      }
    }
  }

  function toggleConvalidacion(activa) {
    convalidacionActiva = activa;
    const detalle = document.getElementById("convalidacion-detalle");
    if (detalle) detalle.classList.toggle("hidden", !activa);
    if (!activa) {
      promoHistoricaSeleccionada = null;
      const sel = document.getElementById("promo-historica-seleccionada");
      if (sel) sel.classList.add("hidden");
      const res = document.getElementById("resultados-promo-historica");
      if (res) res.classList.add("hidden");
      const inp = document.getElementById("busq_promo_historica");
      if (inp) inp.value = "";
    }
  }

  function buscarPromoHistorica(query) {
    const container = document.getElementById("resultados-promo-historica");
    if (!container) return;
    const q = query.toLowerCase().trim();
    if (q.length < 2) { container.classList.add("hidden"); return; }

    // Filtrar hasta 6 años atrás
    const cutoff = new Date();
    cutoff.setFullYear(cutoff.getFullYear() - 6);

    const resultados = PROMOS_HISTORICAS.filter(p => {
      const fechaP = new Date(p.fechaInicio);
      return fechaP >= cutoff && (
        p.codigo.toLowerCase().includes(q) ||
        p.nombre.toLowerCase().includes(q)
      );
    });

    if (resultados.length === 0) {
      container.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500">Sin resultados para esta búsqueda.</div>';
    } else {
      container.innerHTML = resultados.map(p => `
        <div
          class="flex items-center justify-between px-4 py-3 hover:bg-gray-50 cursor-pointer border-b last:border-0 border-gray-100 transition-colors"
          onclick="seleccionarPromoHistorica('${p.id}','${p.nombre}','${p.codigo}','${p.fechaInicio}')"
        >
          <div>
            <p class="text-sm font-medium text-gray-900">${p.nombre}</p>
            <p class="text-xs text-gray-500">${p.codigo} · ${new Date(p.fechaInicio + "T12:00:00").toLocaleDateString("es-CL",{day:"numeric",month:"long",year:"numeric"})} · ${p.alumnos} alumnos</p>
            <p class="text-xs text-purple-600">Cursos: ${p.cursos.join(", ")}</p>
          </div>
          <svg class="w-4 h-4 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </div>
      `).join("");
    }
    container.classList.remove("hidden");
  }

  function seleccionarPromoHistorica(id, nombre, codigo, fecha) {
    promoHistoricaSeleccionada = { id, nombre, codigo, fecha };
    document.getElementById("resultados-promo-historica")?.classList.add("hidden");
    const selDiv = document.getElementById("promo-historica-seleccionada");
    const label = document.getElementById("promo-historica-label");
    if (label) label.textContent = `${nombre} (${codigo}) — ${new Date(fecha + "T12:00:00").toLocaleDateString("es-CL",{day:"numeric",month:"long",year:"numeric"})}`;
    if (selDiv) selDiv.classList.remove("hidden");
    const inp = document.getElementById("busq_promo_historica");
    if (inp) inp.value = "";
  }

  function limpiarPromoHistorica() {
    promoHistoricaSeleccionada = null;
    document.getElementById("promo-historica-seleccionada")?.classList.add("hidden");
  }

  window.toggleConvalidacion = toggleConvalidacion;
  window.buscarPromoHistorica = buscarPromoHistorica;
  window.seleccionarPromoHistorica = seleccionarPromoHistorica;
  window.limpiarPromoHistorica = limpiarPromoHistorica;

  function validarProfesional() {
    const tipoCursoEl = document.querySelector('input[name="tipo_curso"]:checked');
    const tipo = getTipoProfesional(tipoCursoEl?.value ?? "");
    const fechaNac = document.getElementById("fecha_nacimiento")?.value ?? "";
    const licencia = document.getElementById("licencia_actual")?.value ?? "";
    const fechaLic = document.getElementById("fecha_licencia")?.value ?? "";

    const edadProfAlert = document.getElementById("edad-prof-alert");
    const edadProfOk = document.getElementById("edad-prof-ok");
    const edadProfLabel = document.getElementById("edad-prof-label");
    const licAlert = document.getElementById("licencia-alert");
    const licAlertMsg = document.getElementById("licencia-alert-msg");
    const licAlertDetail = document.getElementById("licencia-alert-detail");
    const licOk = document.getElementById("licencia-ok");
    const licOkMsg = document.getElementById("licencia-ok-msg");

    edadProfAlert?.classList.add("hidden");
    edadProfOk?.classList.add("hidden");
    licAlert?.classList.add("hidden");
    licOk?.classList.add("hidden");

    profEdadValida = true;
    profLicenciaValida = true;

    // Validar edad
    if (fechaNac) {
      const hoy = new Date();
      const nacDate = new Date(fechaNac);
      const edad = Math.floor((hoy - nacDate) / (365.25 * 24 * 60 * 60 * 1000));
      const edadMin = (tipo === "A2" || tipo === "A4") ? 20 : 21;
      if (edad < edadMin) {
        profEdadValida = false;
        edadProfAlert?.classList.remove("hidden");
      } else {
        edadProfOk?.classList.remove("hidden");
        if (edadProfLabel) edadProfLabel.textContent = `${edad} años — Edad válida para ${tipo} (mínimo ${edadMin})`;
      }
    }

    // Validar licencia
    if (licencia && fechaLic) {
      const hoy = new Date();
      const emision = new Date(fechaLic);
      const aniosLic = (hoy - emision) / (365.25 * 24 * 60 * 60 * 1000);

      let licOkFlag = false;
      let detalle = "";

      if (tipo === "A2" || tipo === "A4") {
        // Requiere licencia B con antigüedad > 2 años
        if (licencia === "B" && aniosLic >= 2) {
          licOkFlag = true;
          if (licOkMsg) licOkMsg.textContent = `Licencia B válida (${Math.floor(aniosLic)} años de antigüedad)`;
        } else if (licencia !== "B") {
          detalle = `${tipo} requiere licencia Clase B vigente.`;
        } else {
          detalle = `Licencia B debe tener al menos 2 años de antigüedad (tiene ${(aniosLic).toFixed(1)} años).`;
        }
      } else if (tipo === "A3" || tipo === "A5") {
        // Requiere A2 o A4 con antigüedad > 2 años
        if ((licencia === "A2" || licencia === "A4") && aniosLic >= 2) {
          licOkFlag = true;
          if (licOkMsg) licOkMsg.textContent = `Licencia ${licencia} válida (${Math.floor(aniosLic)} años de antigüedad)`;
        } else if (licencia !== "A2" && licencia !== "A4") {
          detalle = `${tipo} requiere licencia A2 o A4 previa.`;
        } else {
          detalle = `Licencia ${licencia} debe tener al menos 2 años de antigüedad.`;
        }
      }

      if (licOkFlag) {
        licOk?.classList.remove("hidden");
        profLicenciaValida = true;
      } else {
        if (licAlertMsg) licAlertMsg.textContent = "⛔ Licencia no válida para este curso";
        if (licAlertDetail) licAlertDetail.textContent = detalle;
        licAlert?.classList.remove("hidden");
        profLicenciaValida = false;
      }
    }

    checkButtonState();
  }

  function checkButtonState() {
    const btnSiguiente = document.querySelector('[onclick="nextStep()"]');
    if (!btnSiguiente) return;
    let ok = edadValida;
    if (esProfesional) ok = ok && profEdadValida && profLicenciaValida;
    btnSiguiente.disabled = !ok;
    btnSiguiente.classList.toggle("opacity-50", !ok);
    btnSiguiente.classList.toggle("pointer-events-none", !ok);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const senceWrap = document.getElementById("sence-codigo-wrap");
    const profSection = document.getElementById("profesional-section");
    const cursosProfWrap = document.getElementById("curso-prof-wrap");
    const radios = document.querySelectorAll(
      'input[name="tipo_curso"].curso-radio',
    );

    function toggleSence() {
      const checked = document.querySelector(
        'input[name="tipo_curso"]:checked',
      );
      const val = checked?.getAttribute("value") ?? "";
      if (senceWrap) senceWrap.classList.toggle("hidden", val !== "clase_b_sence");

      // RF-062: mostrar sección profesional
      esProfesional = isProfesional(val);
      if (profSection) profSection.classList.toggle("hidden", !esProfesional);
      if (esProfesional) validarProfesional();
      toggleConvalidacionWrap();
      checkButtonState();
    }
    radios.forEach((r) => r.addEventListener("change", toggleSence));
    toggleSence();

    // Disparar validación profesional al cambiar licencia o fecha de licencia
    document.getElementById("licencia_actual")?.addEventListener("change", validarProfesional);
    document.getElementById("fecha_licencia")?.addEventListener("change", validarProfesional);

    // Selector de promoción → poblar cursos
    document.getElementById("promocion_id")?.addEventListener("change", function() {
      const opt = this.options[this.selectedIndex];
      const cursosRaw = opt?.getAttribute("data-cursos") ?? "[]";
      const cursosSelect = document.getElementById("curso_profesional");
      if (!cursosSelect) return;

      let cursos = [];
      try { cursos = JSON.parse(cursosRaw); } catch(_) {}

      // Filtrar por cupo < 25
      const tipoCursoEl = document.querySelector('input[name="tipo_curso"]:checked');
      const tipo = getTipoProfesional(tipoCursoEl?.value ?? "");
      const licencia = document.getElementById("licencia_actual")?.value ?? "";

      // Determinar tipos compatibles
      let tiposCompatibles = [];
      if (tipo === "A2" || tipo === "A4") tiposCompatibles = [tipo];
      else if (tipo === "A3" || tipo === "A5") tiposCompatibles = [tipo];

      cursosSelect.innerHTML = '<option value="">Seleccionar curso...</option>';
      cursos
        .filter(c => c.alumnosInscritos < c.maxAlumnos && tiposCompatibles.includes(c.tipo))
        .forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.tipo;
          opt.textContent = `Curso ${c.tipo} — ${c.relatorNombre} (${c.alumnosInscritos}/${c.maxAlumnos} alumnos)`;
          cursosSelect.appendChild(opt);
        });

      const hayCursos = cursosSelect.options.length > 1;
      cursosProfWrap?.classList.toggle("hidden", !this.value || !hayCursos);
    });

    // RF-082.1: Age detection
    const fechaNacInput = document.getElementById("fecha_nacimiento");
    const alertBlock = document.getElementById("edad-alert-block");
    const alertMenor = document.getElementById("edad-alert-menor");
    const alertOk = document.getElementById("edad-alert-ok");
    const edadLabel = document.getElementById("edad-label");
    const btnSiguiente = document.querySelector('[onclick="nextStep()"]');

    fechaNacInput?.addEventListener("change", () => {
      const fechaNac = new Date(fechaNacInput.value);
      if (isNaN(fechaNac.getTime())) return;
      const hoy = new Date();
      const edad = Math.floor(
        (hoy.getTime() - fechaNac.getTime()) / (365.25 * 24 * 60 * 60 * 1000),
      );

      alertBlock?.classList.add("hidden");
      alertMenor?.classList.add("hidden");
      alertOk?.classList.add("hidden");

      if (edad < 17) {
        alertBlock?.classList.remove("hidden");
        edadValida = false;
        esMenor = false;
      } else if (edad === 17) {
        alertMenor?.classList.remove("hidden");
        edadValida = true;
        esMenor = true;
      } else {
        alertOk?.classList.remove("hidden");
        if (edadLabel)
          edadLabel.textContent = `${edad} años — Mayor de edad, sin restricciones`;
        edadValida = true;
        esMenor = false;
      }
      if (esProfesional) validarProfesional();
      checkButtonState();
    });
  });
  function nextStep() {
    const form = document.getElementById("matriculaForm");
    if (!form) return;
    if (!edadValida) {
      alert("⛔ No se puede continuar: el alumno debe tener al menos 17 años.");
      return;
    }
    if (esProfesional && (!profEdadValida || !profLicenciaValida)) {
      alert("⛔ No se puede continuar: el alumno no cumple los requisitos para la clase profesional seleccionada.");
      return;
    }
    const tipoCursoEl = document.querySelector(
      'input[name="tipo_curso"]:checked',
    );
    const tipoCurso =
      (tipoCursoEl && "value" in tipoCursoEl ? tipoCursoEl.value : null) ??
      "clase_b";
    const codigoSenceEl = document.querySelector('select[name="codigo_sence"]');
    const codigoSence =
      (codigoSenceEl && "value" in codigoSenceEl ? codigoSenceEl.value : "") ??
      "";
    const formData = {
      nombres: document.getElementById("nombres").value ?? "",
      apellidos: document.getElementById("apellidos").value ?? "",
      rut: document.getElementById("rut").value ?? "",
      fechaNacimiento: document.getElementById("fecha_nacimiento").value ?? "",
      email: document.getElementById("email").value ?? "",
      telefono: document.getElementById("telefono").value ?? "",
      direccion: document.getElementById("direccion").value ?? "",
      region: document.querySelector('select[name="region"]').value ?? "",
      comuna: document.querySelector('select[name="comuna"]').value ?? "",
      tipo_curso: tipoCurso,
      codigo_sence: tipoCurso === "clase_b_sence" ? codigoSence : "",
      sexo: document.querySelector('select[name="sexo"]').value ?? "",
      esMenor: esMenor,
      esProfesional: esProfesional,
      licencia_actual: esProfesional ? (document.getElementById("licencia_actual")?.value ?? "") : "",
      fecha_licencia: esProfesional ? (document.getElementById("fecha_licencia")?.value ?? "") : "",
      promocion_id: esProfesional ? (document.getElementById("promocion_id")?.value ?? "") : "",
      curso_profesional: esProfesional ? (document.getElementById("curso_profesional")?.value ?? "") : "",
      convalidacion: convalidacionActiva,
      convalidacion_promo_historica: convalidacionActiva && promoHistoricaSeleccionada ? promoHistoricaSeleccionada : null,
      convalidacion_libro: convalidacionActiva ? (document.querySelector('input[name="libro_convalidacion"]:checked')?.value ?? "libro_1") : null,
      timestamp: new Date().toISOString(),
    };
    sessionStorage.setItem("matricula_paso1", JSON.stringify(formData));
    window.location.href =
      (typeof basePath !== "undefined" ? basePath : "") +
      "/matricula/nueva/paso-2";
  }
  window.nextStep = nextStep;
</script>

<style>
  select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }
  input[type="radio"] {
    appearance: none;
    width: 1rem;
    height: 1rem;
    border: 2px solid rgb(209, 213, 219);
    border-radius: 50%;
    position: relative;
    cursor: pointer;
    flex-shrink: 0;
  }
  input[type="radio"]:checked {
    border-color: rgb(17, 24, 39);
    background-color: rgb(17, 24, 39);
  }
  input[type="radio"]:checked::before {
    content: "";
    position: absolute;
    inset: 2px;
    background-color: white;
    border-radius: 50%;
  }
</style>
