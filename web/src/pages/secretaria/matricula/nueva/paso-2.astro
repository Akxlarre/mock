---
import DashboardLayout from "../../../../layouts/DashboardLayout.astro";
import Card from "../../../../components/ui/Card.astro";
import Button from "../../../../components/ui/Button.astro";
import MatriculaWizardSteps from "../../../../components/matricula/MatriculaWizardSteps.astro";
import { ESCUELA_ACTUAL } from "../../../../lib/mockData";
import { BOOKINGS } from "../../../../lib/mockBookings";
import { getAvailableBlocksForDay } from "../../../../lib/mockAvailability";

// Data simulada Promociones
const promocionesDisponibles = [
  {
    id: 1,
    nombre: "Promoción Marzo 2026",
    tipo: "A3",
    estado: "planificada",
    totalAlumnos: 15,
    maxAlumnos: 25,
  },
  {
    id: 2,
    nombre: "Promoción Abril 2026",
    tipo: "A3",
    estado: "planificada",
    totalAlumnos: 5,
    maxAlumnos: 25,
  },
  {
    id: 3,
    nombre: "Promoción Express Verano",
    tipo: "A2",
    estado: "en_curso",
    totalAlumnos: 24,
    maxAlumnos: 25,
  },
  {
    id: 101,
    nombre: "Promoción Enero 2025",
    tipo: "A3",
    estado: "finalizada",
    totalAlumnos: 25,
    maxAlumnos: 25,
  },
  {
    id: 102,
    nombre: "Promoción Diciembre 2024",
    tipo: "A2",
    estado: "finalizada",
    totalAlumnos: 20,
    maxAlumnos: 25,
  },
];

// --- Calendario Clase B: bloques con estados de conflicto ---
type EstadoSlot = "disponible" | "instructor_ocupado" | "vehiculo_ocupado" | "ocupado" | "no_habil";

interface SlotCalendario {
  fecha: string;
  diaNombre: string;
  hora: string;
  horaRango: string;
  estado: EstadoSlot;
  cupos?: number;
  instructorNombre?: string;
  vehiculoPatente?: string;
}

// Semana demo: Lun 3 - Vie 7 Feb 2026 (incluye bookings reales del mock)
const nombresDias = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];
const lunesDemo = new Date(2026, 1, 3); // Feb 3, 2026

// Bookings programados para la semana (scheduled)
const bookingsSemana = BOOKINGS.filter(
  (b) => b.status === "scheduled" && b.bookingDate >= "2026-02-03" && b.bookingDate <= "2026-02-07"
);

// Generar slots de la semana (Lun-Vie, 08:00-18:00)
const slotsCalendario: SlotCalendario[] = [];
for (let d = 0; d < 5; d++) {
  const fecha = new Date(lunesDemo);
  fecha.setDate(lunesDemo.getDate() + d);
  const fechaStr = fecha.toISOString().split("T")[0];
  const diaNombre = nombresDias[fecha.getDay()];
  const bloques = getAvailableBlocksForDay(fecha.getDay());

  for (const hora of bloques) {
    const horaFin = `${(parseInt(hora.split(":")[0]) + 1).toString().padStart(2, "0")}:00`;
    const horaRango = `${hora} - ${horaFin}`;

    // Buscar si hay booking en este slot
    const booking = bookingsSemana.find(
      (b) => b.bookingDate === fechaStr && b.startTime === hora
    );

    // Mock: algunos slots con conflictos parciales para demostración visual
    const hash = (fechaStr + hora).split("").reduce((a, c) => a + c.charCodeAt(0), 0);

    let estado: EstadoSlot = "disponible";
    let cupos = 1;
    let instructorNombre: string | undefined;
    let vehiculoPatente: string | undefined;

    if (booking) {
      estado = "ocupado";
      instructorNombre = booking.instructorName;
      vehiculoPatente = booking.vehiclePatente;
    } else if (hash % 9 === 1) {
      estado = "instructor_ocupado";
      instructorNombre = "Carlos Rojas";
    } else if (hash % 9 === 2) {
      estado = "vehiculo_ocupado";
      vehiculoPatente = "ABC-123";
    } else if (hash % 9 === 3) {
      estado = "ocupado";
      instructorNombre = "Ana Martínez";
      vehiculoPatente = "XYZ-789";
    } else if (hash % 9 === 4) {
      estado = "no_habil";
    } else if (hash % 7 === 0) {
      estado = "disponible";
      cupos = 2;
    }

    slotsCalendario.push({
      fecha: fechaStr,
      diaNombre,
      hora,
      horaRango,
      estado,
      cupos,
      instructorNombre,
      vehiculoPatente,
    });
  }
}

// Agrupar por día para el grid: { "Lun": [...], "Mar": [...], ... }
const slotsPorDia = slotsCalendario.reduce(
  (acc, s) => {
    if (!acc[s.diaNombre]) acc[s.diaNombre] = [];
    acc[s.diaNombre].push(s);
    return acc;
  },
  {} as Record<string, SlotCalendario[]>
);

const diasOrden = ["Lun", "Mar", "Mié", "Jue", "Vie"];
const horasUnicas = [...new Set(slotsCalendario.map((s) => s.horaRango))].sort();

const basePath = "/secretaria";
---

<DashboardLayout
  title="Matrícula - Asignación Académica"
  escuela={ESCUELA_ACTUAL}
  userRole="secretaria"
>
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Nueva Matrícula</h1>
    <p class="text-secondary mt-1">
      Paso 2: Configuración y Asignación Académica
    </p>
  </div>

  <MatriculaWizardSteps pasoActual={2} basePath={basePath} />

  <Card class="max-w-4xl mx-auto">
    <!-- Resumen del Alumno -->
    <div class="bg-blue-50 -mx-6 -mt-6 px-6 py-4 border-b border-gray-200 mb-6">
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold"
        >
          <span id="resumen-iniciales">--</span>
        </div>
        <div>
          <h3 class="font-medium text-gray-900" id="resumen-nombre">
            Cargando datos...
          </h3>
          <p class="text-sm text-secondary" id="resumen-curso">
            Determinando curso...
          </p>
        </div>
      </div>
    </div>

    <div class="p-6">
      <!-- VISTA PROFESIONAL: Asignación a Cohorte -->
      <div id="vista-profesional" class="hidden space-y-6">
        <div class="p-4 rounded-lg bg-purple-50 border border-purple-200">
          <h4 class="font-semibold text-purple-900 mb-1">
            Asignación a Promoción (Cohorte)
          </h4>
          <p class="text-sm text-purple-700">
            El alumno de curso profesional debe ser asignado obligatoriamente a
            un grupo de estudios.
          </p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1.5">
            Seleccione Promoción Abierta <span class="text-red-500">*</span>
          </label>
          <select
            id="select-promocion"
            class="h-11 px-4 w-full text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1"
            onchange="validarPasoProfesional()"
          >
            <option value="">Seleccionar...</option>
            <optgroup label="Promociones Abiertas">
              {
                promocionesDisponibles
                  .filter((p) => p.estado !== "finalizada")
                  .map((p) => (
                    <option value={String(p.id)}>
                      {p.nombre} ({p.tipo}) — {p.totalAlumnos}/{p.maxAlumnos}{" "}
                      Inscritos
                    </option>
                  ))
              }
            </optgroup>
            <optgroup label="Promociones Pasadas (Registro Histórico)">
              {
                promocionesDisponibles
                  .filter((p) => p.estado === "finalizada")
                  .map((p) => (
                    <option value={String(p.id)}>
                      {p.nombre} ({p.tipo}) — FINALIZADA
                    </option>
                  ))
              }
            </optgroup>
          </select>
        </div>
      </div>

      <!-- VISTA SINGULAR: Sin gestión de horario -->
      <div id="vista-singular" class="hidden space-y-6">
        <div class="p-4 rounded-lg bg-teal-50 border border-teal-200">
          <div class="flex items-start gap-3">
            <svg
              class="w-6 h-6 text-teal-600 shrink-0 mt-0.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"
              ></path>
            </svg>
            <div>
              <h4 class="font-semibold text-teal-900 mb-1">
                Curso Singular — Sin asignación de horario
              </h4>
              <p class="text-sm text-teal-800">
                Los <strong>Cursos Singulares</strong> no requieren asignación de
                horario individual ni inscripción en una promoción. El alumno queda
                inscrito directamente en el curso seleccionado.
              </p>
            </div>
          </div>
        </div>

        <div class="bg-gray-50 rounded-lg p-5 border border-gray-200">
          <h5 class="text-sm font-semibold text-gray-900 mb-3">
            ¿Qué incluye este tipo de alumno?
          </h5>
          <ul class="space-y-2 text-sm text-gray-700">
            <li class="flex items-center gap-2">
              <svg
                class="w-4 h-4 text-teal-600 shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"></path>
              </svg>
              Pago total al inicio del curso
            </li>
            <li class="flex items-center gap-2">
              <svg
                class="w-4 h-4 text-teal-600 shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"></path>
              </svg>
              Foto de carnet para identificación
            </li>
            <li class="flex items-center gap-2">
              <svg
                class="w-4 h-4 text-teal-600 shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"></path>
              </svg>
              Diploma, certificado y carnet al finalizar
            </li>
            <li class="flex items-center gap-2">
              <svg
                class="w-4 h-4 text-gray-400 shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              <span class="text-gray-400"
                >Sin asignación de instructor ni vehículo</span
              >
            </li>
            <li class="flex items-center gap-2">
              <svg
                class="w-4 h-4 text-gray-400 shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              <span class="text-gray-400"
                >Sin calendario de clases prácticas</span
              >
            </li>
          </ul>
        </div>
      </div>

      <!-- VISTA CLASE B: Agendamiento de Calendario Base -->
      <div id="vista-clase-b" class="hidden space-y-6">
        <div class="p-4 rounded-lg bg-green-50 border border-green-200">
          <h4 class="font-semibold text-green-900 mb-1">
            Reserva de Horario Inicial
          </h4>
          <p class="text-sm text-green-800">
            Selecciona el primer bloque disponible para el alumno. Su cupo y
            progreso se anclará a este horario.
          </p>
        </div>

        <!-- Leyenda de conflictos -->
        <div class="flex flex-wrap gap-4 p-3 bg-gray-50 rounded-lg border border-gray-200 text-xs">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-green-200 border border-green-400 shrink-0"></div>
            <span class="text-gray-700">Disponible</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-amber-200 border border-amber-500 shrink-0"></div>
            <span class="text-gray-700">Instructor ocupado</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-red-200 border border-red-500 shrink-0"></div>
            <span class="text-gray-700">Vehículo ocupado</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-red-300 border border-red-600 shrink-0"></div>
            <span class="text-gray-700">Instructor y vehículo ocupados</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-gray-200 border border-gray-300 shrink-0"></div>
            <span class="text-gray-500">No hábil</span>
          </div>
        </div>

        <div class="border border-gray-200 rounded-xl overflow-hidden">
          <!-- Cabecera Calendario -->
          <div
            class="bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-200"
          >
            <h3 class="font-medium text-gray-900">
              Agenda Semanal — Disponibilidad en tiempo real
            </h3>
            <div class="flex space-x-2">
              <button type="button" class="text-gray-500 hover:text-gray-900 px-2 py-1" aria-label="Semana anterior">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <span class="text-sm font-semibold text-gray-700 py-1">3 - 7 Feb 2026</span>
              <button type="button" class="text-gray-500 hover:text-gray-900 px-2 py-1" aria-label="Siguiente semana">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Body Calendario: grid por hora (filas) x día (columnas) -->
          <div class="p-4 overflow-x-auto">
            <table class="w-full text-sm border-collapse">
              <thead>
                <tr>
                  <th class="text-left py-2 px-2 text-xs font-semibold text-gray-500 w-24">Hora</th>
                  {diasOrden.map((dia) => (
                    <th class="text-center py-2 px-2 text-xs font-semibold text-gray-600" key={dia}>{dia}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {horasUnicas.map((horaRango) => (
                  <tr key={horaRango}>
                    <td class="py-1 px-2 text-xs text-gray-500 font-medium align-top">{horaRango}</td>
                    {diasOrden.map((dia) => {
                      const slot = (slotsPorDia[dia] ?? []).find((s) => s.horaRango === horaRango);
                      if (!slot) return <td key={dia} class="p-1"></td>;

                      const isDisponible = slot.estado === "disponible";
                      const isInstructorOcupado = slot.estado === "instructor_ocupado";
                      const isVehiculoOcupado = slot.estado === "vehiculo_ocupado";
                      const isOcupado = slot.estado === "ocupado";
                      const isNoHabil = slot.estado === "no_habil";

                      const baseClass = "p-2 rounded min-h-[4rem] flex flex-col items-center justify-center text-center";
                      const disponClass = "border border-green-300 bg-green-50 cursor-pointer hover:bg-green-100 transition-colors";
                      const instructorClass = "border border-amber-400 bg-amber-50 cursor-not-allowed opacity-90";
                      const vehiculoClass = "border border-red-400 bg-red-50 cursor-not-allowed opacity-90";
                      const ocupadoClass = "border border-red-500 bg-red-100 cursor-not-allowed opacity-90";
                      const noHabilClass = "border border-gray-200 bg-gray-100 opacity-60";

                      const cellClass = isDisponible
                        ? `${baseClass} ${disponClass} slot-disponible`
                        : isInstructorOcupado
                          ? `${baseClass} ${instructorClass}`
                          : isVehiculoOcupado
                            ? `${baseClass} ${vehiculoClass}`
                            : isOcupado
                              ? `${baseClass} ${ocupadoClass}`
                              : `${baseClass} ${noHabilClass}`;

                      return (
                        <td key={dia} class="p-1 align-top">
                          <div
                            class={cellClass}
                            data-slot-id={slot.fecha + "_" + slot.hora}
                            data-disponible={isDisponible}
                            onclick={isDisponible ? "seleccionarHorario(this)" : undefined}
                            role={isDisponible ? "button" : undefined}
                            tabindex={isDisponible ? 0 : undefined}
                            title={
                              isInstructorOcupado
                                ? `Instructor ocupado: ${slot.instructorNombre}`
                                : isVehiculoOcupado
                                  ? `Vehículo ocupado: ${slot.vehiculoPatente}`
                                  : isOcupado
                                    ? `Instructor ${slot.instructorNombre} y vehículo ${slot.vehiculoPatente} ocupados`
                                    : isNoHabil
                                      ? "Fuera de horario"
                                      : `${slot.cupos} cupo(s) libre(s)`
                            }
                          >
                            {isDisponible && (
                              <>
                                <span class="text-green-800 font-bold text-xs">{slot.horaRango}</span>
                                <span class="bg-white text-green-700 text-[10px] px-2 py-0.5 rounded-full border border-green-300 mt-1">
                                  {slot.cupos} cupo(s)
                                </span>
                              </>
                            )}
                            {isInstructorOcupado && (
                              <>
                                <span class="text-amber-800 font-semibold text-xs">Instructor ocupado</span>
                                <span class="text-amber-700 text-[10px] mt-0.5">{slot.instructorNombre}</span>
                              </>
                            )}
                            {isVehiculoOcupado && (
                              <>
                                <span class="text-red-800 font-semibold text-xs">Vehículo ocupado</span>
                                <span class="text-red-700 text-[10px] mt-0.5">{slot.vehiculoPatente}</span>
                              </>
                            )}
                            {isOcupado && (
                              <>
                                <span class="text-red-900 font-semibold text-xs">Ocupado</span>
                                <span class="text-red-800 text-[10px] mt-0.5">
                                  {slot.instructorNombre} · {slot.vehiculoPatente}
                                </span>
                              </>
                            )}
                            {isNoHabil && (
                              <span class="text-gray-400 text-xs">No hábil</span>
                            )}
                          </div>
                        </td>
                      );
                    })}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
        <div
          id="horario-feedback"
          class="hidden p-3 rounded-lg border border-blue-200 bg-blue-50 mt-4"
        >
          <p
            class="text-sm font-semibold text-blue-800 flex items-center gap-2"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            ¡Horario reservado temporalmente para esta matrícula!
          </p>
        </div>
      </div>
    </div>

    <!-- Acciones Inferiores -->
    <div
      class="flex items-center justify-between pt-6 border-t border-gray-200 mt-8"
    >
      <Button variant="ghost" href={`${basePath}/matricula/nueva/paso-1`}>
        ← Volver atrás
      </Button>
      <Button
        id="btn-continuar"
        variant="primary"
        onClick="nextStep()"
        disabled
      >
        Guardar y continuar a Documentos →
      </Button>
    </div>
  </Card>
</DashboardLayout>

<script is:inline define:vars={{ basePath }}>
  let esProfesionalState = false;
  let esSingularState = false;
  let horarioSeleccionado = false;

  document.addEventListener("astro:page-load", () => {
    // 1. Recuperar contexto del paso 1
    const p1 = sessionStorage.getItem("matricula_paso1");
    if (!p1) {
      window.location.href = "/secretaria/matricula/nueva/paso-1";
      return;
    }

    const data = JSON.parse(p1);

    // Fallbacks of UI Texts
    const fallbackName = data.nombres || "Alumno";
    const fallbackLastName = data.apellidos || "Nuevo";

    const nameEl = document.getElementById("resumen-nombre");
    if (nameEl) nameEl.textContent = fallbackName + " " + fallbackLastName;

    const in1 = fallbackName.charAt(0).toUpperCase();
    const in2 = fallbackLastName.charAt(0).toUpperCase();
    const initEl = document.getElementById("resumen-iniciales");
    if (initEl) initEl.textContent = in1 + in2;

    esProfesionalState = data.esProfesional;
    esSingularState = data.esSingular;
    let cursoLabel = data.tipo_curso;
    if (cursoLabel === "clase_b") cursoLabel = "Clase B (Particular)";
    if (cursoLabel === "clase_b_sence")
      cursoLabel = "Clase B (Franquicia SENCE)";
    if (data.esProfesional) cursoLabel = "Curso Profesional " + data.tipo_curso;
    if (data.esSingular)
      cursoLabel = "Curso Singular — " + (data.cursoSingularNombre || "");
    const cursoEl = document.getElementById("resumen-curso");
    if (cursoEl) cursoEl.textContent = cursoLabel;

    if (esSingularState) {
      document.getElementById("vista-singular")?.classList.remove("hidden");
      // Singular no necesita selección: habilitar botón de inmediato
      const btn = document.getElementById("btn-continuar");
      if (btn) btn.disabled = false;
    } else if (esProfesionalState) {
      document.getElementById("vista-profesional")?.classList.remove("hidden");
    } else {
      document.getElementById("vista-clase-b")?.classList.remove("hidden");
    }
  });

  // Exportar Funciones UI
  window.seleccionarHorario = function (el) {
    document
      .querySelectorAll("#vista-clase-b .slot-disponible")
      .forEach((node) => {
        node.classList.remove("ring-4", "ring-blue-300", "border-blue-500");
      });

    el.classList.add("ring-4", "ring-blue-300", "border-blue-500");

    document.getElementById("horario-feedback")?.classList.remove("hidden");
    horarioSeleccionado = true;
    validarPasoFinal();
  };

  window.validarPasoProfesional = function () {
    validarPasoFinal();
  };

  // Accesibilidad: Enter/Space en slots disponibles
  document.addEventListener("astro:page-load", () => {
    document.querySelectorAll("#vista-clase-b .slot-disponible").forEach((el) => {
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          seleccionarHorario(el);
        }
      });
    });
  });

  function validarPasoFinal() {
    let ok = false;
    if (esProfesionalState) {
      const selectObj = document.getElementById("select-promocion");
      if (selectObj && selectObj.value !== "") ok = true;
    } else {
      ok = horarioSeleccionado;
    }

    const btn = document.getElementById("btn-continuar");
    if (btn) {
      btn.disabled = !ok;
    }
  }

  window.nextStep = function () {
    const p1 = sessionStorage.getItem("matricula_paso1");
    if (!p1) return;

    const data = JSON.parse(p1);

    // Inyectar contexto al alumno
    if (esSingularState) {
      data.horario_inicial_asignado = false;
    } else if (esProfesionalState) {
      data.promocion_asignada_id =
        document.getElementById("select-promocion")?.value || "";
    } else {
      data.horario_inicial_asignado = true; // Flag
    }

    sessionStorage.setItem("matricula_paso1", JSON.stringify(data));

    // Navegar al anterior paso 2: Documentación (ahora paso-3)
    window.location.href = "/secretaria/matricula/nueva/paso-3";
  };
</script>
