---
/**
 * Control de Asistencia Clase Profesional - Admin / Secretaria
 * RF-069: % asistencia teor√≠a (m√≠nimo 75%)
 * RF-070: % asistencia pr√°ctica (m√≠nimo 100%)
 * Sem√°foro: Verde (cumple), Amarillo (en l√≠mite), Rojo (reprobado)
 */
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import Card from "../../../components/ui/Card.astro";
import Button from "../../../components/ui/Button.astro";
import { PROMOCIONES } from "../../../lib/mockRelatores";

interface AlumnoAsistencia {
  id: number;
  nombre: string;
  rut: string;
  curso: "A2" | "A3" | "A4" | "A5";
  promoId: number;
  teoria: { asistidas: number; total: number; pct: number };
  practica: { asistidas: number; total: number; pct: number };
  licMedica: boolean;
  convalidacion?: boolean;
}

const ALUMNOS: AlumnoAsistencia[] = [
  // Promo 4 - Febrero I (d√≠a 11/30)
  { id:1,  nombre:"Carlos Soto Mu√±oz",       rut:"15.432.198-7", curso:"A2", promoId:4, teoria:{ asistidas:9,  total:11, pct:82  }, practica:{ asistidas:11, total:11, pct:100 }, licMedica:false },
  { id:2,  nombre:"Andrea Flores Vera",       rut:"16.789.234-5", curso:"A2", promoId:4, teoria:{ asistidas:5,  total:11, pct:45  }, practica:{ asistidas: 8, total:11, pct: 73 }, licMedica:true  },
  { id:3,  nombre:"Luis P√©rez Castro",        rut:"14.567.890-3", curso:"A2", promoId:4, teoria:{ asistidas:11, total:11, pct:100 }, practica:{ asistidas:11, total:11, pct:100 }, licMedica:false },
  { id:4,  nombre:"Mariana Torres Rojas",     rut:"17.234.567-K", curso:"A2", promoId:4, teoria:{ asistidas:3,  total:11, pct:27  }, practica:{ asistidas: 5, total:11, pct: 45 }, licMedica:false },
  { id:5,  nombre:"Roberto N√∫√±ez D√≠az",       rut:"13.456.789-1", curso:"A2", promoId:4, teoria:{ asistidas:10, total:11, pct:91  }, practica:{ asistidas:11, total:11, pct:100 }, licMedica:false },
  { id:6,  nombre:"Patricia Vargas Silva",    rut:"15.678.901-2", curso:"A2", promoId:4, teoria:{ asistidas:10, total:11, pct:91  }, practica:{ asistidas:11, total:11, pct:100 }, licMedica:false, convalidacion:true },
  { id:7,  nombre:"Jorge Morales Reyes",      rut:"16.901.234-6", curso:"A2", promoId:4, teoria:{ asistidas:9,  total:11, pct:82  }, practica:{ asistidas:10, total:11, pct: 91 }, licMedica:false },
  { id:8,  nombre:"Felipe Aguilar Pino",      rut:"17.345.678-9", curso:"A3", promoId:4, teoria:{ asistidas:11, total:11, pct:100 }, practica:{ asistidas:11, total:11, pct:100 }, licMedica:false },
  { id:9,  nombre:"Diego Meza Fuentes",       rut:"16.456.789-0", curso:"A3", promoId:4, teoria:{ asistidas:9,  total:11, pct:82  }, practica:{ asistidas:11, total:11, pct:100 }, licMedica:false },
  { id:10, nombre:"Camila Rojas Vega",        rut:"18.123.456-7", curso:"A3", promoId:4, teoria:{ asistidas:1,  total:11, pct:  9 }, practica:{ asistidas: 2, total:11, pct: 18 }, licMedica:true  },
  // Promo 3 - Enero II (d√≠a 23/30)
  { id:11, nombre:"Mar√≠a Fern√°ndez L√≥pez",    rut:"14.876.543-1", curso:"A2", promoId:3, teoria:{ asistidas:20, total:23, pct:87  }, practica:{ asistidas:23, total:23, pct:100 }, licMedica:false },
  { id:12, nombre:"Nicol√°s Castillo Vera",    rut:"15.987.654-2", curso:"A2", promoId:3, teoria:{ asistidas:19, total:23, pct:83  }, practica:{ asistidas:22, total:23, pct: 96 }, licMedica:true, convalidacion:true },
  { id:13, nombre:"Javiera Soto Romero",      rut:"17.111.222-3", curso:"A2", promoId:3, teoria:{ asistidas:23, total:23, pct:100 }, practica:{ asistidas:23, total:23, pct:100 }, licMedica:false },
  // Promo 2 - Enero I (d√≠a 28/30)
  { id:14, nombre:"Rodrigo Ahumada Pino",     rut:"12.345.678-1", curso:"A4", promoId:2, teoria:{ asistidas:24, total:28, pct:86  }, practica:{ asistidas:28, total:28, pct:100 }, licMedica:false, convalidacion:true },
  { id:15, nombre:"Daniela Espinoza Mora",    rut:"13.456.789-2", curso:"A4", promoId:2, teoria:{ asistidas:15, total:28, pct:54  }, practica:{ asistidas:25, total:28, pct: 89 }, licMedica:false },
  { id:16, nombre:"Hugo Contreras Leiva",     rut:"14.567.890-4", curso:"A4", promoId:2, teoria:{ asistidas:27, total:28, pct:96  }, practica:{ asistidas:28, total:28, pct:100 }, licMedica:false },
];

function getSemaforo(teoriaP: number, practicaP: number) {
  if (teoriaP >= 75 && practicaP >= 100) {
    return { label:"Cumple",    color:"green",  cls:"bg-green-100 text-green-800 ring-1 ring-green-200",   dot:"bg-green-500" };
  } else if (teoriaP < 50 || practicaP < 70) {
    return { label:"Reprobado", color:"red",    cls:"bg-red-100 text-red-800 ring-1 ring-red-200",         dot:"bg-red-500"   };
  } else {
    return { label:"En riesgo", color:"yellow", cls:"bg-yellow-100 text-yellow-800 ring-1 ring-yellow-200",dot:"bg-yellow-400"};
  }
}

// Stats
const cumple    = ALUMNOS.filter(a => a.teoria.pct>=75 && a.practica.pct>=100).length;
const enRiesgo  = ALUMNOS.filter(a => { const ok=a.teoria.pct>=75&&a.practica.pct>=100; const rep=a.teoria.pct<50||a.practica.pct<70; return !ok&&!rep; }).length;
const reprobado = ALUMNOS.filter(a => a.teoria.pct<50||a.practica.pct<70).length;

const promosActivas = PROMOCIONES.filter(p => p.estado==="en_curso");
---

<DashboardLayout title="Asistencia Clase Profesional" userRole="secretaria">
  <!-- Breadcrumb -->
  <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
    <a href="/secretaria/dashboard" class="hover:text-gray-900">Inicio</a>
    <span>/</span>
    <a href="/secretaria/asistencia" class="hover:text-gray-900">Asistencia</a>
    <span>/</span>
    <span class="text-gray-900 font-medium">Clase Profesional</span>
  </div>

  <div class="flex flex-wrap items-start justify-between gap-4 mb-8">
    <div>
      <h1 class="text-3xl font-semibold text-gray-900 tracking-tight text-balance">
        Asistencia Clase Profesional
      </h1>
      <p class="text-gray-600 mt-1">Sem√°foro de cumplimiento por alumno ¬∑ RF-069 / RF-070</p>
    </div>
    <div class="flex gap-2">
      <Button variant="secondary" href="/secretaria/asistencia">Ver Clase B</Button>
    </div>
  </div>

  <!-- KPIs sem√°foro -->
  <div class="grid sm:grid-cols-4 gap-4 mb-8">
    <div class="border border-gray-200 shadow-sm rounded-lg bg-white p-5">
      <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Total alumnos</p>
      <p class="text-3xl font-bold text-gray-900 mt-1">{ALUMNOS.length}</p>
      <p class="text-xs text-gray-400 mt-1">en 3 promociones activas</p>
    </div>
    <div class="border border-green-200 shadow-sm rounded-lg bg-green-50 p-5">
      <div class="flex items-center gap-2 mb-1">
        <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
        <p class="text-xs font-semibold text-green-700 uppercase tracking-wide">Cumple</p>
      </div>
      <p class="text-3xl font-bold text-green-900">{cumple}</p>
      <p class="text-xs text-green-600 mt-1">Teor√≠a ‚â•75% y Pr√°ctica 100%</p>
    </div>
    <div class="border border-yellow-200 shadow-sm rounded-lg bg-yellow-50 p-5">
      <div class="flex items-center gap-2 mb-1">
        <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
        <p class="text-xs font-semibold text-yellow-700 uppercase tracking-wide">En riesgo</p>
      </div>
      <p class="text-3xl font-bold text-yellow-900">{enRiesgo}</p>
      <p class="text-xs text-yellow-600 mt-1">Necesitan atenci√≥n</p>
    </div>
    <div class="border border-red-200 shadow-sm rounded-lg bg-red-50 p-5">
      <div class="flex items-center gap-2 mb-1">
        <span class="w-3 h-3 bg-red-500 rounded-full"></span>
        <p class="text-xs font-semibold text-red-700 uppercase tracking-wide">Reprobado</p>
      </div>
      <p class="text-3xl font-bold text-red-900">{reprobado}</p>
      <p class="text-xs text-red-600 mt-1">Asistencia cr√≠tica</p>
    </div>
  </div>

  <!-- Reglas de cumplimiento -->
  <div class="grid sm:grid-cols-2 gap-4 mb-6">
    <div class="border border-blue-200 bg-blue-50 rounded-lg p-4 flex gap-3">
      <svg class="w-5 h-5 text-blue-600 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.069A1 1 0 0121 8.869v6.262a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
      </svg>
      <div class="text-sm">
        <p class="font-semibold text-blue-900">Teor√≠a (RF-069)</p>
        <p class="text-blue-700">M√≠nimo <strong>75%</strong> de asistencia. Zoom marcado manualmente por relator. Firma presencial 1√ó semana.</p>
      </div>
    </div>
    <div class="border border-green-200 bg-green-50 rounded-lg p-4 flex gap-3">
      <svg class="w-5 h-5 text-green-600 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
      </svg>
      <div class="text-sm">
        <p class="font-semibold text-green-900">Pr√°ctica (RF-070)</p>
        <p class="text-green-700">Asistencia <strong>100%</strong> obligatoria. Solo licencia m√©dica justifica ausencias (RF-071).</p>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="flex flex-wrap gap-3 mb-4">
    <select id="filtro-promo" onchange="filtrar()" class="h-9 px-3 text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900">
      <option value="">Todas las promociones</option>
      {promosActivas.map(p => <option value={String(p.id)}>{p.nombre} (D√≠a {p.diaActual}/30)</option>)}
    </select>
    <select id="filtro-curso" onchange="filtrar()" class="h-9 px-3 text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900">
      <option value="">Todos los cursos</option>
      {["A2","A3","A4","A5"].map(c => <option value={c}>{c}</option>)}
    </select>
    <select id="filtro-semaforo" onchange="filtrar()" class="h-9 px-3 text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900">
      <option value="">Todos los estados</option>
      <option value="green">‚úÖ Cumple</option>
      <option value="yellow">‚ö†Ô∏è En riesgo</option>
      <option value="red">üî¥ Reprobado</option>
    </select>
    <button onclick="limpiar()" class="h-9 px-3 text-sm text-gray-600 bg-white border border-gray-200 rounded-md hover:bg-gray-50 shadow-sm">
      Limpiar
    </button>
    <div class="flex-1"></div>
    <span id="contador-visible" class="self-center text-sm text-gray-500">{ALUMNOS.length} alumnos</span>
  </div>

  <!-- Tabla -->
  <div class="border border-gray-200 rounded-xl bg-white shadow-sm overflow-hidden">
    <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
      <div class="grid grid-cols-12 gap-2 text-xs font-semibold text-gray-500 uppercase tracking-wide">
        <div class="col-span-3">Alumno</div>
        <div class="col-span-1 text-center">Curso</div>
        <div class="col-span-2 text-center">Promoci√≥n</div>
        <div class="col-span-2 text-center">
          <span class="text-blue-600">Teor√≠a</span>
          <span class="text-gray-400 font-normal ml-1">‚â•75%</span>
        </div>
        <div class="col-span-2 text-center">
          <span class="text-green-600">Pr√°ctica</span>
          <span class="text-gray-400 font-normal ml-1">100%</span>
        </div>
        <div class="col-span-2 text-center">Sem√°foro</div>
      </div>
    </div>
    <div id="tabla-alumnos" class="divide-y divide-gray-100">
      {ALUMNOS.map((a) => {
        const sem = getSemaforo(a.teoria.pct, a.practica.pct);
        const promo = PROMOCIONES.find(p => p.id === a.promoId);
        const promoShort = (promo?.nombre ?? "‚Äî").replace("Promoci√≥n ","");
        return (
          <div
            class="alumno-fila grid grid-cols-12 gap-2 items-center px-4 py-3 hover:bg-gray-50 transition-colors"
            data-promo={a.promoId}
            data-curso={a.curso}
            data-semaforo={sem.color}
          >
            <!-- Nombre -->
            <div class="col-span-3 flex items-center gap-3 min-w-0">
              <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-xs font-bold text-gray-600 shrink-0">
                {a.nombre.charAt(0)}
              </div>
              <div class="min-w-0">
                <p class="text-sm font-medium text-gray-900 truncate">{a.nombre}</p>
                <div class="flex items-center gap-1">
                  <p class="text-xs text-gray-400">{a.rut}</p>
                  {a.convalidacion && (
                    <span class="inline-flex items-center px-1 py-0 rounded text-xs bg-purple-100 text-purple-700 font-medium">Conv.</span>
                  )}
                  {a.licMedica && (
                    <span class="inline-flex items-center px-1 py-0 rounded text-xs bg-blue-100 text-blue-700 font-medium">LM</span>
                  )}
                </div>
              </div>
            </div>
            <!-- Curso badge -->
            <div class="col-span-1 flex justify-center">
              <span class="w-8 h-8 bg-gray-900 text-white text-xs font-bold rounded-md flex items-center justify-center">
                {a.curso}
              </span>
            </div>
            <!-- Promo -->
            <div class="col-span-2 text-center">
              <p class="text-xs text-gray-600">{promoShort}</p>
              <p class="text-xs text-gray-400">D√≠a {promo?.diaActual ?? "?"}/30</p>
            </div>
            <!-- Barra teor√≠a -->
            <div class="col-span-2 px-1">
              <div class="flex justify-between text-xs mb-0.5">
                <span class={`font-semibold ${a.teoria.pct>=75?"text-green-700":a.teoria.pct>=60?"text-yellow-600":"text-red-600"}`}>{a.teoria.pct}%</span>
                <span class="text-gray-400">{a.teoria.asistidas}/{a.teoria.total}</span>
              </div>
              <div class="relative w-full bg-gray-100 rounded-full h-2">
                <div class={`h-2 rounded-full transition-all ${a.teoria.pct>=75?"bg-green-500":a.teoria.pct>=60?"bg-yellow-400":"bg-red-500"}`} style={`width:${a.teoria.pct}%`}></div>
                <!-- Marcador 75% -->
                <div class="absolute top-0 bottom-0 border-l-2 border-dashed border-orange-400 opacity-70" style="left:75%"></div>
              </div>
            </div>
            <!-- Barra pr√°ctica -->
            <div class="col-span-2 px-1">
              <div class="flex justify-between text-xs mb-0.5">
                <span class={`font-semibold ${a.practica.pct>=100?"text-green-700":a.practica.pct>=90?"text-yellow-600":"text-red-600"}`}>{a.practica.pct}%</span>
                <span class="text-gray-400">{a.practica.asistidas}/{a.practica.total}</span>
              </div>
              <div class="w-full bg-gray-100 rounded-full h-2">
                <div class={`h-2 rounded-full transition-all ${a.practica.pct>=100?"bg-green-500":a.practica.pct>=90?"bg-yellow-400":"bg-red-500"}`} style={`width:${Math.min(a.practica.pct,100)}%`}></div>
              </div>
            </div>
            <!-- Sem√°foro -->
            <div class="col-span-2 flex justify-center items-center gap-2">
              <div class="flex flex-col gap-1 shrink-0">
                <div class={`w-3 h-3 rounded-full ${sem.color==="green"?"bg-green-500":"bg-gray-200"}`}></div>
                <div class={`w-3 h-3 rounded-full ${sem.color==="yellow"?"bg-yellow-400":"bg-gray-200"}`}></div>
                <div class={`w-3 h-3 rounded-full ${sem.color==="red"?"bg-red-500":"bg-gray-200"}`}></div>
              </div>
              <span class={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ${sem.cls}`}>
                {sem.label}
              </span>
            </div>
          </div>
        );
      })}
    </div>
  </div>

  <!-- Leyenda -->
  <div class="mt-4 flex flex-wrap gap-4 text-xs text-gray-500">
    <div class="flex items-center gap-1.5">
      <span class="w-3 h-3 rounded-full bg-green-500 inline-block"></span>
      <strong>Cumple:</strong> Teor√≠a ‚â•75% y Pr√°ctica 100%
    </div>
    <div class="flex items-center gap-1.5">
      <span class="w-3 h-3 rounded-full bg-yellow-400 inline-block"></span>
      <strong>En riesgo:</strong> Teor√≠a 50-74% o Pr√°ctica 70-99%
    </div>
    <div class="flex items-center gap-1.5">
      <span class="w-3 h-3 rounded-full bg-red-500 inline-block"></span>
      <strong>Reprobado:</strong> Teor√≠a &lt;50% o Pr√°ctica &lt;70%
    </div>
    <span class="inline-flex items-center px-1.5 py-0.5 rounded bg-purple-100 text-purple-700 font-medium">Conv.</span>
    Convalidaci√≥n activa
    <span class="inline-flex items-center px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 font-medium">LM</span>
    Licencia m√©dica
  </div>
</DashboardLayout>

<script>
  function filtrar() {
    const promo   = (document.getElementById("filtro-promo")     as HTMLSelectElement).value;
    const curso   = (document.getElementById("filtro-curso")     as HTMLSelectElement).value;
    const semaf   = (document.getElementById("filtro-semaforo")  as HTMLSelectElement).value;
    let visible = 0;
    document.querySelectorAll<HTMLElement>(".alumno-fila").forEach(row => {
      const ok =
        (!promo || row.dataset.promo  === promo) &&
        (!curso || row.dataset.curso  === curso) &&
        (!semaf || row.dataset.semaforo === semaf);
      row.style.display = ok ? "" : "none";
      if (ok) visible++;
    });
    const cnt = document.getElementById("contador-visible");
    if (cnt) cnt.textContent = `${visible} alumno${visible !== 1 ? "s" : ""}`;
  }

  function limpiar() {
    (["filtro-promo","filtro-curso","filtro-semaforo"] as const).forEach(id => {
      (document.getElementById(id) as HTMLSelectElement).value = "";
    });
    filtrar();
  }

  (window as any).filtrar  = filtrar;
  (window as any).limpiar  = limpiar;
</script>

<style>
  select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
</style>
