---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';

// Get current date for the default value
const today = new Date().toISOString().split('T')[0];

const billetes = [
  { valor: 20000, label: 'Billetes de $20.000' },
  { valor: 10000, label: 'Billetes de $10.000' },
  { valor: 5000, label: 'Billetes de $5.000' },
  { valor: 2000, label: 'Billetes de $2.000' },
  { valor: 1000, label: 'Billetes de $1.000' },
];

const monedas = [
  { valor: 500, label: 'Monedas de $500' },
  { valor: 100, label: 'Monedas de $100' },
  { valor: 50, label: 'Monedas de $50' },
  { valor: 10, label: 'Monedas de $10' },
];
---

<DashboardLayout title="Cuadratura Diaria - Contabilidad">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center gap-2 text-sm text-slate-500 mb-2">
      <a href="/dashboard" class="hover:text-slate-900">Inicio</a>
      <span>/</span>
      <span class="text-slate-900 font-medium">Contabilidad</span>
      <span>/</span>
      <span class="text-slate-900 font-medium">Cuadratura Diaria</span>
    </div>

    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Cuadratura Diaria</h1>
        <span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 text-sm font-semibold rounded-full border border-green-200 shadow-sm">
          <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
          Caja Abierta
        </span>
      </div>

      <div class="flex items-center gap-3">
        <div class="relative">
          <input 
            type="date" 
            value={today}
            class="h-10 px-4 pr-10 border border-slate-300 rounded-lg bg-white text-slate-700 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-medium"
          />
        </div>
        <Button href="/contabilidad/cuadratura/historial" variant="secondary" class="shadow-sm bg-white hover:bg-slate-50 text-slate-700 border-slate-300">
          <svg class="w-4 h-4 mr-2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Ver Historial
        </Button>
        <Button variant="secondary" class="shadow-sm bg-white hover:bg-slate-50 text-slate-700 border-slate-300">
          <span class="mr-2"></span>
          Exportar a Excel
        </Button>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="flex flex-col xl:flex-row gap-6 mb-32">
    <!-- Columna Izquierda: Ingresos (60%) -->
    <div class="xl:w-3/5 space-y-6">
      <Card class="shadow-sm border border-slate-200">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-lg font-bold text-slate-800">Registro de Ingresos</h2>
            <p class="text-sm text-slate-500">Detalle de boletas y pagos recibidos en el d铆a.</p>
          </div>
          <Button variant="primary" id="btn-add-ingreso" class="shadow-sm bg-indigo-600 hover:bg-indigo-700 text-white">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Agregar Ingreso
          </Button>
        </div>

        <div class="overflow-x-auto border border-slate-200 rounded-lg">
          <table class="w-full text-left text-sm text-slate-600">
            <thead class="bg-slate-50 text-slate-700 font-semibold border-b border-slate-200 uppercase text-xs tracking-wider">
              <tr>
                <th class="px-4 py-3">N掳 Boleta</th>
                <th class="px-4 py-3">Glosa / Alumno</th>
                <th class="px-3 py-3 text-right">Clase B</th>
                <th class="px-3 py-3 text-right">Clase A</th>
                <th class="px-3 py-3 text-right">Sensom.</th>
                <th class="px-3 py-3 text-right">Otros</th>
                <th class="px-4 py-3 text-right font-bold">Total</th>
                <th class="px-3 py-3 w-10"></th>
              </tr>
            </thead>
            <tbody id="ingresos-tbody" class="divide-y divide-slate-100">
              <!-- Filas din谩micas de ingresos -->
              <tr class="hover:bg-slate-50 transition-colors ingreso-row">
                <td class="px-4 py-2"><input type="text" class="w-full text-sm border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1" value="10254" placeholder="N掳" /></td>
                <td class="px-4 py-2"><input type="text" class="w-full text-sm border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1" value="Juan P茅rez - Curso Completo" placeholder="Descripci贸n" /></td>
                <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="150000" /></td>
                <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="0" /></td>
                <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="0" /></td>
                <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="0" /></td>
                <td class="px-4 py-2 text-right font-bold text-slate-800 row-total">$150.000</td>
                <td class="px-3 py-2 text-center">
                  <button class="text-slate-400 hover:text-red-500 transition-colors btn-delete-row" title="Eliminar fila">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                  </button>
                </td>
              </tr>
              <tr class="hover:bg-slate-50 transition-colors ingreso-row">
                <td class="px-4 py-2"><input type="text" class="w-full text-sm border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1" value="10255" placeholder="N掳" /></td>
                <td class="px-4 py-2"><input type="text" class="w-full text-sm border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1" value="Mar铆a Silva - Examen Sensom茅trico" placeholder="Descripci贸n" /></td>
                <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="0" /></td>
                <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="0" /></td>
                <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="15000" /></td>
                <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="0" /></td>
                <td class="px-4 py-2 text-right font-bold text-slate-800 row-total">$15.000</td>
                <td class="px-3 py-2 text-center">
                  <button class="text-slate-400 hover:text-red-500 transition-colors btn-delete-row" title="Eliminar fila">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                  </button>
                </td>
              </tr>
            </tbody>
            <tfoot class="bg-indigo-50 border-t border-indigo-100 text-indigo-900 font-bold">
              <tr>
                <td colspan="6" class="px-4 py-3 text-right">TOTAL INGRESOS DEL DA:</td>
                <td class="px-4 py-3 text-right text-lg" id="total-ingresos-display">$165.000</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </Card>
    </div>

    <!-- Columna Derecha: Egresos y Arqueo (40%) -->
    <div class="xl:w-2/5 space-y-6">
      
      <!-- Secci贸n Egresos -->
      <Card class="shadow-sm border border-slate-200">
         <div class="flex justify-between items-center mb-4">
          <div>
            <h2 class="text-lg font-bold text-slate-800">Egresos / Retiros</h2>
          </div>
          <Button variant="secondary" id="btn-add-egreso" class="text-sm px-3 py-1.5 h-auto bg-white border-slate-300">
            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            Egreso
          </Button>
        </div>
        
        <div class="overflow-x-auto border border-slate-200 rounded-lg">
          <table class="w-full text-left text-sm text-slate-600">
            <thead class="bg-slate-50 text-slate-700 font-semibold border-b border-slate-200 text-xs">
              <tr>
                <th class="px-3 py-2">Glosa / Motivo</th>
                <th class="px-3 py-2 text-right w-32">Monto</th>
                <th class="px-2 py-2 w-10"></th>
              </tr>
            </thead>
            <tbody id="egresos-tbody" class="divide-y divide-slate-100">
              <tr class="hover:bg-slate-50 transition-colors egreso-row">
                <td class="px-3 py-2"><input type="text" class="w-full text-sm border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1" value="Compra insumos oficina" placeholder="Motivo" /></td>
                <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-egreso-val" value="10000" /></td>
                <td class="px-2 py-2 text-center">
                  <button class="text-slate-400 hover:text-red-500 transition-colors btn-delete-row" title="Eliminar fila">
                    <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                  </button>
                </td>
              </tr>
            </tbody>
            <tfoot class="bg-orange-50 border-t border-orange-100 text-orange-900 font-bold">
              <tr>
                <td class="px-3 py-2 text-right text-xs">TOTAL EGRESOS:</td>
                <td class="px-3 py-2 text-right" id="total-egresos-display">$10.000</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </Card>

      <!-- Secci贸n Arqueo de Caja -->
      <Card class="shadow-sm border border-slate-200 border-t-4 border-t-indigo-500">
        <div class="mb-4">
          <h2 class="text-lg font-bold text-slate-800">Arqueo de Caja F铆sica</h2>
          <p class="text-sm text-slate-500">Ingrese la cantidad de billetes y monedas.</p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <!-- Billetes -->
          <div>
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Billetes</h3>
            <div class="space-y-2">
              {billetes.map((b) => (
                <div class="flex items-center justify-between text-sm">
                  <span class="text-slate-600 font-medium whitespace-nowrap">{b.label}</span>
                  <div class="flex items-center gap-2">
                    <span class="text-slate-400">x</span>
                    <input 
                      type="number" 
                      min="0" 
                      class="w-16 h-8 text-right border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 input-arqueo" 
                      data-valor={b.valor}
                      placeholder="0"
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>

          <!-- Monedas -->
          <div>
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Monedas</h3>
            <div class="space-y-2">
              {monedas.map((m) => (
                <div class="flex items-center justify-between text-sm">
                   <span class="text-slate-600 font-medium whitespace-nowrap">{m.label}</span>
                  <div class="flex items-center gap-2">
                    <span class="text-slate-400">x</span>
                    <input 
                      type="number" 
                      min="0" 
                      class="w-16 h-8 text-right border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 input-arqueo" 
                      data-valor={m.valor}
                      placeholder="0"
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        <!-- Diferencia Justificada -->
        <div class="mt-6 pt-4 border-t border-slate-200 hidden" id="panel-justificacion">
          <label class="block text-sm font-semibold text-orange-700 mb-1">Justificaci贸n del descuadre</label>
          <textarea 
            class="w-full border-orange-200 bg-orange-50 rounded-lg p-2 text-sm focus:ring-orange-500 focus:border-orange-500" 
            rows="2" 
            placeholder="Ingrese el motivo de la diferencia en caja..."
            id="input-justificacion"
          ></textarea>
        </div>
      </Card>
      
    </div>
  </div>

  <!-- STICKY FOOTER (Resumen de Cuadratura y Bot贸n Cierre) -->
  <div class="fixed bottom-0 left-0 right-0 lg:left-64 bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] p-4 lg:p-6 z-40 transition-all duration-300">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-6">
      
      <!-- Totales panel -->
      <div class="flex flex-wrap items-center gap-6 md:gap-10 grow">
        <div>
          <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Ingresos Sistema</p>
          <p class="text-2xl font-black text-indigo-700 font-mono" id="footer-ingresos">$0</p>
        </div>
        <div class="text-slate-300 text-3xl font-light">-</div>
        <div>
          <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Egresos Sistema</p>
          <p class="text-2xl font-black text-orange-600 font-mono" id="footer-egresos">$0</p>
        </div>
        <div class="text-slate-300 text-3xl font-light">=</div>
        <div class="bg-slate-50 px-4 py-2 rounded-lg border border-slate-200">
           <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Debe Haber en Caja</p>
           <p class="text-2xl font-black text-slate-800 font-mono" id="footer-saldo">$0</p>
        </div>
      </div>

      <!-- Efectivo y Diferencia -->
      <div class="flex items-center gap-6 border-l border-slate-200 pl-6">
        <div>
          <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Efectivo Arqueo</p>
          <p class="text-2xl font-black text-emerald-600 font-mono" id="footer-efectivo">$0</p>
        </div>
        
        <div class="text-right min-w-[120px]">
          <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Diferencia</p>
          <p class="text-3xl font-black font-mono" id="footer-diferencia">$0</p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center gap-3">
        <button 
          id="btn-cerrar-caja"
          class="h-14 px-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center gap-2 text-lg disabled:bg-slate-300 disabled:shadow-none"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          Cerrar Caja y Guardar
        </button>
      </div>

    </div>
  </div>

</DashboardLayout>

<script>
  // Script para manejar la l贸gica de la cuadratura en el cliente
  document.addEventListener('astro:page-load', () => {
    // Referencias al DOM
    const ingresosTbody = document.getElementById('ingresos-tbody');
    const egresosTbody = document.getElementById('egresos-tbody');
    
    const btnAddIngreso = document.getElementById('btn-add-ingreso');
    const btnAddEgreso = document.getElementById('btn-add-egreso');
    const btnCerrarCaja = document.getElementById('btn-cerrar-caja') as HTMLButtonElement;
    
    const panelJustificacion = document.getElementById('panel-justificacion');
    const inputJustificacion = document.getElementById('input-justificacion') as HTMLTextAreaElement;

    const formatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });

    function parseMonto(val: string): number {
      const num = parseInt(val, 10);
      return isNaN(num) ? 0 : num;
    }

    function formatMonto(monto: number): string {
      return formatter.format(monto);
    }

    function recalculate() {
      // 1. Sumar ingresos
      let totalIngresos = 0;
      if (ingresosTbody) {
        ingresosTbody.querySelectorAll('tr.ingreso-row').forEach(row => {
          let rowTotal = 0;
          row.querySelectorAll('.input-ingreso-val').forEach((input: any) => {
            rowTotal += parseMonto(input.value);
          });
          const rowTotalDisplay = row.querySelector('.row-total');
          if (rowTotalDisplay) rowTotalDisplay.textContent = formatMonto(rowTotal);
          totalIngresos += rowTotal;
        });
      }
      
      // 2. Sumar egresos
      let totalEgresos = 0;
      if (egresosTbody) {
        egresosTbody.querySelectorAll('.input-egreso-val').forEach((input: any) => {
          totalEgresos += parseMonto(input.value);
        });
      }

      // 3. Sumar arqueo
      let totalArqueo = 0;
      document.querySelectorAll('.input-arqueo').forEach((input: any) => {
        const cant = parseMonto(input.value);
        const valor = parseInt(input.dataset.valor, 10);
        totalArqueo += cant * valor;
      });

      // 4. C谩lculos finales
      const saldoEsperado = totalIngresos - totalEgresos;
      const diferencia = totalArqueo - saldoEsperado;

      // 5. Actualizar DOM
      const updateEl = (id: string, val: number) => {
        const el = document.getElementById(id);
        if (el) el.textContent = formatMonto(val);
      };

      updateEl('total-ingresos-display', totalIngresos);
      updateEl('total-egresos-display', totalEgresos);
      
      updateEl('footer-ingresos', totalIngresos);
      updateEl('footer-egresos', totalEgresos);
      updateEl('footer-saldo', saldoEsperado);
      updateEl('footer-efectivo', totalArqueo);
      
      const elDiferencia = document.getElementById('footer-diferencia');
      if (elDiferencia) {
        elDiferencia.textContent = formatMonto(diferencia);
        elDiferencia.className = `text-3xl font-black font-mono ${
          diferencia === 0 ? 'text-emerald-600' : 'text-red-500'
        }`;
      }

      // L贸gica de validaci贸n para el bot贸n "Cerrar Caja"
      if (diferencia !== 0) {
        panelJustificacion?.classList.remove('hidden');
        if (inputJustificacion && inputJustificacion.value.trim().length > 5) {
          btnCerrarCaja.disabled = false;
        } else {
          btnCerrarCaja.disabled = true;
        }
      } else {
        panelJustificacion?.classList.add('hidden');
        btnCerrarCaja.disabled = false;
      }
    }

    // Event Delegation para inputs num茅ricos
    document.addEventListener('input', (e: Event) => {
      const target = e.target as HTMLElement;
      if (
        target.classList.contains('input-ingreso-val') ||
        target.classList.contains('input-egreso-val') ||
        target.classList.contains('input-arqueo') ||
        target.id === 'input-justificacion'
      ) {
        recalculate();
      }
    });

    // Event Delegation para eliminar filas
    document.addEventListener('click', (e: Event) => {
      const target = e.target as HTMLElement;
      const deleteBtn = target.closest('.btn-delete-row');
      if (deleteBtn) {
        const row = deleteBtn.closest('tr');
        if (row) {
          row.remove();
          recalculate();
        }
      }
    });

    // Agregar nueva fila de ingreso
    btnAddIngreso?.addEventListener('click', () => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-slate-50 transition-colors ingreso-row';
      tr.innerHTML = `
        <td class="px-4 py-2"><input type="text" class="w-full text-sm border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1" placeholder="N掳" /></td>
        <td class="px-4 py-2"><input type="text" class="w-full text-sm border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1" placeholder="Descripci贸n" /></td>
        <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="0" /></td>
        <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="0" /></td>
        <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="0" /></td>
        <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-ingreso-val" value="0" /></td>
        <td class="px-4 py-2 text-right font-bold text-slate-800 row-total">$0</td>
        <td class="px-3 py-2 text-center">
          <button class="text-slate-400 hover:text-red-500 transition-colors btn-delete-row" title="Eliminar fila">
            <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
          </button>
        </td>
      `;
      ingresosTbody?.appendChild(tr);
    });

    // Agregar nueva fila de egreso
    btnAddEgreso?.addEventListener('click', () => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-slate-50 transition-colors egreso-row';
      tr.innerHTML = `
        <td class="px-3 py-2"><input type="text" class="w-full text-sm border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1" placeholder="Motivo" /></td>
        <td class="px-3 py-2"><input type="number" class="w-full text-sm text-right border-slate-200 rounded focus:ring-indigo-500 focus:border-indigo-500 px-2 py-1 input-egreso-val" value="0" /></td>
        <td class="px-2 py-2 text-center">
          <button class="text-slate-400 hover:text-red-500 transition-colors btn-delete-row" title="Eliminar fila">
            <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </td>
      `;
      egresosTbody?.appendChild(tr);
    });

    // Acci贸n final de cierre
    btnCerrarCaja?.addEventListener('click', () => {
      // Simular guardado
      const oldText = btnCerrarCaja.innerHTML;
      btnCerrarCaja.innerHTML = `
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Guardando...
      `;
      btnCerrarCaja.disabled = true;

      setTimeout(() => {
        alert('Caja cerrada con 茅xito.');
        window.location.href = '/dashboard';
      }, 1500);
    });

    // Init calc
    recalculate();
  });
</script>
