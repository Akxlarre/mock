---
/**
 * Crear Instructor Clase B - RF-041
 * Formulario con información personal, licencia, vehículo y disponibilidad
 */
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import Card from "../../components/ui/Card.astro";
import Input from "../../components/ui/Input.astro";
import Button from "../../components/ui/Button.astro";
import VehicleSelector from "../../components/admin/VehicleSelector.astro";
import { ESCUELA_ACTUAL } from "../../lib/mockData";
---

<DashboardLayout
  title="Crear Instructor - Escuela de Conductores"
  escuela={ESCUELA_ACTUAL}
>
  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-center gap-2 text-sm text-secondary mb-2">
      <a href="/dashboard" class="hover:text-gray-900">Inicio</a>
      <span>/</span>
      <a href="/instructores" class="hover:text-gray-900">Instructores</a>
      <span>/</span>
      <span class="text-gray-900 font-medium">Crear instructor</span>
    </div>
    <h1 class="text-3xl font-semibold text-gray-900 tracking-tight">
      Crear instructor Clase B
    </h1>
    <p class="text-secondary mt-1">
      Registro de instructor con información personal, licencia y vehículo asignado
    </p>
  </div>

  <div class="grid lg:grid-cols-3 gap-6">
    <!-- Formulario Principal -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Información Personal -->
      <Card>
        <h2 class="text-lg font-semibold text-gray-900 mb-6">
          Información Personal
        </h2>
        <form
          id="createInstructorForm"
          class="space-y-5"
          action="/instructores/1"
          method="get"
        >
          <!-- Nombre -->
          <Input
            label="Nombre completo"
            name="nombre"
            placeholder="Carlos Rojas Pérez"
            required
          />

          <!-- RUT -->
          <div class="w-full">
            <label
              class="block text-sm font-medium text-gray-700 mb-1.5"
              for="rut"
            >
              RUT *
            </label>
            <div class="relative">
              <input
                type="text"
                id="rut"
                name="rut"
                placeholder="12.345.678-9"
                required
                maxlength="12"
                class="h-11 px-4 w-full text-sm bg-white rounded-md border border-gray-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-900 placeholder:text-gray-400"
              />
              <span
                id="rutStatus"
                class="absolute right-3 top-1/2 -translate-y-1/2 text-sm hidden"
              ></span>
            </div>
            <p
              id="rutError"
              class="text-red-600 text-sm mt-1.5 hidden"
              role="alert"></p>
            <p id="rutSuccess" class="text-green-600 text-sm mt-1.5 hidden">
            </p>
          </div>

          <!-- Email -->
          <Input
            label="Correo electrónico"
            name="email"
            type="email"
            placeholder="carlos.rojas@autoescuela.cl"
            required
          />

          <!-- Teléfono -->
          <Input
            label="Teléfono"
            name="telefono"
            type="tel"
            placeholder="+56 9 8765 4321"
            required
          />
        </form>
      </Card>

      <!-- Información de Licencia (RF-041) -->
      <Card>
        <h2 class="text-lg font-semibold text-gray-900 mb-6">
          Información de Licencia
        </h2>
        <div class="space-y-5">
          <!-- Clase de Licencia -->
          <div class="w-full">
            <label
              class="block text-sm font-medium text-gray-700 mb-1.5"
              for="licencia_clase"
            >
              Clase de licencia *
            </label>
            <select
              id="licencia_clase"
              name="licencia_clase"
              required
              class="h-11 px-4 w-full text-sm bg-white rounded-md border border-gray-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-900 appearance-none"
              style="background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27 stroke=%27%236B7280%27%3E%3Cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%272%27 d=%27M19 9l-7 7-7-7%27%3E%3C/path%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem;"
            >
              <option value="">Seleccione clase</option>
              <option value="B">Clase B (Automóviles)</option>
              <option value="A2">Clase A2 (Taxi básico)</option>
              <option value="A3">Clase A3 (Ambulancia)</option>
              <option value="A4">Clase A4 (Buses)</option>
              <option value="A5">Clase A5 (Camiones)</option>
            </select>
          </div>

          <!-- Fecha de Vencimiento -->
          <div class="w-full">
            <label
              class="block text-sm font-medium text-gray-700 mb-1.5"
              for="licencia_vencimiento"
            >
              Fecha de vencimiento *
            </label>
            <input
              type="date"
              id="licencia_vencimiento"
              name="licencia_vencimiento"
              required
              class="h-11 px-4 w-full text-sm bg-white rounded-md border border-gray-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-900"
            />
            <p
              id="licenciaError"
              class="text-red-600 text-sm mt-1.5 hidden"
              role="alert"></p>
            <p
              id="licenciaWarning"
              class="text-yellow-700 text-sm mt-1.5 hidden"
            >
            </p>
            <p id="licenciaSuccess" class="text-green-600 text-sm mt-1.5 hidden"
            ></p>
          </div>

          <!-- Badge de estado (auto-calculado) -->
          <div id="licenciaEstado" class="hidden">
            <label
              class="block text-sm font-medium text-gray-700 mb-1.5"
            >
              Estado de validación
            </label>
            <span id="estadoBadge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium">
            </span>
          </div>
        </div>
      </Card>

      <!-- Asignación de Vehículo y Tipo -->
      <Card>
        <h2 class="text-lg font-semibold text-gray-900 mb-6">
          Asignación
        </h2>
        <div class="space-y-5">
          <!-- Tipo de Instructor -->
          <div class="w-full">
            <label
              class="block text-sm font-medium text-gray-700 mb-1.5"
              for="tipo"
            >
              Tipo de instructor *
            </label>
            <select
              id="tipo"
              name="tipo"
              required
              class="h-11 px-4 w-full text-sm bg-white rounded-md border border-gray-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-900 appearance-none"
              style="background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27 stroke=%27%236B7280%27%3E%3Cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%272%27 d=%27M19 9l-7 7-7-7%27%3E%3C/path%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem;"
            >
              <option value="">Seleccione tipo</option>
              <option value="practico">Práctico</option>
              <option value="teorico">Teórico</option>
              <option value="ambos">Ambos (Teórico y Práctico)</option>
            </select>
          </div>

          <!-- Vehículo Asignado (RF-045) -->
          <VehicleSelector label="Vehículo asignado" name="vehiculo" />

          <!-- Botones -->
          <div class="flex gap-3 pt-4 border-t border-gray-200">
            <a
              href="/instructores"
              class="inline-flex items-center justify-center h-11 px-4 text-sm font-medium rounded-md bg-white border border-gray-300 text-gray-900 hover:bg-gray-50 hover:border-gray-400 shadow-sm transition-all duration-200"
            >
              Cancelar
            </a>
            <Button type="submit" variant="primary" form="createInstructorForm">
              <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"
                ></path>
              </svg>
              Crear instructor
            </Button>
          </div>
        </div>
      </Card>
    </div>

    <!-- Sidebar Info -->
    <div class="space-y-4">
      <!-- Campos Obligatorios -->
      <Card class="bg-gray-50 border-gray-200">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">
          Campos obligatorios
        </h3>
        <ul class="space-y-2 text-xs text-gray-700">
          <li class="flex items-center gap-2">
            <span class="w-1.5 h-1.5 bg-gray-900 rounded-full shrink-0"></span>
            Nombre completo
          </li>
          <li class="flex items-center gap-2">
            <span class="w-1.5 h-1.5 bg-gray-900 rounded-full shrink-0"></span>
            RUT válido (Módulo 11)
          </li>
          <li class="flex items-center gap-2">
            <span class="w-1.5 h-1.5 bg-gray-900 rounded-full shrink-0"></span>
            Email y teléfono
          </li>
          <li class="flex items-center gap-2">
            <span class="w-1.5 h-1.5 bg-gray-900 rounded-full shrink-0"></span>
            Clase de licencia
          </li>
          <li class="flex items-center gap-2">
            <span class="w-1.5 h-1.5 bg-gray-900 rounded-full shrink-0"></span>
            Fecha vencimiento licencia
          </li>
          <li class="flex items-center gap-2">
            <span class="w-1.5 h-1.5 bg-gray-900 rounded-full shrink-0"></span>
            Tipo de instructor
          </li>
        </ul>
      </Card>

      <!-- Info Validación Licencia -->
      <Card>
        <h3 class="text-sm font-semibold text-gray-900 mb-3">
          Validación de licencia
        </h3>
        <div class="space-y-3 text-xs text-gray-700">
          <div class="flex items-start gap-2">
            <svg
              class="w-4 h-4 text-green-600 shrink-0 mt-0.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>Vigente: más de 30 días para vencer</span>
          </div>
          <div class="flex items-start gap-2">
            <svg
              class="w-4 h-4 text-yellow-600 shrink-0 mt-0.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              ></path>
            </svg>
            <span>Por vencer: menos de 30 días</span>
          </div>
          <div class="flex items-start gap-2">
            <svg
              class="w-4 h-4 text-red-600 shrink-0 mt-0.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            <span>Vencida: no se puede registrar</span>
          </div>
        </div>
      </Card>

      <!-- Info Asignación Vehículo -->
      <Card class="bg-blue-50 border-blue-200">
        <h3 class="text-sm font-semibold text-blue-900 mb-3">
          Asignación de vehículo
        </h3>
        <p class="text-xs text-blue-800 leading-relaxed">
          El vehículo es opcional al crear el instructor. Puedes asignarlo más
          tarde desde el perfil del instructor o la gestión de flota.
        </p>
      </Card>
    </div>
  </div>
</DashboardLayout>

<script>
  // ===== VALIDACIÓN RUT (reutilizado) =====
  const rutInput = document.getElementById("rut") as HTMLInputElement;
  const rutError = document.getElementById("rutError");
  const rutSuccess = document.getElementById("rutSuccess");
  const rutStatus = document.getElementById("rutStatus");

  rutInput?.addEventListener("input", () => {
    let value = rutInput.value.replace(/[^0-9kK-]/g, "");

    // Auto-formato: XX.XXX.XXX-X
    const clean = value.replace(/\./g, "").replace(/-/g, "");
    if (clean.length > 1) {
      const body = clean.slice(0, -1);
      const dv = clean.slice(-1);
      const formatted = body.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      value = `${formatted}-${dv}`;
    }
    rutInput.value = value;

    // Feedback visual simulado
    if (rutError && rutSuccess && rutStatus) {
      if (value.length >= 11) {
        if (value === "11.111.111-1") {
          rutError.textContent = "Este RUT ya está registrado en el sistema";
          rutError.classList.remove("hidden");
          rutSuccess.classList.add("hidden");
          rutStatus.textContent = "✗";
          rutStatus.className =
            "absolute right-3 top-1/2 -translate-y-1/2 text-sm text-red-500";
          rutInput.classList.add("border-red-300");
          rutInput.classList.remove("border-green-300", "border-gray-300");
        } else {
          rutSuccess.textContent = "✓ RUT válido y disponible";
          rutSuccess.classList.remove("hidden");
          rutError.classList.add("hidden");
          rutStatus.textContent = "✓";
          rutStatus.className =
            "absolute right-3 top-1/2 -translate-y-1/2 text-sm text-green-500";
          rutInput.classList.add("border-green-300");
          rutInput.classList.remove("border-red-300", "border-gray-300");
        }
      } else if (value.length > 0 && value.length < 11) {
        rutError.textContent = "Formato incompleto (ej: 12.345.678-9)";
        rutError.classList.remove("hidden");
        rutSuccess.classList.add("hidden");
        rutStatus.textContent = "";
        rutStatus.className =
          "absolute right-3 top-1/2 -translate-y-1/2 text-sm hidden";
        rutInput.classList.remove("border-green-300", "border-red-300");
        rutInput.classList.add("border-gray-300");
      } else {
        rutError.classList.add("hidden");
        rutSuccess.classList.add("hidden");
        rutStatus.className =
          "absolute right-3 top-1/2 -translate-y-1/2 text-sm hidden";
        rutInput.classList.remove("border-green-300", "border-red-300");
        rutInput.classList.add("border-gray-300");
      }
    }
  });

  // ===== VALIDACIÓN FECHA LICENCIA (RF-041) =====
  const licenciaInput = document.getElementById(
    "licencia_vencimiento"
  ) as HTMLInputElement;
  const licenciaError = document.getElementById("licenciaError");
  const licenciaWarning = document.getElementById("licenciaWarning");
  const licenciaSuccess = document.getElementById("licenciaSuccess");
  const licenciaEstado = document.getElementById("licenciaEstado");
  const estadoBadge = document.getElementById("estadoBadge");

  licenciaInput?.addEventListener("change", () => {
    const selectedDate = new Date(licenciaInput.value);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const diffTime = selectedDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (licenciaError && licenciaWarning && licenciaSuccess && estadoBadge && licenciaEstado) {
      if (diffDays < 0) {
        // Licencia vencida
        licenciaError.textContent =
          "❌ Licencia vencida. No se puede registrar instructor con licencia expirada.";
        licenciaError.classList.remove("hidden");
        licenciaWarning.classList.add("hidden");
        licenciaSuccess.classList.add("hidden");

        estadoBadge.textContent = "Vencida";
        estadoBadge.className =
          "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800";
        licenciaEstado.classList.remove("hidden");
      } else if (diffDays <= 30) {
        // Por vencer (menos de 30 días)
        licenciaWarning.textContent = `⚠️ Licencia por vencer en ${diffDays} días. Considerar renovación.`;
        licenciaWarning.classList.remove("hidden");
        licenciaError.classList.add("hidden");
        licenciaSuccess.classList.add("hidden");

        estadoBadge.textContent = "Por vencer";
        estadoBadge.className =
          "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800";
        licenciaEstado.classList.remove("hidden");
      } else {
        // Vigente (más de 30 días)
        licenciaSuccess.textContent = `✓ Licencia vigente (vence en ${diffDays} días)`;
        licenciaSuccess.classList.remove("hidden");
        licenciaError.classList.add("hidden");
        licenciaWarning.classList.add("hidden");

        estadoBadge.textContent = "Vigente";
        estadoBadge.className =
          "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800";
        licenciaEstado.classList.remove("hidden");
      }
    }
  });

  // Validación de submit
  const form = document.getElementById(
    "createInstructorForm"
  ) as HTMLFormElement;
  form?.addEventListener("submit", (e) => {
    e.preventDefault();

    // Verificar licencia vencida
    const selectedDate = new Date(licenciaInput.value);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (selectedDate < today) {
      alert(
        "❌ Error de validación\n\nNo se puede registrar un instructor con licencia vencida.\n\nPor favor, ingrese una fecha de vencimiento válida."
      );
      return;
    }

    // Simular éxito
    alert(
      "✓ Instructor creado exitosamente\n\nEl instructor ha sido registrado en el sistema con todos sus datos.\n\nRedirigiendo al perfil..."
    );

    // Redirect simulado
    window.location.href = "/instructores/1";
  });
</script>
