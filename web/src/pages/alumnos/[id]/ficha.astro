---
/**
 * Ficha de Alumno - Vista Admin
 * RF-055: Dashboard de progreso con % clases pr√°cticas y te√≥ricas
 * RF-056: Historial completo de clases con notas t√©cnicas
 */
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import Card from "../../../components/ui/Card.astro";
import Button from "../../../components/ui/Button.astro";

export function getStaticPaths() {
  return [
    { params: { id: "1" } },
    { params: { id: "2" } },
    { params: { id: "3" } },
    { params: { id: "4" } },
    { params: { id: "5" } },
  ];
}

const { id } = Astro.params;

// Mock data - alumnos
const alumnos: Record<string, any> = {
  '1': {
    id: 1,
    nombre: "Mar√≠a Gonz√°lez P√©rez",
    rut: "18.234.567-8",
    email: "maria@email.cl",
    telefono: "+56 9 8765 4321",
    curso: "Clase B",
    escuela: "Autoescuela Chill√°n",
    fechaIngreso: "2026-02-01",
    estado: "active",
    instructor: "Carlos Rojas",
    matricula: "3454",
    foto: null,
  },
  '2': {
    id: 2,
    nombre: "Juan Pablo Rojas",
    rut: "19.456.789-0",
    email: "juan@email.cl",
    telefono: "+56 9 7654 3210",
    curso: "Clase B",
    escuela: "Autoescuela Chill√°n",
    fechaIngreso: "2026-02-01",
    estado: "pending_payment",
    instructor: "Ana Mart√≠nez",
    matricula: "3455",
    foto: null,
  },
  '3': {
    id: 3,
    nombre: "Ana Mart√≠nez Silva",
    rut: "17.890.123-4",
    email: "ana@email.cl",
    telefono: "+56 9 6543 2109",
    curso: "Clase B",
    escuela: "Conductores Chill√°n",
    fechaIngreso: "2026-01-30",
    estado: "pending_documents",
    instructor: "Luis Torres",
    matricula: "3456",
    foto: null,
  },
  '4': {
    id: 4,
    nombre: "Carlos Fern√°ndez",
    rut: "20.123.456-7",
    email: "carlos@email.cl",
    telefono: "+56 9 5432 1098",
    curso: "Clase B",
    escuela: "Autoescuela Chill√°n",
    fechaIngreso: "2026-01-28",
    estado: "active",
    instructor: "Carlos Rojas",
    matricula: "3457",
    foto: null,
  },
  '5': {
    id: 5,
    nombre: "Sof√≠a Vargas L√≥pez",
    rut: "18.567.890-1",
    email: "sofia@email.cl",
    telefono: "+56 9 4321 0987",
    curso: "Clase B",
    escuela: "Conductores Chill√°n",
    fechaIngreso: "2026-01-25",
    estado: "inactive",
    instructor: "Luis Torres",
    matricula: "3458",
    foto: null,
  },
};

const alumno = alumnos[id!] || alumnos['1'];

// RF-055: Progreso de clases pr√°cticas y te√≥ricas
const progresoPracticas = {
  completadas: 8,
  total: 12,
  porcentaje: 67
};

const progresoTeoricas = {
  completadas: 6,
  total: 8,
  porcentaje: 75
};

const clasesCompletas = progresoPracticas.completadas >= 12;

// RF-056: Ficha t√©cnica con las 12 clases pr√°cticas
const clasesPracticas = [
  { numero: 1, fecha: "12-01", horaInicio: "15:50", horaTermino: "16:35", kmInicio: 45120, kmFinal: 45142, observaciones: "Primera clase, reconocimiento de controles", firmaAlumno: true, firmaProfesor: true, instructor: "Carlos Rojas" },
  { numero: 2, fecha: "13-01", horaInicio: "15:50", horaTermino: "16:35", kmInicio: 45142, kmFinal: 45165, observaciones: "Pr√°ctica de arranque y detenci√≥n", firmaAlumno: true, firmaProfesor: true, instructor: "Carlos Rojas" },
  { numero: 3, fecha: "14-01", horaInicio: "15:50", horaTermino: "16:35", kmInicio: 45165, kmFinal: 45188, observaciones: "Cambios de marcha, curvas b√°sicas", firmaAlumno: true, firmaProfesor: true, instructor: "Carlos Rojas" },
  { numero: 4, fecha: "15-01", horaInicio: "15:50", horaTermino: "16:35", kmInicio: 45188, kmFinal: 45210, observaciones: "Estacionamiento paralelo", firmaAlumno: true, firmaProfesor: true, instructor: "Ana Mart√≠nez" },
  { numero: 5, fecha: "16-01", horaInicio: "15:50", horaTermino: "16:35", kmInicio: 45210, kmFinal: 45234, observaciones: "Circulaci√≥n en ciudad, se√±alizaci√≥n", firmaAlumno: true, firmaProfesor: true, instructor: "Carlos Rojas" },
  { numero: 6, fecha: "19-01", horaInicio: "15:50", horaTermino: "16:35", kmInicio: 45234, kmFinal: 45258, observaciones: "Rotondas y giros", firmaAlumno: true, firmaProfesor: true, instructor: "Luis Torres" },
  { numero: 7, fecha: "20-01", horaInicio: "15:50", horaTermino: "16:35", kmInicio: 45258, kmFinal: 45280, observaciones: "Conducci√≥n defensiva", firmaAlumno: true, firmaProfesor: true, instructor: "Ana Mart√≠nez" },
  { numero: 8, fecha: "21-01", horaInicio: "15:50", horaTermino: "16:35", kmInicio: 45280, kmFinal: 45302, observaciones: "Retroceso y maniobras", firmaAlumno: true, firmaProfesor: true, instructor: "Carlos Rojas" },
  { numero: 9, fecha: "", horaInicio: "", horaTermino: "", kmInicio: null, kmFinal: null, observaciones: "", firmaAlumno: false, firmaProfesor: false, instructor: "" },
  { numero: 10, fecha: "", horaInicio: "", horaTermino: "", kmInicio: null, kmFinal: null, observaciones: "", firmaAlumno: false, firmaProfesor: false, instructor: "" },
  { numero: 11, fecha: "", horaInicio: "", horaTermino: "", kmInicio: null, kmFinal: null, observaciones: "", firmaAlumno: false, firmaProfesor: false, instructor: "" },
  { numero: 12, fecha: "", horaInicio: "", horaTermino: "", kmInicio: null, kmFinal: null, observaciones: "", firmaAlumno: false, firmaProfesor: false, instructor: "" },
];

// RF-052: Registro de inasistencias
const inasistencias = [
  { fecha: "2026-01-20", motivo: "Enfermedad", tipo: "pr√°ctica", justificada: true },
];

// Historial de pagos mock
const historialPagos = [
  { id: 1, fecha: "2026-01-15", concepto: "Matr√≠cula", monto: 50000, metodo: "Efectivo", estado: "pagado" },
  { id: 2, fecha: "2026-01-20", concepto: "Cuota 1 de 3", monto: 100000, metodo: "Transferencia", estado: "pagado" },
  { id: 3, fecha: "2026-02-05", concepto: "Cuota 2 de 3", monto: 100000, metodo: "Efectivo", estado: "pagado" },
  { id: 4, fecha: "2026-02-20", concepto: "Cuota 3 de 3", monto: 100000, metodo: "‚Äî", estado: "pendiente" },
];

const totalPagado = historialPagos.filter(p => p.estado === 'pagado').reduce((s, p) => s + p.monto, 0);
const totalPendiente = historialPagos.filter(p => p.estado === 'pendiente').reduce((s, p) => s + p.monto, 0);

// Separar nombre para el carnet
const partesNombre = alumno.nombre.split(' ');
const nombresCarnet = partesNombre.slice(2).join(' ') || partesNombre[0];
const apellidosCarnet = partesNombre.slice(0, 2).join(' ');
---

<DashboardLayout title={`Ficha de ${alumno.nombre} - Escuela de Conductores`} userRole="admin">
  <div class="max-w-7xl mx-auto">
    <!-- Breadcrumb -->
    <div class="flex items-center gap-2 text-sm text-secondary mb-2">
      <a href="/dashboard" class="hover:text-gray-900">Inicio</a>
      <span>/</span>
      <a href="/alumnos" class="hover:text-gray-900">Alumnos</a>
      <span>/</span>
      <span class="text-gray-900 font-medium">Ficha de {alumno.nombre}</span>
    </div>

    <!-- Header -->
    <div class="flex items-start justify-between mb-6">
      <div>
        <h1 class="text-3xl font-semibold text-gray-900 tracking-tight text-balance">{alumno.nombre}</h1>
        <p class="text-secondary mt-1">{alumno.curso} ¬∑ {alumno.escuela} ¬∑ Matr√≠cula #{alumno.matricula}</p>
      </div>
      <div class="flex gap-2 flex-wrap justify-end">
        <button
          onclick="abrirCarnet()"
          class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium bg-white border border-gray-200 rounded-lg shadow-sm text-gray-900 hover:bg-gray-50 transition-colors duration-150"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" />
          </svg>
          Generar Carnet
        </button>
        <button
          onclick={clasesCompletas ? "abrirCertificado()" : "alertaCertificado()"}
          class={`inline-flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg border transition-colors duration-150 ${
            clasesCompletas
              ? "bg-white border-gray-200 shadow-sm text-gray-900 hover:bg-gray-50"
              : "bg-gray-50 border-gray-200 text-gray-400 cursor-not-allowed"
          }`}
          title={!clasesCompletas ? `Requiere 12 clases completadas (${progresoPracticas.completadas}/12)` : "Generar certificado"}
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.745 3.745 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.745 3.745 0 0 1 3.296-1.043A3.745 3.745 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.745 3.745 0 0 1 3.296 1.043 3.745 3.745 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
          </svg>
          Generar Certificado
          {!clasesCompletas && (
            <span class="text-xs font-normal text-gray-400">({progresoPracticas.completadas}/12)</span>
          )}
        </button>
        <Button href={`/alumnos/${id}/editar`} variant="secondary">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          Editar
        </Button>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6 mb-6">
      <!-- Informaci√≥n personal -->
      <Card class="lg:col-span-1">
        <!-- Foto del alumno -->
        <div class="flex items-center gap-4 mb-5 pb-5 border-b border-gray-100">
          <div class="w-16 h-16 rounded-xl bg-gray-100 border border-gray-200 flex items-center justify-center shrink-0 overflow-hidden">
            {alumno.foto ? (
              <img src={alumno.foto} alt={alumno.nombre} class="w-full h-full object-cover" />
            ) : (
              <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
              </svg>
            )}
          </div>
          <div>
            <p class="text-sm font-semibold text-gray-900 leading-tight">{alumno.nombre}</p>
            <p class="text-xs text-secondary mt-0.5">{alumno.rut}</p>
            <p class="text-xs text-secondary mt-1">Matr√≠cula <span class="font-mono font-medium text-gray-900">#{alumno.matricula}</span></p>
          </div>
        </div>

        <h3 class="text-sm font-bold text-gray-900 mb-4 uppercase tracking-wide">Informaci√≥n Personal</h3>
        <div class="space-y-3">
          <div>
            <label class="text-xs text-secondary uppercase tracking-wide">Email</label>
            <p class="text-sm font-medium text-gray-900 mt-0.5">{alumno.email}</p>
          </div>
          <div>
            <label class="text-xs text-secondary uppercase tracking-wide">Tel√©fono</label>
            <p class="text-sm font-medium text-gray-900 mt-0.5">{alumno.telefono}</p>
          </div>
          <div>
            <label class="text-xs text-secondary uppercase tracking-wide">Fecha de Ingreso</label>
            <p class="text-sm font-medium text-gray-900 mt-0.5">{alumno.fechaIngreso}</p>
          </div>
          <div>
            <label class="text-xs text-secondary uppercase tracking-wide">Instructor Asignado</label>
            <p class="text-sm font-medium text-gray-900 mt-0.5 flex items-center gap-1.5">
              <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
              </svg>
              {alumno.instructor}
            </p>
          </div>
          <div>
            <label class="text-xs text-secondary uppercase tracking-wide">Estado</label>
            <p class="text-sm font-medium text-gray-900 mt-0.5">
              <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${
                alumno.estado === 'active' ? 'bg-green-100 text-green-800 border-green-200' :
                alumno.estado === 'pending_payment' ? 'bg-orange-100 text-orange-800 border-orange-200' :
                alumno.estado === 'pending_documents' ? 'bg-blue-100 text-blue-800 border-blue-200' :
                'bg-gray-100 text-gray-800 border-gray-200'
              }`}>
                {alumno.estado === 'active' ? 'Activo' :
                 alumno.estado === 'pending_payment' ? 'Pendiente Pago' :
                 alumno.estado === 'pending_documents' ? 'Docs Pendientes' :
                 'Inactivo'}
              </span>
            </p>
          </div>
        </div>
      </Card>

      <!-- RF-055: Progreso de Clases Pr√°cticas -->
      <Card class="lg:col-span-1">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Clases Pr√°cticas</h3>
            <p class="text-xs text-secondary mt-0.5">De 12 clases requeridas</p>
          </div>
          <div class="text-right">
            <p class="text-4xl font-bold text-blue-600">{progresoPracticas.porcentaje}%</p>
          </div>
        </div>

        <!-- Barra de progreso -->
        <div class="relative w-full bg-gray-200 rounded-full h-6 mb-3">
          <div
            class="absolute inset-y-0 left-0 bg-linear-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-end px-3 transition-all duration-500"
            style={`width: ${progresoPracticas.porcentaje}%`}
          >
            <span class="text-xs font-semibold text-white">
              {progresoPracticas.completadas}/{progresoPracticas.total}
            </span>
          </div>
        </div>

        <div class="flex items-center justify-between text-sm">
          <span class="text-secondary">
            {progresoPracticas.completadas} completadas
          </span>
          <span class="font-semibold text-gray-900">
            {progresoPracticas.total - progresoPracticas.completadas} restantes
          </span>
        </div>

        {clasesCompletas && (
          <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200 flex items-center gap-2">
            <svg class="w-4 h-4 text-green-600 shrink-0" fill="currentColor" viewBox="0 0 24 24">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-xs text-green-800 font-medium">Clases completadas ‚Äî apto para certificado</p>
          </div>
        )}
      </Card>

      <!-- RF-055: Progreso de Clases Te√≥ricas -->
      <Card class="lg:col-span-1">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Clases Te√≥ricas</h3>
            <p class="text-xs text-secondary mt-0.5">De 8 clases requeridas</p>
          </div>
          <div class="text-right">
            <p class="text-4xl font-bold text-green-600">{progresoTeoricas.porcentaje}%</p>
          </div>
        </div>

        <!-- Barra de progreso -->
        <div class="relative w-full bg-gray-200 rounded-full h-6 mb-3">
          <div
            class="absolute inset-y-0 left-0 bg-linear-to-r from-green-500 to-green-600 rounded-full flex items-center justify-end px-3 transition-all duration-500"
            style={`width: ${progresoTeoricas.porcentaje}%`}
          >
            <span class="text-xs font-semibold text-white">
              {progresoTeoricas.completadas}/{progresoTeoricas.total}
            </span>
          </div>
        </div>

        <div class="flex items-center justify-between text-sm">
          <span class="text-secondary">
            {progresoTeoricas.completadas} asistidas
          </span>
          <span class="font-semibold text-gray-900">
            {progresoTeoricas.total - progresoTeoricas.completadas} restantes
          </span>
        </div>
      </Card>
    </div>

    <!-- RF-052: Registro de Inasistencias -->
    {inasistencias.length > 0 && (
      <Card class="mb-6 border-orange-200 bg-orange-50/30">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center shrink-0">
            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="text-sm font-semibold text-orange-900 mb-1">Inasistencias Registradas</h3>
            <div class="space-y-2 mt-3">
              {inasistencias.map((inasistencia) => (
                <div class="flex items-center justify-between p-2 bg-white rounded border border-orange-200">
                  <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900">{inasistencia.fecha}</p>
                    <p class="text-xs text-secondary mt-0.5">
                      <span class="capitalize">{inasistencia.tipo}</span> ‚Ä¢ {inasistencia.motivo}
                    </p>
                  </div>
                  <span class={`text-xs px-2 py-1 rounded-full ${
                    inasistencia.justificada
                      ? 'bg-blue-100 text-blue-800'
                      : 'bg-red-100 text-red-800'
                  }`}>
                    {inasistencia.justificada ? 'Justificada' : 'Sin justificar'}
                  </span>
                </div>
              ))}
            </div>
            <Button variant="ghost" class="text-orange-700 hover:bg-orange-100 text-sm mt-3" onClick="registrarInasistencia()">
              + Registrar nueva inasistencia
            </Button>
          </div>
        </div>
      </Card>
    )}

    <!-- RF-056: Ficha T√©cnica - Tabla de Clases Pr√°cticas -->
    <Card class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-xl font-semibold text-gray-900">Ficha T√©cnica - Clases Pr√°cticas</h3>
          <p class="text-sm text-secondary mt-1">Registro detallado de las 12 clases pr√°cticas</p>
        </div>
        <Button variant="secondary" class="text-sm" onClick="window.print()">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
          </svg>
          Imprimir Ficha
        </Button>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b-2 border-gray-300">
              <th class="text-left py-3 px-3 font-semibold text-gray-900">N¬∞</th>
              <th class="text-left py-3 px-3 font-semibold text-gray-900">Fecha</th>
              <th class="text-left py-3 px-3 font-semibold text-gray-900">Hora</th>
              <th class="text-left py-3 px-3 font-semibold text-gray-900">Instructor</th>
              <th class="text-right py-3 px-3 font-semibold text-gray-900">Km Inicio</th>
              <th class="text-right py-3 px-3 font-semibold text-gray-900">Km Fin</th>
              <th class="text-left py-3 px-3 font-semibold text-gray-900">Observaciones</th>
              <th class="text-center py-3 px-3 font-semibold text-gray-900">Firmas</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {clasesPracticas.map((clase) => (
              <tr class={clase.fecha ? "hover:bg-gray-50" : "bg-gray-50/50"}>
                <td class="py-3 px-3 font-medium text-gray-900">
                  Clase {clase.numero}
                </td>
                <td class="py-3 px-3 text-gray-700 font-mono text-xs">
                  {clase.fecha || '-'}
                </td>
                <td class="py-3 px-3 text-gray-700 font-mono text-xs">
                  {clase.horaInicio && clase.horaTermino ? `${clase.horaInicio}-${clase.horaTermino}` : '-'}
                </td>
                <td class="py-3 px-3 text-gray-700 text-xs">
                  {clase.instructor || '-'}
                </td>
                <td class="py-3 px-3 text-right text-gray-700 font-mono text-xs">
                  {clase.kmInicio !== null ? clase.kmInicio.toLocaleString() : '-'}
                </td>
                <td class="py-3 px-3 text-right text-gray-700 font-mono text-xs">
                  {clase.kmFinal !== null ? clase.kmFinal.toLocaleString() : '-'}
                </td>
                <td class="py-3 px-3 text-gray-700 text-xs">
                  <div class="max-w-xs">
                    {clase.observaciones || (
                      <span class="text-gray-400 italic">Pendiente</span>
                    )}
                  </div>
                </td>
                <td class="py-3 px-3">
                  <div class="flex items-center justify-center gap-1">
                    {clase.firmaAlumno ? (
                      <span title="Firmado por alumno" class="text-green-600">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      </span>
                    ) : (
                      <span title="Sin firma de alumno" class="text-gray-300">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      </span>
                    )}
                    {clase.firmaProfesor ? (
                      <span title="Firmado por instructor" class="text-blue-600">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      </span>
                    ) : (
                      <span title="Sin firma de instructor" class="text-gray-300">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      </span>
                    )}
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <div class="mt-4 p-3 bg-gray-50 rounded-lg">
        <div class="flex items-center gap-4 text-xs text-secondary">
          <div class="flex items-center gap-1">
            <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Alumno</span>
          </div>
          <div class="flex items-center gap-1">
            <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Instructor</span>
          </div>
          <span class="text-gray-400">‚Ä¢ Las firmas se registran al finalizar cada clase</span>
        </div>
      </div>
    </Card>

    <!-- Historial de Pagos -->
    <Card class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-xl font-semibold text-gray-900">Historial de Pagos</h3>
          <p class="text-sm text-secondary mt-1">Registro de cuotas y pagos del alumno</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-right">
            <p class="text-xs text-secondary">Total pagado</p>
            <p class="text-lg font-bold text-green-700">${totalPagado.toLocaleString('es-CL')}</p>
          </div>
          {totalPendiente > 0 && (
            <div class="text-right border-l border-gray-200 pl-3">
              <p class="text-xs text-secondary">Saldo pendiente</p>
              <p class="text-lg font-bold text-orange-600">${totalPendiente.toLocaleString('es-CL')}</p>
            </div>
          )}
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b-2 border-gray-300">
              <th class="text-left py-3 px-3 font-semibold text-gray-900">Fecha</th>
              <th class="text-left py-3 px-3 font-semibold text-gray-900">Concepto</th>
              <th class="text-right py-3 px-3 font-semibold text-gray-900">Monto</th>
              <th class="text-left py-3 px-3 font-semibold text-gray-900">M√©todo</th>
              <th class="text-center py-3 px-3 font-semibold text-gray-900">Estado</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {historialPagos.map((pago) => (
              <tr class="hover:bg-gray-50">
                <td class="py-3 px-3 text-gray-700 font-mono text-xs">{pago.fecha}</td>
                <td class="py-3 px-3 text-gray-900 font-medium">{pago.concepto}</td>
                <td class="py-3 px-3 text-right font-mono font-semibold text-gray-900">
                  ${pago.monto.toLocaleString('es-CL')}
                </td>
                <td class="py-3 px-3 text-gray-700 text-xs">{pago.metodo}</td>
                <td class="py-3 px-3 text-center">
                  <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${
                    pago.estado === 'pagado'
                      ? 'bg-green-100 text-green-800 border-green-200'
                      : 'bg-orange-100 text-orange-800 border-orange-200'
                  }`}>
                    {pago.estado === 'pagado' ? 'Pagado' : 'Pendiente'}
                  </span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <p class="text-xs text-secondary">
          {historialPagos.filter(p => p.estado === 'pagado').length} pagos registrados
          {totalPendiente > 0 && ` ¬∑ ${historialPagos.filter(p => p.estado === 'pendiente').length} pendiente(s)`}
        </p>
        <a href="/secretaria/pagos" class="text-xs text-blue-600 hover:text-blue-700 font-medium">
          Ver en m√≥dulo de pagos ‚Üí
        </a>
      </div>
    </Card>

    <!-- Acciones -->
    <div class="flex gap-3 mt-6">
      <Button href="/alumnos" variant="ghost">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Volver al Listado
      </Button>
    </div>
  </div>

  <!-- Modal: Carnet del Alumno -->
  <div id="modal-carnet" class="fixed inset-0 z-50 hidden items-center justify-center p-4" style="background: rgba(0,0,0,0.6);">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <!-- Modal header -->
      <div class="flex items-center justify-between p-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Carnet del Alumno</h2>
        <div class="flex items-center gap-2">
          <button
            onclick="imprimirCarnet()"
            class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            Imprimir
          </button>
          <button onclick="cerrarCarnet()" class="p-1.5 text-gray-400 hover:text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Carnet preview -->
      <div class="p-6" id="carnet-content">
        <div class="border-2 border-gray-300 rounded-lg overflow-hidden" style="font-family: Arial, sans-serif; font-size: 11px;">
          <div class="flex">
            <!-- Lado izquierdo: tabla de clases -->
            <div class="flex-1 p-4 border-r-2 border-gray-300">
              <p class="font-bold text-gray-900 mb-3 uppercase text-xs tracking-wide">V.- CLASES PR√ÅCTICAS</p>
              <table class="w-full border-collapse" style="font-size: 10px;">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="border border-gray-400 px-1.5 py-1 text-center font-bold text-gray-900 w-6">N¬∫</th>
                    <th class="border border-gray-400 px-1.5 py-1 text-center font-bold text-gray-900">D√≠a</th>
                    <th class="border border-gray-400 px-1.5 py-1 text-center font-bold text-gray-900">Hora inicio</th>
                    <th class="border border-gray-400 px-1.5 py-1 text-center font-bold text-gray-900">Hora T√©rmino</th>
                    <th class="border border-gray-400 px-1.5 py-1 text-center font-bold text-gray-900">Firma Instructor</th>
                  </tr>
                </thead>
                <tbody>
                  {clasesPracticas.map((clase) => (
                    <tr>
                      <td class="border border-gray-400 px-1.5 py-1 text-center font-bold text-gray-900">{clase.numero}</td>
                      <td class="border border-gray-400 px-1.5 py-1 text-center text-gray-900 font-mono">{clase.fecha || ''}</td>
                      <td class="border border-gray-400 px-1.5 py-1 text-center text-gray-900 font-mono">{clase.horaInicio || ''}</td>
                      <td class="border border-gray-400 px-1.5 py-1 text-center text-gray-900 font-mono">{clase.horaTermino || ''}</td>
                      <td class="border border-gray-400 px-1.5 py-1 text-center">&nbsp;</td>
                    </tr>
                  ))}
                </tbody>
              </table>

              <div class="mt-4">
                <p class="font-bold text-gray-900 mb-2 text-xs uppercase">P√°ginas web para practicar examen te√≥rico:</p>
                <p class="text-gray-600 text-xs">*https://www.educacionvial.cl/examen-interactivo.html</p>
                <p class="text-gray-600 text-xs">*https://www.conaset.cl/programa/prepara-examen-conducir/</p>
                <p class="text-gray-600 text-xs">*http://www.crosan.cl/pagina/examen/carpeta_1/478.htm</p>
              </div>
            </div>

            <!-- Lado derecho: datos del alumno -->
            <div class="w-64 p-4 flex flex-col">
              <!-- Encabezado escuela -->
              <div class="text-right mb-3">
                <p class="font-extrabold text-gray-900 text-sm uppercase tracking-tight">{alumno.escuela}</p>
                <p class="text-gray-600 italic text-xs">√∫nete a nosotros... √∫nete a la vida</p>
                <p class="text-gray-700 text-xs mt-1">CARRERA 74, FONO: 42- 2244030</p>
                <p class="text-gray-700 text-xs">conductorchillan@gmail.com</p>
              </div>

              <!-- Logo + foto -->
              <div class="flex items-start justify-between mb-4">
                <!-- Logo placeholder -->
                <div class="w-16 h-16 bg-gray-200 rounded border border-gray-300 flex items-center justify-center">
                  <span class="text-xs text-gray-500 text-center leading-tight font-bold">LOGO</span>
                </div>
                <!-- Foto del alumno -->
                <div class="w-20 h-24 bg-gray-200 border border-gray-300 rounded flex items-center justify-center overflow-hidden">
                  {alumno.foto ? (
                    <img src={alumno.foto} alt={alumno.nombre} class="w-full h-full object-cover" />
                  ) : (
                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                    </svg>
                  )}
                </div>
              </div>

              <!-- Matr√≠cula -->
              <div class="flex items-center justify-between mb-3">
                <span class="text-xs font-bold text-gray-700 uppercase">Matr√≠cula</span>
                <div class="border-2 border-gray-900 px-3 py-1 rounded">
                  <span class="font-bold text-gray-900 text-lg font-mono">{alumno.matricula}</span>
                </div>
              </div>

              <!-- Datos personales -->
              <div class="space-y-1 mb-4 text-xs">
                <p class="text-gray-900"><strong>Nombres:</strong> {nombresCarnet.toUpperCase()}</p>
                <p class="text-gray-900"><strong>Apellidos:</strong> {apellidosCarnet.toUpperCase()}</p>
                <p class="text-gray-900"><strong>C. Identidad:</strong> {alumno.rut}</p>
                <p class="text-gray-900"><strong>INSTRUCTOR:</strong> {alumno.instructor.toUpperCase()}</p>
              </div>

              <!-- Aviso y curso -->
              <div class="mt-auto text-center">
                <p class="text-xs text-gray-600 italic mb-2 leading-tight">
                  <em>No olvide llevar consigo este carnet durante las clases pr√°cticas</em>
                </p>
                <p class="font-extrabold text-gray-900 text-sm uppercase tracking-wide">CURSO {alumno.curso.toUpperCase()}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Certificado -->
  <div id="modal-certificado" class="fixed inset-0 z-50 hidden items-center justify-center p-4" style="background: rgba(0,0,0,0.6);">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
      <div class="flex items-center justify-between p-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Certificado de Alumno Regular</h2>
        <button onclick="cerrarCertificado()" class="p-1.5 text-gray-400 hover:text-gray-700 rounded-lg hover:bg-gray-100">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-6">
        <div class="flex items-center gap-3 mb-5 p-4 bg-green-50 rounded-lg border border-green-200">
          <svg class="w-8 h-8 text-green-600 shrink-0" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.745 3.745 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.745 3.745 0 0 1 3.296-1.043A3.745 3.745 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.745 3.745 0 0 1 3.296 1.043 3.745 3.745 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
          </svg>
          <div>
            <p class="font-semibold text-green-900">Alumno apto para certificado</p>
            <p class="text-sm text-green-700">12/12 clases pr√°cticas completadas</p>
          </div>
        </div>
        <div class="space-y-2 text-sm text-gray-700 mb-6">
          <p><strong>Alumno:</strong> {alumno.nombre}</p>
          <p><strong>RUT:</strong> {alumno.rut}</p>
          <p><strong>Curso:</strong> {alumno.curso}</p>
          <p><strong>Escuela:</strong> {alumno.escuela}</p>
          <p><strong>Instructor:</strong> {alumno.instructor}</p>
          <p><strong>Matr√≠cula:</strong> #{alumno.matricula}</p>
          <p><strong>Fecha de emisi√≥n:</strong> 2026-02-24</p>
        </div>
        <div class="flex gap-3">
          <button
            onclick="window.print()"
            class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            Imprimir Certificado
          </button>
          <button onclick="cerrarCertificado()" class="px-4 py-2.5 text-sm font-medium bg-white border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>

<script>
  function registrarInasistencia() {
    alert('üóìÔ∏è Registrar Inasistencia\n\nEsta funcionalidad permite:\n‚Ä¢ Seleccionar fecha de la inasistencia\n‚Ä¢ Indicar si es clase pr√°ctica o te√≥rica\n‚Ä¢ Agregar motivo de la inasistencia\n‚Ä¢ Marcar si est√° justificada\n\n[Mockup - RF-052]');
  }

  function abrirCarnet() {
    const modal = document.getElementById('modal-carnet');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
  }

  function cerrarCarnet() {
    const modal = document.getElementById('modal-carnet');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  }

  function imprimirCarnet() {
    const content = document.getElementById('carnet-content');
    if (!content) return;
    const printWin = window.open('', '_blank', 'width=900,height=600');
    if (!printWin) return;
    printWin.document.write(`
      <html>
        <head>
          <title>Carnet Alumno</title>
          <style>
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { font-family: Arial, sans-serif; font-size: 11px; padding: 16px; }
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #999; padding: 3px 6px; }
            th { background: #f3f4f6; font-weight: bold; }
            .flex { display: flex; }
            .border-r { border-right: 2px solid #ccc; }
            .font-mono { font-family: monospace; }
            @page { margin: 1cm; size: A5 landscape; }
          </style>
        </head>
        <body>${content.innerHTML}</body>
      </html>
    `);
    printWin.document.close();
    printWin.focus();
    setTimeout(() => printWin.print(), 300);
  }

  function abrirCertificado() {
    const modal = document.getElementById('modal-certificado');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
  }

  function cerrarCertificado() {
    const modal = document.getElementById('modal-certificado');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  }

  function alertaCertificado() {
    alert('‚ö†Ô∏è Certificado no disponible\n\nEl alumno debe completar las 12 clases pr√°cticas para obtener el certificado.\n\nClases completadas: 8/12\n\n[Mockup]');
  }

  // Cerrar modales al hacer click en el overlay
  document.addEventListener('click', (e) => {
    const modalCarnet = document.getElementById('modal-carnet');
    const modalCert = document.getElementById('modal-certificado');
    if (e.target === modalCarnet) cerrarCarnet();
    if (e.target === modalCert) cerrarCertificado();
  });

  (window as any).registrarInasistencia = registrarInasistencia;
  (window as any).abrirCarnet = abrirCarnet;
  (window as any).cerrarCarnet = cerrarCarnet;
  (window as any).imprimirCarnet = imprimirCarnet;
  (window as any).abrirCertificado = abrirCertificado;
  (window as any).cerrarCertificado = cerrarCertificado;
  (window as any).alertaCertificado = alertaCertificado;
</script>
