---
/**
 * Componente: Modal para Agendar Clase Individual
 * Permite agendar una clase con validaciones en tiempo real
 * RF-014: Agendamiento clase por clase con validaciones
 */
import Button from "../ui/Button.astro";

export interface Props {
    isOpen?: boolean;
}

const { isOpen = false } = Astro.props;
---

<div
    id="booking-modal"
    class={`fixed inset-0 z-50 ${isOpen ? "flex" : "hidden"} items-center justify-center p-4 bg-black bg-opacity-50`}
    role="dialog"
    aria-modal="true"
    aria-labelledby="booking-modal-title"
>
    <div
        class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
    >
        <!-- Header -->
        <div
            class="flex items-center justify-between p-6 border-b border-gray-200"
        >
            <div>
                <h2
                    id="booking-modal-title"
                    class="text-xl font-semibold text-gray-900"
                >
                    Agendar Nueva Clase
                </h2>
                <p class="text-sm text-gray-600 mt-1">
                    Completa los datos para reservar la clase
                </p>
            </div>
            <button
                type="button"
                onclick="closeBookingModal()"
                class="text-gray-400 hover:text-gray-600 transition-colors"
                aria-label="Cerrar modal"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Body -->
        <form id="booking-form" class="p-6 space-y-4">
            <!-- Alumno -->
            <div>
                <label
                    for="student-select"
                    class="block text-sm font-medium text-gray-700 mb-2"
                >
                    Alumno
                </label>
                <div class="relative">
                    <input
                        type="text"
                        id="student-search"
                        placeholder="Buscar por nombre o RUT..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                    <div
                        id="student-dropdown"
                        class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"
                    >
                        <!-- Resultados de búsqueda se llenarán aquí -->
                    </div>
                </div>
                <p id="student-info" class="text-sm text-gray-600 mt-2 hidden">
                    <!-- Info del alumno seleccionado -->
                </p>
            </div>

            <!-- Fecha y Hora -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label
                        for="booking-date"
                        class="block text-sm font-medium text-gray-700 mb-2"
                    >
                        Fecha
                    </label>
                    <input
                        type="date"
                        id="booking-date"
                        name="date"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
                <div>
                    <label
                        for="booking-time"
                        class="block text-sm font-medium text-gray-700 mb-2"
                    >
                        Hora
                    </label>
                    <select
                        id="booking-time"
                        name="time"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">Seleccionar hora</option>
                        <option value="08:00">08:00</option>
                        <option value="09:00">09:00</option>
                        <option value="10:00">10:00</option>
                        <option value="11:00">11:00</option>
                        <option value="12:00">12:00</option>
                        <option value="13:00">13:00</option>
                        <option value="14:00">14:00</option>
                        <option value="15:00">15:00</option>
                        <option value="16:00">16:00</option>
                        <option value="17:00">17:00</option>
                        <option value="18:00">18:00</option>
                        <option value="19:00">19:00</option>
                    </select>
                </div>
            </div>

            <!-- Instructor -->
            <div>
                <label
                    for="instructor-select"
                    class="block text-sm font-medium text-gray-700 mb-2"
                >
                    Instructor
                </label>
                <select
                    id="instructor-select"
                    name="instructor"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                    <option value="">Seleccionar instructor</option>
                    <!-- Opciones se llenarán dinámicamente según disponibilidad -->
                </select>
                <p id="vehicle-info" class="text-sm text-gray-600 mt-2 hidden">
                    <!-- Info del vehículo asignado -->
                </p>
            </div>

            <!-- Número de Clase -->
            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm font-medium text-blue-900">
                    Clase <span id="class-number">-</span> de 12
                </p>
                <p class="text-xs text-blue-700 mt-1">
                    Próxima clase en secuencia para este alumno
                </p>
            </div>

            <!-- Validaciones en Tiempo Real -->
            <div id="validation-messages" class="space-y-2">
                <!-- Mensajes de validación aparecerán aquí -->
            </div>

            <!-- Advertencias -->
            <div id="warnings-container" class="hidden">
                <div
                    class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg"
                >
                    <p class="text-sm font-medium text-yellow-900 mb-2">
                        ⚠️ Advertencias
                    </p>
                    <ul
                        id="warnings-list"
                        class="text-sm text-yellow-800 space-y-1"
                    >
                        <!-- Advertencias se mostrarán aquí -->
                    </ul>
                </div>
            </div>

            <!-- Footer -->
            <div class="flex gap-3 pt-4 border-t border-gray-200">
                <Button
                    variant="secondary"
                    type="button"
                    class="flex-1"
                    onclick="closeBookingModal()"
                >
                    Cancelar
                </Button>
                <Button
                    variant="primary"
                    type="submit"
                    class="flex-1"
                    id="submit-booking-btn"
                    disabled
                >
                    Confirmar Agendamiento
                </Button>
            </div>
        </form>
    </div>
</div>

<script>
    // Funciones globales para abrir/cerrar modal
    (window as any).openBookingModal = function (date?: string, time?: string) {
        const modal = document.getElementById("booking-modal");
        if (!modal) return;

        modal.classList.remove("hidden");
        modal.classList.add("flex");

        // Pre-llenar fecha y hora si se proporciona
        if (date) {
            const dateInput = document.getElementById(
                "booking-date",
            ) as HTMLInputElement;
            if (dateInput) dateInput.value = date;
        }
        if (time) {
            const timeSelect = document.getElementById(
                "booking-time",
            ) as HTMLSelectElement;
            if (timeSelect) timeSelect.value = time;
        }
    };

    (window as any).closeBookingModal = function () {
        const modal = document.getElementById("booking-modal");
        if (!modal) return;

        modal.classList.remove("flex");
        modal.classList.add("hidden");

        // Limpiar formulario
        const form = document.getElementById("booking-form") as HTMLFormElement;
        if (form) form.reset();
    };

    // Escuchar evento de apertura desde el calendario
    window.addEventListener("openBookingModal", (event: any) => {
        const { date, time } = event.detail;
        (window as any).openBookingModal(date, time);
    });

    // Cerrar modal al hacer click fuera
    document.addEventListener("click", (e) => {
        const modal = document.getElementById("booking-modal");
        if (modal && e.target === modal) {
            (window as any).closeBookingModal();
        }
    });

    // Manejo del formulario
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("booking-form");
        if (!form) return;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            console.log("Formulario enviado - crear agendamiento");

            // Aquí iría la lógica para enviar al backend
            // Por ahora solo cerramos el modal
            (window as any).closeBookingModal();

            // Mostrar mensaje de éxito (temporal)
            alert("✅ Clase agendada exitosamente");
        });

        // Validación en tiempo real al cambiar campos
        const dateInput = document.getElementById("booking-date");
        const timeSelect = document.getElementById("booking-time");
        const instructorSelect = document.getElementById("instructor-select");

        [dateInput, timeSelect, instructorSelect].forEach((input) => {
            input?.addEventListener("change", () => {
                validateBookingForm();
            });
        });
    });

    function validateBookingForm() {
        // Aquí iría la lógica de validación usando ClassSequenceValidator
        // Por ahora solo habilitamos el botón submit
        const submitBtn = document.getElementById(
            "submit-booking-btn",
        ) as HTMLButtonElement;
        if (submitBtn) {
            submitBtn.disabled = false;
        }
    }
</script>
