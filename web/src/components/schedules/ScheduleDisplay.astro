---
/**
 * Componente: Mostrar Clases Individuales del Alumno
 * Sistema de agendamiento clase por clase (RF-014)
 */
import Card from "../ui/Card.astro";
import Button from "../ui/Button.astro";

export interface ClassBooking {
    id: number;
    classNumber: number;
    date: string;
    time: string;
    instructor: string;
    vehicle: string;
    status: "scheduled" | "completed" | "cancelled" | "no_show";
    canCancel: boolean; // >24 hrs antes
    canReschedule: boolean; // >24 hrs antes
}

export interface Props {
    bookings: ClassBooking[];
    completedClasses: number;
    totalClasses: number;
    nextClassNumber: number;
    showProgressCard?: boolean;
}

const { bookings, completedClasses, totalClasses, nextClassNumber, showProgressCard = false } =
    Astro.props;

const progressPercent = (completedClasses / totalClasses) * 100;

// Separar clases por estado
const scheduledClasses = bookings.filter((b) => b.status === "scheduled");
const completedClassList = bookings.filter((b) => b.status === "completed");
const pastClasses = bookings.filter(
    (b) => b.status === "cancelled" || b.status === "no_show",
);
---

<div class="space-y-6">
    <!-- Progreso General (opcional) -->
    {showProgressCard && (
        <Card class="p-6">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-1">
                        Progreso del Curso Clase B
                    </h2>
                    <p class="text-sm text-gray-600">
                        Sistema de agendamiento individual - 12 clases totales
                    </p>
                </div>
                <div
                    class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium"
                >
                    {completedClasses}/{totalClasses} clases
                </div>
            </div>

            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700"
                        >Clases Completadas</span
                    >
                    <span class="text-sm font-semibold text-gray-900">
                        {completedClasses}/{totalClasses}
                    </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div
                        class="bg-green-600 h-3 rounded-full transition-all duration-500"
                        style={`width: ${progressPercent}%`}
                    >
                    </div>
                </div>
            </div>

            {nextClassNumber <= totalClasses ? (
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm font-medium text-blue-900 mb-1">
                        üìö Pr√≥xima clase disponible
                    </p>
                    <p class="text-sm text-blue-800">
                        Puedes agendar tu{" "}
                        <strong>Clase {nextClassNumber}</strong> cuando lo desees
                        (respetando 24 hrs de anticipaci√≥n)
                    </p>
                    <Button href="/alumno/agendar" variant="primary" class="mt-3">
                        Agendar Clase {nextClassNumber}
                    </Button>
                </div>
            ) : null}

            {completedClasses === totalClasses ? (
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-sm font-medium text-green-900 mb-1">
                        üéâ ¬°Felicitaciones!
                    </p>
                    <p class="text-sm text-green-800">
                        Has completado las 12 clases pr√°cticas. Ya puedes descargar
                        tu certificado.
                    </p>
                    <Button variant="primary" class="mt-3">
                        Descargar Certificado
                    </Button>
                </div>
            ) : null}
        </Card>
    )}

    <!-- Mini card de Pr√≥xima clase disponible (sin progress card) -->
    {!showProgressCard && nextClassNumber <= totalClasses ? (
        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-sm font-medium text-blue-900 mb-1">
                üìö Pr√≥xima clase disponible
            </p>
            <p class="text-sm text-blue-800">
                Puedes agendar tu{" "}
                <strong>Clase {nextClassNumber}</strong> cuando lo desees
                (respetando 24 hrs de anticipaci√≥n)
            </p>
            <Button href="/alumno/agendar" variant="primary" class="mt-3">
                Agendar Clase {nextClassNumber}
            </Button>
        </div>
    ) : null}

    <!-- Clases Agendadas (Pr√≥ximas) -->
    {
        scheduledClasses.length > 0 && (
            <Card class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    Pr√≥ximas Clases Pr√°cticas Agendadas
                </h3>

                <div class="space-y-3">
                    {scheduledClasses.map((clase) => (
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="text-center min-w-15">
                                    <p class="text-sm font-medium text-gray-900">
                                        {new Date(
                                            clase.date,
                                        ).toLocaleDateString("es-CL", {
                                            day: "2-digit",
                                        })}
                                    </p>
                                    <p class="text-xs text-gray-600">
                                        {new Date(
                                            clase.date,
                                        ).toLocaleDateString("es-CL", {
                                            month: "short",
                                        })}
                                    </p>
                                </div>

                                <div class="flex-1">
                                    <p class="font-medium text-gray-900">
                                        Clase {clase.classNumber}/{totalClasses}
                                    </p>
                                    <div class="space-y-1 text-sm text-gray-600 mt-1">
                                        <p>üïê {clase.time}</p>
                                        <p>üë®‚Äçüè´ {clase.instructor}</p>
                                        <p>üöó {clase.vehicle}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col gap-2">
                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                    <span>üïê</span>
                                    <span>Agendada</span>
                                </span>

                                <div class="flex gap-2">
                                    {clase.canReschedule && (
                                        <Button variant="ghost" class="text-xs">
                                            Reagendar
                                        </Button>
                                    )}
                                    {clase.canCancel && (
                                        <Button
                                            variant="ghost"
                                            class="text-xs text-red-600 hover:text-red-700"
                                        >
                                            Cancelar
                                        </Button>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </Card>
        )
    }

    <!-- Clases Completadas -->
    {
        completedClassList.length > 0 && (
            <Card class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    Clases Pr√°cticas Completadas ({completedClassList.length})
                </h3>

                <div class="space-y-2">
                    {completedClassList.map((clase) => (
                        <div class="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg">
                            <div class="flex items-center gap-4">
                                <div class="text-center min-w-15">
                                    <p class="text-sm font-medium text-gray-700">
                                        {new Date(
                                            clase.date,
                                        ).toLocaleDateString("es-CL", {
                                            day: "2-digit",
                                        })}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        {new Date(
                                            clase.date,
                                        ).toLocaleDateString("es-CL", {
                                            month: "short",
                                        })}
                                    </p>
                                </div>

                                <div>
                                    <p class="font-medium text-gray-900">
                                        Clase {clase.classNumber}/{totalClasses}
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        {clase.time} con {clase.instructor}
                                    </p>
                                </div>
                            </div>

                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                <span>‚úÖ</span>
                                <span>Completada</span>
                            </span>
                        </div>
                    ))}
                </div>
            </Card>
        )
    }

    <!-- Informaci√≥n Importante -->
    <Card class="p-6 bg-yellow-50 border-yellow-200">
        <div class="flex gap-3">
            <svg
                class="w-5 h-5 text-yellow-600 shrink-0 mt-0.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                ></path>
            </svg>
            <div class="text-sm text-yellow-800">
                <p class="font-medium mb-2">‚ö†Ô∏è Reglas de Agendamiento</p>
                <ul class="list-disc list-inside space-y-1">
                    <li>Debes agendar con m√≠nimo 24 horas de anticipaci√≥n</li>
                    <li>
                        No puedes tener m√°s de 3 clases agendadas
                        simult√°neamente
                    </li>
                    <li>No puedes agendar 2 clases el mismo d√≠a</li>
                    <li>
                        Debes completar las clases en orden (1, 2, 3... hasta
                        12)
                    </li>
                    <li>
                        Si cancelas con menos de 24 hrs, la clase cuenta como
                        tomada
                    </li>
                    <li>
                        Si faltas 2 clases consecutivas, se eliminar√° tu horario
                    </li>
                </ul>
            </div>
        </div>
    </Card>
</div>
