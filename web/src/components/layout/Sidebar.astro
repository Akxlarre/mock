---
/**
 * Sidebar Responsive - Mejorado con colapso
 * Diferentes menús según rol, colapsable en mobile
 */
import type { UserRole } from "../../lib/session";

interface Props {
  currentPath?: string;
  userRole?: UserRole;
}

interface MenuItem {
  href: string;
  label: string;
  icon: string;
  badge?: number;
}

const { currentPath = "", userRole = "admin" } = Astro.props as { currentPath?: string; userRole?: "admin" | "instructor" | "secretaria" | "alumno" | "relator" };

interface MenuGroup {
  group: string;
  items: MenuItem[];
}

// Menús por rol
const menuItems: {
  [K in "admin" | "instructor" | "secretaria" | "alumno" | "relator"]: MenuGroup[];
} = {
  admin: [
    {
      group: "Dashboard",
      items: [{ href: "/dashboard", label: "Inicio", icon: "home" }],
    },
    {
      group: "Operación Diaria",
      items: [
        {
          href: "/notificaciones",
          label: "Notificaciones",
          icon: "bell",
          badge: 3,
        },
        { href: "/tareas", label: "Tareas Pendientes", icon: "check" },
        { href: "/matricula/nuevo", label: "Nueva Matrícula", icon: "user" },
      ],
    },
    {
      group: "Alumnos",
      items: [
        { href: "/alumnos", label: "Base de Alumnos", icon: "users" },
        { href: "/certificados", label: "Certificados", icon: "check" },
        { href: "/psicotecnico", label: "Psicotécnico", icon: "shield" },
      ],
    },
    {
      group: "Agenda y Clases",
      items: [
        {
          href: "/admin/agenda",
          label: "Agenda Semanal",
          icon: "calendar-check",
        },
        { href: "/asistencia", label: "Asistencia", icon: "check" },
      ],
    },
    {
      group: "Administración",
      items: [
        { href: "/pagos", label: "Pagos", icon: "dollar" },
        {
          href: "/contabilidad/cuadratura",
          label: "Cuadratura Caja",
          icon: "dollar",
        },
        { href: "/secretarias", label: "Secretarias", icon: "shield" },
        { href: "/instructores", label: "Instructores", icon: "users" },
        {
          href: "/contabilidad/reportes",
          label: "Reportes Contables",
          icon: "check",
        },
        {
          href: "/contabilidad/cursos-singulares",
          label: "Cursos Singulares",
          icon: "check",
        },
        {
          href: "/contabilidad/anticipos",
          label: "Anticipos Instructores",
          icon: "dollar",
        },
        { href: "/flota/vehiculos", label: "Flota", icon: "car" },
        { href: "/libro-de-clases", label: "Libro de Clases", icon: "clipboard" },
      ],
    },
    {
      group: "Clase Profesional",
      items: [
        { href: "/profesional/relatores", label: "Relatores", icon: "users" },
        { href: "/profesional/promociones", label: "Promociones", icon: "calendar-check" },
        { href: "/clase-profesional/evaluaciones", label: "Evaluaciones", icon: "check" },
        { href: "/profesional/certificados", label: "Certificados Prof.", icon: "check" },
        { href: "/profesional/archivo", label: "Archivo Histórico", icon: "clipboard" },
      ],
    },
    {
      group: "Reportes",
      items: [
        { href: "/auditoria", label: "Auditoría", icon: "clock" },
        { href: "/reportes", label: "Reportes", icon: "check" },
      ],
    },
  ],
  instructor: [
    {
      group: "Mi Trabajo",
      items: [
        { href: "/instructor/dashboard", label: "Mi Dashboard", icon: "home" },
        {
          href: "/instructor/notificaciones",
          label: "Notificaciones",
          icon: "bell",
          badge: 1,
        },
        {
          href: "/instructor/clase/iniciar",
          label: "Iniciar Clase",
          icon: "check",
        },
      ],
    },
    {
      group: "Mis Recursos",
      items: [
        { href: "/instructor/horario", label: "Mi Horario", icon: "calendar" },
        { href: "/instructor/alumnos", label: "Mis Alumnos", icon: "users" },
        { href: "/instructor/ensayos-teoricos", label: "Ensayos Teóricos", icon: "check" },
        { href: "/instructor/liquidacion", label: "Mis Horas", icon: "clock" },
      ],
    },
  ],
  secretaria: [
    {
      group: "Mi Dashboard",
      items: [
        { href: "/secretaria/dashboard", label: "Inicio", icon: "home" },
        {
          href: "/secretaria/notificaciones",
          label: "Notificaciones",
          icon: "bell",
          badge: 2,
        },
        {
          href: "/secretaria/matricula/nuevo",
          label: "Nueva Matrícula",
          icon: "user",
        },
      ],
    },
    {
      group: "Gestión de Alumnos",
      items: [
        { href: "/secretaria/matricula", label: "Matrículas", icon: "users" },
        { href: "/secretaria/alumnos", label: "Base de Alumnos", icon: "user" },
        { href: "/secretaria/comunicaciones", label: "Comunicaciones", icon: "user" },
        {
          href: "/secretaria/certificados",
          label: "Certificados",
          icon: "check",
        },
        {
          href: "/secretaria/psicotecnico",
          label: "Psicotécnico",
          icon: "shield",
        },
      ],
    },
    {
      group: "Operaciones",
      items: [
        { href: "/secretaria/agenda", label: "Agenda", icon: "calendar-check" },
        { href: "/secretaria/asistencia", label: "Asistencia", icon: "check" },
        { href: "/secretaria/instructores", label: "Instructores", icon: "users" },
        { href: "/secretaria/pagos", label: "Pagos", icon: "dollar" },
        {
          href: "/contabilidad/cuadratura",
          label: "Cuadratura Caja",
          icon: "dollar",
        },
        {
          href: "/secretaria/contabilidad/reportes",
          label: "Reportes Contables",
          icon: "check",
        },
        {
          href: "/contabilidad/cursos-singulares",
          label: "Cursos Singulares",
          icon: "check",
        },
        {
          href: "/contabilidad/anticipos",
          label: "Anticipos Instructores",
          icon: "dollar",
        },
        { href: "/libro-de-clases", label: "Libro de Clases", icon: "clipboard" },
      ],
    },
    {
      group: "Clase Profesional",
      items: [
        { href: "/secretaria/profesional/relatores", label: "Relatores", icon: "users" },
        { href: "/secretaria/profesional/promociones", label: "Promociones", icon: "calendar-check" },
        { href: "/clase-profesional/evaluaciones", label: "Evaluaciones", icon: "check" },
        { href: "/secretaria/profesional/certificados", label: "Certificados Prof.", icon: "check" },
        { href: "/secretaria/profesional/archivo", label: "Archivo Histórico", icon: "clipboard" },
      ],
    },
  ],
  relator: [
    {
      group: "Mi Trabajo",
      items: [
        { href: "/relator/dashboard", label: "Inicio", icon: "home" },
        { href: "/relator/asistencia", label: "Tomar Asistencia", icon: "check" },
        { href: "/relator/alumnos", label: "Mis Alumnos", icon: "users" },
        { href: "/relator/notas", label: "Registro de Notas", icon: "clipboard" },
        { href: "/relator/maquinaria", label: "Maquinaria", icon: "car" },
        { href: "/relator/acta-final", label: "Acta Final", icon: "check" },
      ],
    },
  ],
  alumno: [
    {
      group: "Mi Progreso",
      items: [
        { href: "/alumno/dashboard", label: "Mi Dashboard", icon: "home" },
        {
          href: "/alumno/notificaciones",
          label: "Notificaciones",
          icon: "bell",
          badge: 2,
        },
        { href: "/alumno/certificado", label: "Mi Certificado", icon: "check" },
        { href: "/alumno/notas", label: "Mis Notas", icon: "clipboard" },
      ],
    },
    {
      group: "Mis Clases",
      items: [
        {
          href: "/alumno/clases",
          label: "Mis Clases",
          icon: "calendar-check",
        },
        {
          href: "/alumno/agendar",
          label: "Agendar Clase",
          icon: "calendar",
        },
      ],
    },
    {
      group: "Pagos",
      items: [{ href: "/alumno/pagos", label: "Mis Pagos", icon: "dollar" }],
    },
  ],
};

const icons = {
  home: "M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6",
  bell: "M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9",
  users:
    "M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z",
  user: "M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z",
  shield:
    "M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z",
  dollar:
    "M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
  car: "M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0",
  calendar:
    "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z",
  "calendar-check":
    "M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4",
  check: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
  clock: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
  clipboard: "M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2",
};

const currentMenu = menuItems[userRole];

// Enlace de ayuda específico según rol
const ayudaHref =
  userRole === "alumno"
    ? "/alumno/ayuda"
    : userRole === "instructor"
      ? "/instructor/ayuda"
      : userRole === "secretaria"
        ? "/secretaria/ayuda"
        : "/ayuda"; // admin por defecto
---

<aside
  id="sidebar"
  class="fixed left-0 top-0 h-screen w-64 bg-white border-r border-gray-200 z-40 transition-transform duration-300 lg:translate-x-0 -translate-x-full flex flex-col"
  data-sidebar
>
  <!-- Brand -->
  <div class="h-16 flex items-center gap-3 px-6 border-b border-gray-200">
    <div
      class="w-9 h-9 bg-gray-900 rounded-lg flex items-center justify-center shrink-0"
      transition:name="brand-logo"
    >
      <svg
        class="w-5 h-5 text-white"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
        ></path>
      </svg>
    </div>
    <div class="flex-1 min-w-0">
      {
        userRole === "admin" ? (
          <div class="relative" data-school-selector>
            <button
              id="schoolMenuButton"
              type="button"
              aria-haspopup="listbox"
              aria-expanded="false"
              aria-label="Cambiar escuela actual"
              class="school-menu-btn w-full flex items-center justify-between gap-2 px-3 py-2.5 rounded-lg bg-gray-50 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-1 cursor-pointer text-left"
            >
              <div class="min-w-0 flex-1">
                <p class="text-[10px] font-semibold uppercase tracking-wider text-gray-500">
                  Escuela actual
                </p>
                <p
                  id="schoolMenuLabel"
                  class="text-sm font-medium text-gray-900 truncate"
                >
                  Autoescuela Chillán
                </p>
              </div>
              <svg
                id="schoolMenuChevron"
                class="w-4 h-4 text-gray-500 shrink-0 transition-transform duration-200"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>

            <div
              id="schoolMenuDropdown"
              role="listbox"
              class="school-menu-dropdown hidden absolute left-0 right-0 top-full mt-1.5 bg-white border border-gray-200 rounded-lg shadow-lg py-1 z-50 min-w-full"
            >
              <button
                type="button"
                role="option"
                class="school-option block w-full text-left px-3 py-2.5 text-sm text-gray-900 hover:bg-gray-100 first:rounded-t-lg last:rounded-b-lg transition-colors"
                data-school-name="Autoescuela Chillán"
              >
                Autoescuela Chillán
              </button>
              <button
                type="button"
                role="option"
                class="school-option block w-full text-left px-3 py-2.5 text-sm text-gray-900 hover:bg-gray-100 first:rounded-t-lg last:rounded-b-lg transition-colors"
                data-school-name="Conductores Chillán"
              >
                Conductores Chillán
              </button>
            </div>
          </div>
        ) : (
          <>
            <p class="font-semibold text-gray-900 text-sm truncate">
              Escuela Conductores
            </p>
            <p class="text-xs text-secondary truncate">Chillán</p>
          </>
        )
      }
    </div>
  </div>

  <!-- Navigation -->
  <nav class="flex-1 min-h-0 overflow-y-auto p-4 space-y-6">
    {
      currentMenu.map((group) => (
        <div>
          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-3">
            {group.group}
          </p>
          <div class="space-y-1">
            {group.items.map((item) => {
              const isActive =
                currentPath === item.href ||
                currentPath.startsWith(item.href + "/");
              return (
                <a
                  href={item.href}
                  class={`flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg transition-colors ${
                    isActive
                      ? "bg-gray-900 text-white"
                      : "text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                  }`}
                >
                  <svg
                    class="w-5 h-5 shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d={icons[item.icon as keyof typeof icons]}
                    />
                  </svg>
                  <span class="flex-1">{item.label}</span>
                  {item.badge && (
                    <span class="px-2 py-0.5 bg-red-500 text-white text-xs font-semibold rounded-full">
                      {item.badge}
                    </span>
                  )}
                </a>
              );
            })}
          </div>
        </div>
      ))
    }
  </nav>

  <!-- Footer -->
  <div class="border-t border-gray-200 p-4">
    <a
      href={ayudaHref}
      class="flex items-center gap-3 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-lg transition-colors"
    >
      <svg
        class="w-5 h-5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        ></path>
      </svg>
      <span>{userRole === "alumno" ? "Contacto y Ayuda" : "Ayuda"}</span>
    </a>
    <a
      href="/login"
      class="flex items-center gap-3 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 hover:text-red-600 rounded-lg transition-colors"
    >
      <svg
        class="w-5 h-5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
        ></path>
      </svg>
      <span>Cerrar sesión</span>
    </a>
  </div>
</aside>

<!-- Overlay (mobile) -->
<div
  id="sidebar-overlay"
  class="fixed inset-0 bg-black/50 z-30 lg:hidden hidden"
  data-sidebar-overlay
>
</div>

<script is:inline>
  (function () {
    // Sidebar toggle functionality
    const sidebar = document.querySelector("[data-sidebar]");
    const overlay = document.querySelector("[data-sidebar-overlay]");

    // Toggle function
    function toggleSidebar() {
      sidebar?.classList.toggle("-translate-x-full");
      overlay?.classList.toggle("hidden");
    }

    // Close on overlay click
    overlay?.addEventListener("click", toggleSidebar);

    // Make globally accessible
    window.toggleSidebar = toggleSidebar;

    // Close on route change (for client-side navigation)
    document.addEventListener("astro:after-swap", () => {
      if (window.innerWidth < 1024) {
        sidebar?.classList.add("-translate-x-full");
        overlay?.classList.add("hidden");
      }
    });

    // Selector de escuela
    let schoolSelectorInitialized = false;

    function setupSchoolSelector() {
      if (schoolSelectorInitialized) return;

      const button = document.getElementById("schoolMenuButton");
      const dropdown = document.getElementById("schoolMenuDropdown");
      const label = document.getElementById("schoolMenuLabel");
      const chevron = document.getElementById("schoolMenuChevron");

      if (!button || !dropdown) {
        setTimeout(setupSchoolSelector, 100);
        return;
      }

      schoolSelectorInitialized = true;

      // Toggle dropdown al hacer click en el botón
      button.onclick = function (e) {
        e.stopPropagation();
        const isHidden = dropdown.classList.contains("hidden");

        if (isHidden) {
          dropdown.classList.remove("hidden");
          button.setAttribute("aria-expanded", "true");
          if (chevron) chevron.classList.add("rotate-180");
        } else {
          dropdown.classList.add("hidden");
          button.setAttribute("aria-expanded", "false");
          if (chevron) chevron.classList.remove("rotate-180");
        }
      };

      // Seleccionar opción
      const options = dropdown.querySelectorAll(".school-option");
      options.forEach((option) => {
        option.onclick = function (e) {
          e.stopPropagation();
          const name = option.getAttribute("data-school-name");
          if (name && label) {
            label.textContent = name;
          }
          dropdown.classList.add("hidden");
          button.setAttribute("aria-expanded", "false");
          if (chevron) chevron.classList.remove("rotate-180");
        };
      });

      // Cerrar al hacer clic fuera
      document.addEventListener("click", function () {
        dropdown.classList.add("hidden");
        button.setAttribute("aria-expanded", "false");
        if (chevron) chevron.classList.remove("rotate-180");
      });
    }

    // Ejecutar cuando el DOM esté listo
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", setupSchoolSelector);
    } else {
      setupSchoolSelector();
    }

    // Reiniciar después de transiciones de página
    document.addEventListener("astro:page-load", function () {
      schoolSelectorInitialized = false;
      setupSchoolSelector();
    });
  })();
</script>

<style>
  /* Custom scrollbar para navegación */
  nav {
    scrollbar-width: thin;
    scrollbar-color: rgb(209, 213, 219) transparent;
  }

  nav::-webkit-scrollbar {
    width: 6px;
  }

  nav::-webkit-scrollbar-track {
    background: transparent;
  }

  nav::-webkit-scrollbar-thumb {
    background-color: rgb(209, 213, 219);
    border-radius: 3px;
  }
</style>
