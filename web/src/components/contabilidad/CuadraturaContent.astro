---
/**
 * Contenido de Cuadratura de Caja. Reutilizable para admin y secretaria con basePath.
 * RF-036: Control de ingresos y cierre diario
 */
import Card from "../ui/Card.astro";
import Button from "../ui/Button.astro";

interface Props {
  basePath?: string;
}

const { basePath = "" } = Astro.props;

const fechaHoy = new Date().toLocaleDateString("es-CL");

const transacciones = [
  { id: 1, hora: "09:15", tipo: "Matr√≠cula", alumno: "Juan P√©rez", monto: 280000, metodo: "efectivo", ref: "MAT-2026-0234" },
  { id: 2, hora: "10:30", tipo: "Matr√≠cula", alumno: "Ana Garc√≠a", monto: 230000, metodo: "transferencia", ref: "MAT-2026-0235" },
  { id: 3, hora: "11:45", tipo: "Pago Clase Extra", alumno: "Carlos L√≥pez", monto: 25000, metodo: "efectivo", ref: "PAGO-456" },
  { id: 4, hora: "14:20", tipo: "Matr√≠cula", alumno: "Mar√≠a Gonz√°lez", monto: 280000, metodo: "tarjeta", ref: "MAT-2026-0236" },
  { id: 5, hora: "15:00", tipo: "Certificado", alumno: "Pedro S√°nchez", monto: 15000, metodo: "efectivo", ref: "CERT-123" },
  { id: 6, hora: "16:10", tipo: "Matr√≠cula", alumno: "Laura Mart√≠nez", monto: 280000, metodo: "efectivo", ref: "MAT-2026-0237" },
  { id: 7, hora: "16:45", tipo: "Reagendar Clase", alumno: "Diego Rojas", monto: 0, metodo: "n/a", ref: "REAG-789" },
  { id: 8, hora: "17:30", tipo: "Pago Pendiente", alumno: "Sof√≠a Torres", monto: 50000, metodo: "transferencia", ref: "PAGO-457" },
];

const totalEfectivo = transacciones.filter((t) => t.metodo === "efectivo").reduce((sum, t) => sum + t.monto, 0);
const totalTransferencia = transacciones.filter((t) => t.metodo === "transferencia").reduce((sum, t) => sum + t.monto, 0);
const totalTarjeta = transacciones.filter((t) => t.metodo === "tarjeta").reduce((sum, t) => sum + t.monto, 0);
const totalDia = totalEfectivo + totalTransferencia + totalTarjeta;
const cajaAbierta = true;
---

<div class="mb-6">
  <div class="flex items-center gap-2 text-sm text-secondary mb-2">
    <a href={`${basePath}/dashboard`} class="hover:text-gray-900">Inicio</a>
    <span>/</span>
    <a href={`${basePath}/contabilidad/cuadratura`} class="hover:text-gray-900">Contabilidad</a>
    <span>/</span>
    <span class="text-gray-900 font-medium">Cuadratura</span>
  </div>
</div>

<!-- Header -->
<div class="mb-8 flex items-center justify-between">
  <div>
    <h1 class="text-3xl font-semibold text-gray-900">Cuadratura de Caja</h1>
    <p class="text-secondary mt-1">Cierre diario - {fechaHoy}</p>
  </div>
  <div>
    {cajaAbierta ? (
      <span class="inline-flex items-center gap-2 px-4 py-2 bg-green-100 text-green-800 rounded-lg font-medium">
        <span class="w-2 h-2 bg-green-600 rounded-full animate-pulse" />
        Caja Abierta
      </span>
    ) : (
      <span class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-800 rounded-lg font-medium">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        Caja Cerrada
      </span>
    )}
  </div>
</div>

<div class="grid lg:grid-cols-3 gap-6 mb-6">
  <Card class="lg:col-span-2">
    <h2 class="text-xl font-semibold text-gray-900 mb-6">Resumen de Ingresos</h2>

    <div class="grid sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border-2 border-green-200">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-2xl">üíµ</span>
          <p class="text-sm font-medium text-green-900">Efectivo</p>
        </div>
        <p class="text-2xl font-bold text-green-700">${totalEfectivo.toLocaleString("es-CL")}</p>
        <p class="text-xs text-green-600 mt-1">{transacciones.filter((t) => t.metodo === "efectivo").length} transacciones</p>
      </div>

      <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border-2 border-blue-200">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-2xl">üè¶</span>
          <p class="text-sm font-medium text-blue-900">Transferencias</p>
        </div>
        <p class="text-2xl font-bold text-blue-700">${totalTransferencia.toLocaleString("es-CL")}</p>
        <p class="text-xs text-blue-600 mt-1">{transacciones.filter((t) => t.metodo === "transferencia").length} transacciones</p>
      </div>

      <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border-2 border-purple-200">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-2xl">üí≥</span>
          <p class="text-sm font-medium text-purple-900">Tarjetas</p>
        </div>
        <p class="text-2xl font-bold text-purple-700">${totalTarjeta.toLocaleString("es-CL")}</p>
        <p class="text-xs text-purple-600 mt-1">{transacciones.filter((t) => t.metodo === "tarjeta").length} transacciones</p>
      </div>
    </div>

    <div class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-lg p-6 text-white">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-sm text-gray-300 mb-1">Total Ingresos del D√≠a</p>
          <p class="text-xs text-gray-400">{transacciones.length} transacciones totales</p>
        </div>
        <p class="text-4xl font-bold">${totalDia.toLocaleString("es-CL")}</p>
      </div>
    </div>
  </Card>

  <Card>
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Acciones</h3>
    <div class="space-y-3">
      <Button variant="secondary" class="w-full justify-center" onClick="exportarCuadratura()">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Exportar Excel
      </Button>

      <Button variant="secondary" class="w-full justify-center" onClick="imprimirCuadratura()">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
        </svg>
        Imprimir
      </Button>

      <Button variant="secondary" class="w-full justify-center" onClick="registrarGasto()">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Registrar Gasto
      </Button>

      <div class="border-t border-gray-200 pt-3 mt-3">
        <label class="label">
          <span class="label-text font-medium text-sm">Monto en Caja (CLP)</span>
        </label>
        <input type="number" id="monto-real" class="input input-bordered w-full min-h-11 mb-2" placeholder={totalEfectivo.toString()} value={totalEfectivo} />

        <div id="diferencia-section" class="hidden mb-3">
          <label class="label">
            <span class="label-text font-medium text-sm text-red-600">Justificaci√≥n Diferencia *</span>
          </label>
          <textarea id="justificacion" class="textarea textarea-bordered w-full h-20 text-sm" placeholder="Explicar motivo de la diferencia..."></textarea>
        </div>

        <Button id="btn-cerrar-caja" variant="primary" class="w-full justify-center" disabled={!cajaAbierta} onClick="cerrarCaja()">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
          Cerrar Caja
        </Button>
      </div>
    </div>

    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
      <p class="text-xs text-blue-800">
        <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
        </svg>
        Al cerrar caja se generar√° un registro inmutable en el log de auditor√≠a
      </p>
    </div>
  </Card>
</div>

<Card>
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold text-gray-900">Detalle de Transacciones</h2>
    <span class="text-sm text-secondary">{transacciones.length} registros</span>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full">
      <thead>
        <tr class="border-b border-gray-200">
          <th class="text-left py-3 px-4 text-xs font-semibold text-gray-700 uppercase">Hora</th>
          <th class="text-left py-3 px-4 text-xs font-semibold text-gray-700 uppercase">Tipo</th>
          <th class="text-left py-3 px-4 text-xs font-semibold text-gray-700 uppercase">Alumno</th>
          <th class="text-left py-3 px-4 text-xs font-semibold text-gray-700 uppercase">Referencia</th>
          <th class="text-left py-3 px-4 text-xs font-semibold text-gray-700 uppercase">M√©todo</th>
          <th class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase">Monto</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {transacciones.map((t) => (
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="py-3 px-4 text-sm text-secondary whitespace-nowrap">{t.hora}</td>
            <td class="py-3 px-4 text-sm text-gray-900 font-medium">{t.tipo}</td>
            <td class="py-3 px-4 text-sm text-gray-700">{t.alumno}</td>
            <td class="py-3 px-4 text-xs text-muted font-mono">{t.ref}</td>
            <td class="py-3 px-4">
              <span class={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${t.metodo === "efectivo" ? "bg-green-100 text-green-800" : t.metodo === "transferencia" ? "bg-blue-100 text-blue-800" : t.metodo === "tarjeta" ? "bg-purple-100 text-purple-800" : "bg-gray-100 text-gray-600"}`}>
                {t.metodo === "efectivo" ? "üíµ" : t.metodo === "transferencia" ? "üè¶" : t.metodo === "tarjeta" ? "üí≥" : "-"}
                <span class="capitalize">{t.metodo}</span>
              </span>
            </td>
            <td class="py-3 px-4 text-right text-sm font-semibold text-gray-900">
              {t.monto > 0 ? `$${t.monto.toLocaleString("es-CL")}` : "-"}
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</Card>

<script define:vars={{ totalEfectivo, totalDia }}>
  const montoRealInput = document.getElementById("monto-real");
  const diferenciaSection = document.getElementById("diferencia-section");
  const justificacionInput = document.getElementById("justificacion");

  montoRealInput?.addEventListener("input", (e) => {
    const montoReal = parseInt(e.target?.value || "0") || 0;
    const diferencia = Math.abs(totalEfectivo - montoReal);
    if (diferencia > 0) diferenciaSection?.classList.remove("hidden");
    else diferenciaSection?.classList.add("hidden");
  });

  function exportarCuadratura() {
    alert(`‚úì Generando archivo Excel...\n\nContenido:\n‚Ä¢ Resumen ingresos\n‚Ä¢ Detalle ${8} transacciones\n‚Ä¢ Total: $${totalDia.toLocaleString("es-CL")}\n\nDescarga iniciada.`);
  }

  function imprimirCuadratura() {
    window.print();
  }

  window.registrarGasto = function () {
    const monto = prompt("Ingresa el monto del gasto (CLP):");
    if (!monto || isNaN(parseFloat(monto)) || parseFloat(monto) <= 0) {
      if (monto !== null) alert("‚ö†Ô∏è Debes ingresar un monto v√°lido mayor a 0");
      return;
    }
    const categoria = prompt("Categor√≠a del gasto (ej: Combustible, Mantenci√≥n, Materiales, Otros):");
    if (!categoria || categoria.trim() === "") {
      alert("‚ö†Ô∏è Debes especificar la categor√≠a del gasto");
      return;
    }
    const descripcion = prompt("Descripci√≥n del gasto (opcional):") || "";
    
    if (confirm(`¬øConfirmar registro de gasto?\n\nMonto: $${parseFloat(monto).toLocaleString("es-CL")}\nCategor√≠a: ${categoria}\n${descripcion ? `Descripci√≥n: ${descripcion}\n` : ""}\n\nEste gasto se registrar√° en el sistema y afectar√° el balance de caja.`)) {
      alert(`‚úì Gasto registrado exitosamente\n\n‚Ä¢ Monto: $${parseFloat(monto).toLocaleString("es-CL")}\n‚Ä¢ Categor√≠a: ${categoria}\n‚Ä¢ Registrado en: ${new Date().toLocaleString("es-CL")}\n\nEl gasto aparecer√° en el detalle de transacciones.`);
      // En producci√≥n aqu√≠ se har√≠a POST a API para guardar el gasto
    }
  };

  window.cerrarCaja = function () {
    const montoReal = parseInt(montoRealInput?.value || "0");
    const diferencia = Math.abs(totalEfectivo - montoReal);
    if (diferencia > 0) {
      const justificacion = justificacionInput?.value?.trim();
      if (!justificacion) {
        alert("‚ö†Ô∏è Debes justificar la diferencia en caja\n\nDiferencia: $" + diferencia.toLocaleString("es-CL"));
        justificacionInput?.focus();
        return;
      }
    }
    if (confirm(`¬øConfirmar cierre de caja?\n\nTotal esperado: $${totalEfectivo.toLocaleString("es-CL")}\nTotal real: $${montoReal.toLocaleString("es-CL")}\nDiferencia: $${diferencia.toLocaleString("es-CL")}\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer`)) {
      alert(`‚úì Caja cerrada exitosamente\n\n‚Ä¢ Registro guardado en log de auditor√≠a\n‚Ä¢ Resumen enviado por email\n‚Ä¢ Comprobante generado\n\nFecha: ${new Date().toLocaleDateString("es-CL")}\nHora: ${new Date().toLocaleTimeString("es-CL")}`);
      setTimeout(() => window.location.reload(), 2000);
    }
  };
</script>

<style>
  @media print {
    header, button, .btn, nav {
      display: none !important;
    }
  }
</style>
