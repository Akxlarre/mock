---
/**
 * Reportes Contables ‚Äî Componente compartido admin/secretaria
 * RF-030: Reporte contable mensual exportable a PDF y Excel con resumen por secci√≥n
 * RF-031: C√°lculo de Total Neto (Total Ingresos - Total Gastos) por rango de fechas
 * RF-xxx: Separaci√≥n de datos por escuela (Autoescuela Chill√°n / Conductores Chill√°n)
 */
import Card from "../ui/Card.astro";
import Button from "../ui/Button.astro";

interface Props {
    basePath?: string;
}

const { basePath = "" } = Astro.props;

// ‚îÄ‚îÄ DATOS MOCK POR ESCUELA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Cada empresa es una entidad independiente con sus propios n√∫meros.
// "Autoescuela Chill√°n" ‚Üí solo Clase B
// "Conductores Chill√°n" ‚Üí Clase B + Profesional

const datosPorEscuela = {
    "autoescuela-chillan": {
        nombre: "Autoescuela Chill√°n",
        meses: [
            { mes: "Enero 2026", ingresos: 3100000, gastos: 820000 },
            { mes: "Febrero 2026", ingresos: 2400000, gastos: 640000 },
        ],
        ingresosPorCategoria: [
            { categoria: "Clase B", cantidad: 18, total: 5040000, porcentaje: 73.5 },
            { categoria: "Psicot√©cnico", cantidad: 12, total: 480000, porcentaje: 7.0 },
            { categoria: "Clases Extra", cantidad: 15, total: 375000, porcentaje: 5.5 },
            { categoria: "Certificados", cantidad: 20, total: 960000, porcentaje: 14.0 },
        ],
    },
    "conductores-chillan": {
        nombre: "Conductores Chill√°n",
        meses: [
            { mes: "Enero 2026", ingresos: 1750000, gastos: 410000 },
            { mes: "Febrero 2026", ingresos: 1220000, gastos: 340000 },
        ],
        ingresosPorCategoria: [
            { categoria: "Clase B", cantidad: 5, total: 1400000, porcentaje: 38.0 },
            { categoria: "Profesional", cantidad: 6, total: 2280000, porcentaje: 61.9 },
        ],
    },
    "ambas": {
        nombre: "Ambas escuelas",
        meses: [
            { mes: "Enero 2026", ingresos: 4850000, gastos: 1230000 },
            { mes: "Febrero 2026", ingresos: 3620000, gastos: 980000 },
        ],
        ingresosPorCategoria: [
            { categoria: "Clase B (A. Chill√°n)", cantidad: 18, total: 5040000, porcentaje: 59.5 },
            { categoria: "Profesional (C. Chill√°n)", cantidad: 6, total: 2280000, porcentaje: 26.9 },
            { categoria: "Psicot√©cnico", cantidad: 12, total: 480000, porcentaje: 5.7 },
            { categoria: "Clases Extra", cantidad: 15, total: 375000, porcentaje: 4.4 },
            { categoria: "Certificados", cantidad: 20, total: 300000, porcentaje: 3.5 },
        ],
    },
};

// Usar datos consolidados como default SSR (el filtro real es client-side)
const meses = datosPorEscuela["ambas"].meses;
const ingresosPorCategoria = datosPorEscuela["ambas"].ingresosPorCategoria;

const egresosPorCategoria = [
    { categoria: "Bencina", cantidad: 45, total: 850000, porcentaje: 38.5 },
    { categoria: "Arriendo", cantidad: 2, total: 600000, porcentaje: 27.1 },
    { categoria: "Sueldos", cantidad: 2, total: 380000, porcentaje: 17.2 },
    { categoria: "Mantenci√≥n", cantidad: 8, total: 195000, porcentaje: 8.8 },
    { categoria: "Materiales", cantidad: 12, total: 105000, porcentaje: 4.8 },
    { categoria: "Aseo", cantidad: 6, total: 42000, porcentaje: 1.9 },
    { categoria: "Otros", cantidad: 4, total: 38000, porcentaje: 1.7 },
];

const totalIngresos = ingresosPorCategoria.reduce((s, i) => s + i.total, 0);
const totalGastos = egresosPorCategoria.reduce((s, e) => s + e.total, 0);
const totalNeto = totalIngresos - totalGastos;

// Datos diarios para tabla detallada
const detallesDiarios = [
    { fecha: "2026-01-02", ingresos: 560000, gastos: 85000, operaciones: 4 },
    { fecha: "2026-01-03", ingresos: 310000, gastos: 62000, operaciones: 3 },
    { fecha: "2026-01-06", ingresos: 680000, gastos: 95000, operaciones: 6 },
    { fecha: "2026-01-07", ingresos: 280000, gastos: 43000, operaciones: 2 },
    { fecha: "2026-01-08", ingresos: 420000, gastos: 78000, operaciones: 5 },
    { fecha: "2026-01-09", ingresos: 380000, gastos: 55000, operaciones: 3 },
    { fecha: "2026-01-10", ingresos: 290000, gastos: 120000, operaciones: 4 },
    { fecha: "2026-01-13", ingresos: 510000, gastos: 68000, operaciones: 5 },
    { fecha: "2026-01-14", ingresos: 340000, gastos: 92000, operaciones: 3 },
    { fecha: "2026-01-15", ingresos: 600000, gastos: 45000, operaciones: 7 },
    { fecha: "2026-01-16", ingresos: 480000, gastos: 87000, operaciones: 4 },
];
---

<div class="mb-6">
    <div class="flex items-center gap-2 text-sm text-secondary mb-2">
        <a href={`${basePath}/dashboard`} class="hover:text-gray-900">Inicio</a>
        <span>/</span>
        <span class="text-gray-900 font-medium">Reportes Contables</span>
    </div>
</div>

<!-- Header -->
<div
    class="mb-8 flex flex-col sm:flex-row sm:items-center justify-between gap-4"
>
    <div>
        <h1 class="text-3xl font-semibold text-gray-900">Reportes Contables</h1>
        <p class="text-secondary mt-1">
            RF-030 / RF-031 ¬∑ Resumen financiero y Total Neto por rango de fechas
        </p>
    </div>
    <!-- Selector de escuela (dropdown) -->
    <div class="relative self-start sm:self-auto" data-reportes-escuela-selector>
        <button
            type="button"
            id="badge-escuela"
            aria-haspopup="listbox"
            aria-expanded="false"
            aria-label="Cambiar escuela para el reporte"
            class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 bg-gray-50 hover:bg-gray-100 hover:border-gray-300 text-sm font-medium text-gray-700 transition-colors cursor-pointer"
        >
            <span id="badge-dot" class="w-2.5 h-2.5 rounded-full bg-gray-400 shrink-0"></span>
            <span id="badge-nombre">Ambas escuelas</span>
            <svg class="w-4 h-4 text-gray-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </button>
        <div
            id="reportes-escuela-dropdown"
            role="listbox"
            class="hidden absolute right-0 top-full mt-1.5 min-w-[180px] bg-white border border-gray-200 rounded-lg shadow-lg py-1 z-50"
        >
            <button type="button" role="option" class="reportes-escuela-option block w-full text-left px-3 py-2.5 text-sm text-gray-900 hover:bg-gray-100 first:rounded-t-lg transition-colors" data-escuela-id="ambas">
                Ambas escuelas
            </button>
            <button type="button" role="option" class="reportes-escuela-option block w-full text-left px-3 py-2.5 text-sm text-gray-900 hover:bg-gray-100 transition-colors" data-escuela-id="autoescuela-chillan">
                Autoescuela Chill√°n
            </button>
            <button type="button" role="option" class="reportes-escuela-option block w-full text-left px-3 py-2.5 text-sm text-gray-900 hover:bg-gray-100 last:rounded-b-lg transition-colors" data-escuela-id="conductores-chillan">
                Conductores Chill√°n
            </button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- FILTROS DE RANGO DE FECHAS (RF-031) -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<Card class="mb-6">
    <div class="flex flex-wrap items-end gap-4">

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
                >Rango</label
            >
            <select
                id="rango-rapido"
                class="h-11 px-4 text-sm bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900"
            >
                <option value="mes-actual">Mes actual (Febrero 2026)</option>
                <option value="mes-anterior" selected
                    >Mes anterior (Enero 2026)</option
                >
                <option value="trimestre">√öltimo trimestre</option>
                <option value="custom">Personalizado</option>
            </select>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
                >Desde</label
            >
            <input
                type="date"
                id="fecha-desde"
                class="h-11 px-4 text-sm bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900"
                value="2026-01-01"
            />
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
                >Hasta</label
            >
            <input
                type="date"
                id="fecha-hasta"
                class="h-11 px-4 text-sm bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900"
                value="2026-01-31"
            />
        </div>

        <Button variant="primary" onClick="aplicarFiltro()">
            <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
                ></path>
            </svg>
            Aplicar
        </Button>

        <div class="flex gap-2 ml-auto">
            <button
                class="inline-flex items-center gap-2 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors"
                onclick="exportarExcel()"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    ></path>
                </svg>
                Excel
            </button>
            <button
                class="inline-flex items-center gap-2 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors"
                onclick="exportarPDF()"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                    ></path>
                </svg>
                PDF
            </button>
        </div>
    </div>
</Card>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TOTAL NETO (RF-031) -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="grid sm:grid-cols-3 gap-4 mb-6">
    <Card
        class="border-2 border-green-200 bg-gradient-to-br from-green-50 to-emerald-50"
    >
        <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl">üìà</span>
            <p class="text-sm font-semibold text-gray-900">Total Ingresos</p>
        </div>
        <p id="kpi-ingresos" class="text-3xl font-bold text-green-700">
            ${totalIngresos.toLocaleString("es-CL")}
        </p>
        <p class="text-xs text-green-600 mt-2">
            {ingresosPorCategoria.reduce((s, i) => s + i.cantidad, 0)} operaciones
            en per√≠odo
        </p>
    </Card>

    <Card
        class="border-2 border-red-200 bg-gradient-to-br from-red-50 to-rose-50"
    >
        <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl">üìâ</span>
            <p class="text-sm font-semibold text-gray-900">Total Gastos</p>
        </div>
        <p id="kpi-gastos" class="text-3xl font-bold text-red-700">
            ${totalGastos.toLocaleString("es-CL")}
        </p>
        <p class="text-xs text-red-600 mt-2">
            {egresosPorCategoria.reduce((s, e) => s + e.cantidad, 0)} egresos en per√≠odo
        </p>
    </Card>

    <Card
        class={`border-2 ${totalNeto >= 0 ? "border-blue-300 bg-gradient-to-br from-blue-50 to-indigo-50" : "border-orange-300 bg-gradient-to-br from-orange-50 to-amber-50"}`}
    >
        <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl">üí∞</span>
            <p class="text-sm font-semibold text-gray-900">
                Total Neto (RF-031)
            </p>
        </div>
        <p
            id="kpi-neto"
            class={`text-3xl font-bold ${totalNeto >= 0 ? "text-blue-700" : "text-orange-700"}`}
        >
            ${totalNeto.toLocaleString("es-CL")}
        </p>
        <p class="text-xs text-gray-500 mt-2">
            Ingresos Totales ‚àí Gastos Totales
        </p>
    </Card>
</div>

<!-- Banner resumen -->
<Card class="mb-6">
    <div
        class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-lg p-6 text-white"
    >
        <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
        >
            <div>
                <p class="text-sm text-gray-300 mb-1">
                    Per√≠odo seleccionado: 01/01/2026 - 31/01/2026
                </p>
                <p class="text-xs text-gray-400">
                    Reporte contable mensual con resumen por secci√≥n
                </p>
            </div>
            <div class="text-right">
                <p id="banner-escuela" class="text-xs text-gray-300 mb-1">Ambas escuelas</p>
                <p class="text-xs text-gray-400">Margen de ganancia</p>
                <p id="kpi-margen" class="text-3xl font-bold text-green-400">
                    {
                        totalIngresos > 0
                            ? ((totalNeto / totalIngresos) * 100).toFixed(1)
                            : "0"
                    }%
                </p>
            </div>
        </div>
    </div>
</Card>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- INGRESOS POR CATEGOR√çA (RF-030) -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="grid lg:grid-cols-2 gap-6 mb-6">
    <Card>
        <h2
            class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2"
        >
            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
            Ingresos por Categor√≠a
        </h2>

        <div id="tbody-ingresos" class="space-y-3">
            {
                ingresosPorCategoria.map((item) => (
                    <div class="flex items-center gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-900">
                                    {item.categoria}
                                </span>
                                <span class="text-sm font-bold text-green-700">
                                    ${item.total.toLocaleString("es-CL")}
                                </span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2.5">
                                <div
                                    class="bg-green-500 h-2.5 rounded-full transition-all"
                                    style={`width: ${item.porcentaje}%`}
                                />
                            </div>
                            <div class="flex justify-between mt-1">
                                <span class="text-xs text-secondary">
                                    {item.cantidad} operaciones
                                </span>
                                <span class="text-xs text-secondary">
                                    {item.porcentaje}%
                                </span>
                            </div>
                        </div>
                    </div>
                ))
            }
        </div>

        <div class="mt-4 pt-3 border-t border-gray-200 flex justify-between">
            <span class="text-sm font-bold text-gray-900">Total Ingresos</span>
            <span id="total-ingresos" class="text-sm font-bold text-green-700"
                >${totalIngresos.toLocaleString("es-CL")}</span
            >
        </div>
    </Card>

    <!-- GASTOS POR CATEGOR√çA -->
    <Card>
        <h2
            class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2"
        >
            <span class="w-3 h-3 bg-red-500 rounded-full"></span>
            Gastos por Categor√≠a
        </h2>

        <div class="space-y-3">
            {
                egresosPorCategoria.map((item) => (
                    <div class="flex items-center gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-900">
                                    {item.categoria}
                                </span>
                                <span class="text-sm font-bold text-red-700">
                                    ${item.total.toLocaleString("es-CL")}
                                </span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2.5">
                                <div
                                    class="bg-red-500 h-2.5 rounded-full transition-all"
                                    style={`width: ${item.porcentaje}%`}
                                />
                            </div>
                            <div class="flex justify-between mt-1">
                                <span class="text-xs text-secondary">
                                    {item.cantidad} registros
                                </span>
                                <span class="text-xs text-secondary">
                                    {item.porcentaje}%
                                </span>
                            </div>
                        </div>
                    </div>
                ))
            }
        </div>

        <div class="mt-4 pt-3 border-t border-gray-200 flex justify-between">
            <span class="text-sm font-bold text-gray-900">Total Gastos</span>
            <span class="text-sm font-bold text-red-700"
                >${totalGastos.toLocaleString("es-CL")}</span
            >
        </div>
    </Card>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- EVOLUCI√ìN MENSUAL -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<Card class="mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Evoluci√≥n Mensual</h2>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th
                        class="text-left py-3 px-4 text-xs font-semibold text-gray-700 uppercase"
                        >Mes</th
                    >
                    <th
                        class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase"
                        >Ingresos</th
                    >
                    <th
                        class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase"
                        >Gastos</th
                    >
                    <th
                        class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase"
                        >Neto</th
                    >
                    <th
                        class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase"
                        >Margen</th
                    >
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {
                    meses.map((m) => {
                        const neto = m.ingresos - m.gastos;
                        const margen =
                            m.ingresos > 0
                                ? ((neto / m.ingresos) * 100).toFixed(1)
                                : "0";
                        return (
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="py-3 px-4 text-sm font-medium text-gray-900">
                                    {m.mes}
                                </td>
                                <td class="py-3 px-4 text-right text-sm font-semibold text-green-700">
                                    ${m.ingresos.toLocaleString("es-CL")}
                                </td>
                                <td class="py-3 px-4 text-right text-sm font-semibold text-red-600">
                                    ${m.gastos.toLocaleString("es-CL")}
                                </td>
                                <td
                                    class={`py-3 px-4 text-right text-sm font-bold ${neto >= 0 ? "text-blue-700" : "text-orange-700"}`}
                                >
                                    ${neto.toLocaleString("es-CL")}
                                </td>
                                <td class="py-3 px-4 text-right">
                                    <span
                                        class={`inline-flex px-2 py-0.5 rounded text-xs font-semibold ${Number(margen) >= 50 ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"}`}
                                    >
                                        {margen}%
                                    </span>
                                </td>
                            </tr>
                        );
                    })
                }
            </tbody>
        </table>
    </div>
</Card>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- DETALLE DIARIO -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<Card>
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Detalle Diario</h2>
        <span class="text-sm text-secondary"
            >{detallesDiarios.length} d√≠as con movimientos</span
        >
    </div>

    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th
                        class="text-left py-3 px-4 text-xs font-semibold text-gray-700 uppercase"
                        >Fecha</th
                    >
                    <th
                        class="text-center py-3 px-4 text-xs font-semibold text-gray-700 uppercase"
                        >Operaciones</th
                    >
                    <th
                        class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase"
                        >Ingresos</th
                    >
                    <th
                        class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase"
                        >Gastos</th
                    >
                    <th
                        class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase"
                        >Neto</th
                    >
                    <th
                        class="text-center py-3 px-4 text-xs font-semibold text-gray-700 uppercase"
                        >Acci√≥n</th
                    >
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {
                    detallesDiarios.map((d) => {
                        const neto = d.ingresos - d.gastos;
                        return (
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="py-3 px-4 text-sm font-medium text-gray-900">
                                    {d.fecha}
                                </td>
                                <td class="py-3 px-4 text-center text-sm text-secondary">
                                    {d.operaciones}
                                </td>
                                <td class="py-3 px-4 text-right text-sm text-green-700">
                                    +${d.ingresos.toLocaleString("es-CL")}
                                </td>
                                <td class="py-3 px-4 text-right text-sm text-red-600">
                                    -${d.gastos.toLocaleString("es-CL")}
                                </td>
                                <td
                                    class={`py-3 px-4 text-right text-sm font-bold ${neto >= 0 ? "text-blue-700" : "text-red-700"}`}
                                >
                                    ${neto.toLocaleString("es-CL")}
                                </td>
                                <td class="py-3 px-4 text-center">
                                    <a
                                        href={`${basePath}/contabilidad/cuadratura`}
                                        class="text-xs text-blue-600 hover:text-blue-800 font-medium hover:underline"
                                    >
                                        Ver detalle
                                    </a>
                                </td>
                            </tr>
                        );
                    })
                }
            </tbody>
            <tfoot>
                <tr class="border-t-2 border-gray-300 bg-gray-50">
                    <td class="py-3 px-4 text-sm font-bold text-gray-900"
                        >TOTAL</td
                    >
                    <td
                        class="py-3 px-4 text-center text-sm font-bold text-gray-900"
                    >
                        {detallesDiarios.reduce((s, d) => s + d.operaciones, 0)}
                    </td>
                    <td
                        class="py-3 px-4 text-right text-sm font-bold text-green-700"
                    >
                        +${
                            detallesDiarios
                                .reduce((s, d) => s + d.ingresos, 0)
                                .toLocaleString("es-CL")
                        }
                    </td>
                    <td
                        class="py-3 px-4 text-right text-sm font-bold text-red-600"
                    >
                        -${
                            detallesDiarios
                                .reduce((s, d) => s + d.gastos, 0)
                                .toLocaleString("es-CL")
                        }
                    </td>
                    <td
                        class="py-3 px-4 text-right text-sm font-bold text-blue-700"
                    >
                        ${
                            detallesDiarios
                                .reduce(
                                    (s, d) => s + (d.ingresos - d.gastos),
                                    0,
                                )
                                .toLocaleString("es-CL")
                        }
                    </td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
</Card>

<script is:inline>
// ‚îÄ‚îÄ DATOS POR ESCUELA (client-side) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DATOS_ESCUELA = {
    "ambas": {
        nombre: "Ambas escuelas",
        dotColor: "bg-gray-400",
        ingresos: 8475000,
        gastos: 2210000,
        categorias: [
            { nombre: "Clase B (A. Chill√°n)", monto: 5040000, pct: 59.5, ops: 18, color: "bg-blue-500" },
            { nombre: "Profesional (C. Chill√°n)", monto: 2280000, pct: 26.9, ops: 6, color: "bg-purple-500" },
            { nombre: "Psicot√©cnico", monto: 480000, pct: 5.7, ops: 12, color: "bg-green-500" },
            { nombre: "Clases Extra", monto: 375000, pct: 4.4, ops: 15, color: "bg-green-500" },
            { nombre: "Certificados", monto: 300000, pct: 3.5, ops: 20, color: "bg-green-500" },
        ],
    },
    "autoescuela-chillan": {
        nombre: "Autoescuela Chill√°n",
        dotColor: "bg-blue-500",
        ingresos: 6855000,
        gastos: 1460000,
        categorias: [
            { nombre: "Clase B", monto: 5040000, pct: 73.5, ops: 18, color: "bg-green-500" },
            { nombre: "Psicot√©cnico", monto: 480000, pct: 7.0, ops: 12, color: "bg-green-500" },
            { nombre: "Clases Extra", monto: 375000, pct: 5.5, ops: 15, color: "bg-green-500" },
            { nombre: "Certificados", monto: 960000, pct: 14.0, ops: 20, color: "bg-green-500" },
        ],
    },
    "conductores-chillan": {
        nombre: "Conductores Chill√°n",
        dotColor: "bg-purple-500",
        ingresos: 3680000,
        gastos: 750000,
        categorias: [
            { nombre: "Clase B", monto: 1400000, pct: 38.0, ops: 5, color: "bg-green-500" },
            { nombre: "Profesional", monto: 2280000, pct: 62.0, ops: 6, color: "bg-green-500" },
        ],
    },
};

function fmt(n) { return n.toLocaleString("es-CL"); }

function actualizarReporte(escuelaId) {
    const d = DATOS_ESCUELA[escuelaId];
    if (!d) return;
    const neto = d.ingresos - d.gastos;
    const margen = d.ingresos > 0 ? ((neto / d.ingresos) * 100).toFixed(1) : "0";

    // Badge escuela
    const dot = document.getElementById("badge-dot");
    const nombre = document.getElementById("badge-nombre");
    if (dot) dot.className = "w-2.5 h-2.5 rounded-full shrink-0 " + d.dotColor;
    if (nombre) nombre.textContent = d.nombre;

    // KPIs
    const elIngresos = document.getElementById("kpi-ingresos");
    const elGastos = document.getElementById("kpi-gastos");
    const elNeto = document.getElementById("kpi-neto");
    const elMargen = document.getElementById("kpi-margen");
    if (elIngresos) elIngresos.textContent = "$" + fmt(d.ingresos);
    if (elGastos) elGastos.textContent = "$" + fmt(d.gastos);
    if (elNeto) elNeto.textContent = "$" + fmt(neto);
    if (elMargen) elMargen.textContent = margen + "%";

    // Banner del per√≠odo
    const elBannerEscuela = document.getElementById("banner-escuela");
    if (elBannerEscuela) elBannerEscuela.textContent = "Escuela: " + d.nombre;

    // Tabla de ingresos por categor√≠a
    const tbody = document.getElementById("tbody-ingresos");
    const totalRow = document.getElementById("total-ingresos");
    if (tbody) {
        tbody.innerHTML = d.categorias.map(c => `
            <div class="flex items-center gap-3">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-gray-900">${c.nombre}</span>
                        <span class="text-sm font-bold text-green-700">$${fmt(c.monto)}</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2.5">
                        <div class="${c.color} h-2.5 rounded-full" style="width:${c.pct}%"></div>
                    </div>
                    <div class="flex justify-between mt-1">
                        <span class="text-xs text-gray-500">${c.ops} operaciones</span>
                        <span class="text-xs text-gray-500">${c.pct}%</span>
                    </div>
                </div>
            </div>
        `).join("");
    }
    if (totalRow) totalRow.textContent = "$" + fmt(d.ingresos);
}

function initReportesEscuelaSelector() {
    const btn = document.getElementById("badge-escuela");
    const dropdown = document.getElementById("reportes-escuela-dropdown");

    if (!btn || !dropdown) return;

    // Toggle dropdown al hacer clic en el bot√≥n
    btn.onclick = function (e) {
        e.stopPropagation();
        const isHidden = dropdown.classList.contains("hidden");
        if (isHidden) {
            dropdown.classList.remove("hidden");
            btn.setAttribute("aria-expanded", "true");
        } else {
            dropdown.classList.add("hidden");
            btn.setAttribute("aria-expanded", "false");
        }
    };

    document.querySelectorAll(".reportes-escuela-option").forEach(function (opt) {
        opt.onclick = function (e) {
            e.stopPropagation();
            const id = opt.getAttribute("data-escuela-id");
            if (id) {
                actualizarReporte(id);
                dropdown.classList.add("hidden");
                btn.setAttribute("aria-expanded", "false");
            }
        };
    });

    document.addEventListener("click", function (e) {
        if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
            dropdown.classList.add("hidden");
            btn.setAttribute("aria-expanded", "false");
        }
    });

    actualizarReporte("ambas");
}

if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initReportesEscuelaSelector);
} else {
    initReportesEscuelaSelector();
}
document.addEventListener("astro:page-load", initReportesEscuelaSelector);
</script>

<script is:inline>
    window.aplicarFiltro = function () {
        const desde = document.getElementById("fecha-desde")?.value;
        const hasta = document.getElementById("fecha-hasta")?.value;
        alert(
            `üìä Aplicando filtro\n\nDesde: ${desde}\nHasta: ${hasta}\n\nEn producci√≥n se recalcular√≠an los totales para el rango seleccionado.`,
        );
    };

    window.exportarExcel = function () {
        alert(
            `üìä Exportando Reporte Contable a Excel\n\nContenido:\n‚Ä¢ Resumen de ingresos por categor√≠a\n‚Ä¢ Resumen de gastos por categor√≠a\n‚Ä¢ Total Neto del per√≠odo\n‚Ä¢ Detalle diario completo\n‚Ä¢ Evoluci√≥n mensual\n\nFormato: .xlsx\nDescarga iniciada...`,
        );
    };

    window.exportarPDF = function () {
        alert(
            `üìÑ Exportando Reporte Contable a PDF\n\nContenido:\n‚Ä¢ Encabezado: Escuela de Conductores\n‚Ä¢ Per√≠odo: 01/01/2026 - 31/01/2026\n‚Ä¢ Resumen ejecutivo con Total Neto\n‚Ä¢ Desglose de ingresos por categor√≠a\n‚Ä¢ Desglose de gastos por categor√≠a\n‚Ä¢ Gr√°fico de evoluci√≥n mensual\n‚Ä¢ Detalle diario\n‚Ä¢ Pie: Fecha generaci√≥n y firma\n\nDescarga iniciada...`,
        );
    };

    // Filtro r√°pido
    document
        .getElementById("rango-rapido")
        ?.addEventListener("change", function (e) {
            const valor = e.target.value;
            const desde = document.getElementById("fecha-desde");
            const hasta = document.getElementById("fecha-hasta");
            if (valor === "mes-actual") {
                desde.value = "2026-02-01";
                hasta.value = "2026-02-28";
            } else if (valor === "mes-anterior") {
                desde.value = "2026-01-01";
                hasta.value = "2026-01-31";
            } else if (valor === "trimestre") {
                desde.value = "2025-11-01";
                hasta.value = "2026-01-31";
            }
        });
</script>
