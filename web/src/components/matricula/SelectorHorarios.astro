---
/**
 * Selector de Horarios - Componente Reutilizable
 * Genera un grid de horarios semanales en bloques de 1 hora.
 * Utilizable tanto en matrícula pública como en el panel de secretaría.
 */

// Simulamos los próximos 5 días hábiles a partir de hoy (mock)
const getProximosDiasDisponibles = () => {
    const dias = [];
    const hoy = new Date();

    // Nombres de días en español
    const nombresDias = [
        "Domingo",
        "Lunes",
        "Martes",
        "Miércoles",
        "Jueves",
        "Viernes",
        "Sábado",
    ];
    const nombresMeses = [
        "Ene",
        "Feb",
        "Mar",
        "Abr",
        "May",
        "Jun",
        "Jul",
        "Ago",
        "Sep",
        "Oct",
        "Nov",
        "Dic",
    ];

    let count = 0;
    let cursor = new Date(hoy);

    // Nos movemos al día siguiente para empezar
    cursor.setDate(cursor.getDate() + 1);

    while (count < 5) {
        // 5 días para mostrar una "semana típica"
        // Saltar fines de semana (0 = Domingo, 6 = Sábado)
        if (cursor.getDay() !== 0 && cursor.getDay() !== 6) {
            dias.push({
                id: cursor.toISOString().split("T")[0],
                nombreCorto: nombresDias[cursor.getDay()].substring(0, 3), // Lun, Mar, Mie...
                nombreLargo: nombresDias[cursor.getDay()],
                numero: cursor.getDate(),
                mes: nombresMeses[cursor.getMonth()],
                fechaCompleta: cursor.toISOString(), // Para el valor del input
            });
            count++;
        }
        cursor.setDate(cursor.getDate() + 1);
    }
    return dias;
};

const diasDisponibles = getProximosDiasDisponibles();

// Bloques de 1 hora desde las 09:00 hasta las 18:00 (último bloque 17:00-18:00)
const bloquesHorarios = [
    "09:00 - 10:00",
    "10:00 - 11:00",
    "11:00 - 12:00",
    "12:00 - 13:00",
    "13:00 - 14:00", // (Típicamente colación, pero lo dejaremos para demo)
    "14:00 - 15:00",
    "15:00 - 16:00",
    "16:00 - 17:00",
    "17:00 - 18:00",
];

// Mockeamos la disponibilidad aleatoriamente para simular que algunos están ocupados
// En producción, esto vendría de una base de datos validando (Autos + Instructores libres)
const chequearDisponibilidad = (diaId: string, bloque: string) => {
    // Simulamos ocupación estática basada en el string para que no cambie al re-renderizar
    const hash = (diaId + bloque).length;
    // ~20% de probabilidad de estar ocupado
    return hash % 5 !== 0;
};

// Generar matriz de disponibilidad
const disponibilidad = diasDisponibles.map((dia) => ({
    ...dia,
    bloques: bloquesHorarios.map((bloque) => ({
        rango: bloque,
        isDisponible: chequearDisponibilidad(dia.id, bloque),
        id: `${dia.id}_${bloque}`,
    })),
}));
---

<div class="selector-horarios-container mt-8" id="selector-horarios-container">
    <div class="border-t border-gray-200 pt-8 mb-6">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold text-gray-900">
                Paso 3: Reserva tu Primera Clase
            </h3>
            <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
            >
                <svg
                    class="-ml-0.5 mr-1.5 h-2 w-2 text-blue-500"
                    fill="currentColor"
                    viewBox="0 0 8 8"
                >
                    <circle cx="4" cy="4" r="3"></circle>
                </svg>
                Requerido
            </span>
        </div>
        <p class="text-sm text-gray-500 mb-6">
            Selecciona la fecha y hora de inicio de tus clases prácticas. Los
            cupos mostrados están confirmados en tiempo real. (En un futuro aquí
            se mostrarán los cupos disponibles) (se selecciona la primera clase
            , luego en su perfil se podran ver las demas clases) (se asigna un
            dependiendo de la disponibilidad de los instructores y vehiculos
            para ese bloque seleccionado) (ese instructor seguira siendo el
            mismo para todas sus clases, en su perfil solo se mostrara los
            bloques disponibles del instructor asignado)
        </p>

        <!-- UI del Calendario / Selector -->
        <div
            class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm"
        >
            <!-- Navegación de Días (Tabs Horizontales) -->
            <div
                class="flex overflow-x-auto border-b border-gray-200 bg-gray-50 scrollbar-hide"
                id="horario-tabs-container"
            >
                {
                    disponibilidad.map((dia, index) => (
                        <button
                            type="button"
                            class={`horario-tab flex-1 min-w-[100px] py-4 px-2 text-center border-b-2 transition-colors ${index === 0 ? "border-blue-600 bg-white text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-100"}`}
                            data-target={`panel-dia-${index}`}
                            aria-selected={index === 0 ? "true" : "false"}
                        >
                            <div class="text-xs font-medium uppercase tracking-wider mb-1">
                                {dia.nombreCorto}
                            </div>
                            <div class="text-2xl font-bold">{dia.numero}</div>
                            <div class="text-xs">{dia.mes}</div>
                        </button>
                    ))
                }
            </div>

            <!-- Paneles de Horarios por Día -->
            <div class="p-6 bg-white min-h-[300px]">
                {
                    disponibilidad.map((dia, index) => (
                        <div
                            id={`panel-dia-${index}`}
                            class={`horario-panel grid grid-cols-2 sm:grid-cols-3 gap-3 ${index !== 0 ? "hidden" : ""}`}
                        >
                            {dia.bloques.map((bloque) => (
                                <label
                                    class={`horario-bloque relative flex flex-col items-center justify-center p-3 border rounded-lg cursor-pointer transition-all ${
                                        bloque.isDisponible
                                            ? "border-gray-200 hover:border-blue-400 hover:bg-blue-50/50 focus-within:ring-2 focus-within:ring-blue-500 focus-within:ring-offset-1 bg-white"
                                            : "border-gray-100 bg-gray-50 opacity-60 cursor-not-allowed"
                                    }`}
                                >
                                    <input
                                        type="radio"
                                        name="horario_seleccionado"
                                        value={bloque.id}
                                        class="sr-only"
                                        disabled={!bloque.isDisponible}
                                        data-dia={dia.nombreLargo}
                                        data-fecha={`${dia.numero} ${dia.mes}`}
                                        data-hora={bloque.rango}
                                    />
                                    <span
                                        class={`font-medium text-sm ${bloque.isDisponible ? "text-gray-900" : "text-gray-400 line-through"}`}
                                    >
                                        {bloque.rango}
                                    </span>

                                    {bloque.isDisponible && (
                                        <div class="absolute top-2 right-2 text-blue-600 opacity-0 transition-opacity peer-checked:opacity-100 custom-checkmark">
                                            <svg
                                                class="w-4 h-4"
                                                fill="currentColor"
                                                viewBox="0 0 20 20"
                                            >
                                                <path
                                                    fill-rule="evenodd"
                                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                    clip-rule="evenodd"
                                                />
                                            </svg>
                                        </div>
                                    )}

                                    {!bloque.isDisponible && (
                                        <span class="text-[10px] text-gray-400 mt-1">
                                            Agotado
                                        </span>
                                    )}
                                </label>
                            ))}
                        </div>
                    ))
                }
            </div>
        </div>

        <!-- Mensaje de error (oculto por defecto) -->
        <p
            id="error-horario-online"
            class="mt-3 text-sm text-red-600 hidden flex items-center gap-1"
        >
            <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path></svg
            >
            Por favor, selecciona un horario para continuar.
        </p>
    </div>
</div>

<style>
    /* Esconder la barra de scroll en tabs de fecha en móvil */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Estado seleccionado del bloque de horario */
    .horario-bloque:has(input:checked) {
        border-color: rgb(37 99 235);
        background-color: rgb(239 246 255);
        box-shadow: 0 0 0 1px rgb(37 99 235);
    }
    .horario-bloque:has(input:checked) .custom-checkmark {
        opacity: 1;
    }
</style>

<script>
    function initSelectorHorarios() {
        const tabs = document.querySelectorAll(".horario-tab");
        const panels = document.querySelectorAll(".horario-panel");

        tabs.forEach((tab) => {
            tab.addEventListener("click", () => {
                // Desactivar todos
                tabs.forEach((t) => {
                    t.setAttribute("aria-selected", "false");
                    t.classList.remove(
                        "border-blue-600",
                        "bg-white",
                        "text-blue-600",
                    );
                    t.classList.add("border-transparent", "text-gray-500");
                });
                panels.forEach((p) => p.classList.add("hidden"));

                // Activar el clickeado
                tab.setAttribute("aria-selected", "true");
                tab.classList.remove("border-transparent", "text-gray-500");
                tab.classList.add(
                    "border-blue-600",
                    "bg-white",
                    "text-blue-600",
                );

                const targetId = tab.getAttribute("data-target");
                if (targetId) {
                    document
                        .getElementById(targetId)
                        ?.classList.remove("hidden");
                }
            });
        });

        // Lógica para actualizar el resumen (esta parte se complementará con el script de matricula-online)
        const radios = document.querySelectorAll(
            'input[name="horario_seleccionado"]',
        );
        radios.forEach((radio) => {
            radio.addEventListener("change", (e) => {
                const target = e.target as HTMLInputElement;
                const dia = target.getAttribute("data-dia");
                const fecha = target.getAttribute("data-fecha");
                const hora = target.getAttribute("data-hora");

                // Despachar evento custom para que lo atrape la vista padre
                const event = new CustomEvent("horarioSeleccionado", {
                    detail: { dia, fecha, hora, id: target.value },
                });
                document.dispatchEvent(event);

                // Limpiar error si existiera
                document
                    .getElementById("error-horario-online")
                    ?.classList.add("hidden");
            });
        });
    }
    document.addEventListener("DOMContentLoaded", initSelectorHorarios);
    document.addEventListener("astro:page-load", initSelectorHorarios);
</script>
