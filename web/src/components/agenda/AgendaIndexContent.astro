---
/**
 * Contenido del índice de Agenda. Reutilizable para admin y secretaria con basePath.
 * RF-012: Gestión de clases (instructor + vehículo + alumno)
 */
import Card from "../ui/Card.astro";
import Button from "../ui/Button.astro";

interface Props {
  basePath?: string;
}

const { basePath = "" } = Astro.props;

const clasesHoy = [
  { hora: "09:00", alumno: "María González", instructor: "Carlos Rojas", vehiculo: "ABC-123", estado: "confirmada" },
  { hora: "10:30", alumno: "Juan Pérez", instructor: "Ana Martínez", vehiculo: "XYZ-789", estado: "confirmada" },
  { hora: "12:00", alumno: "Sofía Vargas", instructor: "Carlos Rojas", vehiculo: "ABC-123", estado: "en_curso" },
  { hora: "14:00", alumno: "Pedro Silva", instructor: "Luis Torres", vehiculo: "DEF-456", estado: "pendiente" },
  { hora: "16:00", alumno: "Ana López", instructor: "Carlos Rojas", vehiculo: "ABC-123", estado: "pendiente" },
];

// Mock para filtros (RF-018: filtros por instructor, vehículo, fecha, estado)
const instructoresMock = [
  { id: "", nombre: "Todos los instructores" },
  { id: "carlos", nombre: "Carlos Rojas" },
  { id: "ana", nombre: "Ana Martínez" },
  { id: "luis", nombre: "Luis Torres" },
  { id: "patricia", nombre: "Patricia Soto" },
];
const vehiculosMock = [
  { id: "", patente: "Todos los vehículos" },
  { id: "abc", patente: "ABC-123" },
  { id: "xyz", patente: "XYZ-789" },
  { id: "def", patente: "DEF-456" },
];
const estadosMock = [
  { id: "", label: "Todos los estados" },
  { id: "pendiente", label: "Pendiente" },
  { id: "confirmada", label: "Confirmada" },
  { id: "en_curso", label: "En curso" },
  { id: "completada", label: "Completada" },
  { id: "cancelada", label: "Cancelada" },
];

// Vista "Hoy por instructor": franjas horarias (bloques 1h, RF-014) y asignación por instructor
const franjasHoy = ["09:00", "10:00", "11:00", "12:00", "14:00", "16:00"];
const instructoresHoy = ["Carlos Rojas", "Ana Martínez", "Luis Torres"];
// Mapa (instructor, hora) -> clase: clave normalizada "HH:MM" para matchear 10:30 -> 10:00
const claseEnSlot = (instructor: string, hora: string): { alumno: string; vehiculo: string; estado: string } | null => {
  const slotHora = hora.slice(0, 2);
  for (const c of clasesHoy) {
    if (c.instructor !== instructor) continue;
    if (c.hora.slice(0, 2) === slotHora) return { alumno: c.alumno, vehiculo: c.vehiculo, estado: c.estado };
  }
  return null;
};

const diasSemana = ["Lun 3", "Mar 4", "Mié 5", "Jue 6", "Vie 7", "Sáb 8"];
// Clases por día de la semana (clave = etiqueta del día) para vista "Todos" en el calendario
type ClaseDia = { hora: string; alumno: string; estado: string };
const clasesPorDia: Record<string, ClaseDia[]> = {
  "Lun 3": [
    { hora: "09:00", alumno: "L. Muñoz", estado: "completada" },
    { hora: "11:00", alumno: "C. Díaz", estado: "completada" },
    { hora: "15:00", alumno: "R. Soto", estado: "completada" },
  ],
  "Mar 4": [
    { hora: "10:00", alumno: "M. Fernández", estado: "completada" },
    { hora: "14:00", alumno: "A. Ríos", estado: "completada" },
  ],
  "Mié 5": [
    { hora: "09:00", alumno: "M. González", estado: "confirmada" },
    { hora: "09:00", alumno: "R. Torres", estado: "confirmada" },
    { hora: "10:30", alumno: "J. Pérez", estado: "confirmada" },
    { hora: "12:00", alumno: "S. Vargas", estado: "en_curso" },
    { hora: "14:00", alumno: "P. Silva", estado: "pendiente" },
    { hora: "16:00", alumno: "A. López", estado: "pendiente" },
  ],
  "Jue 6": [
    { hora: "09:00", alumno: "T. López", estado: "pendiente" },
    { hora: "12:00", alumno: "F. Martínez", estado: "pendiente" },
    { hora: "16:00", alumno: "K. Vega", estado: "pendiente" },
  ],
  "Vie 7": [
    { hora: "10:00", alumno: "N. Reyes", estado: "pendiente" },
    { hora: "14:00", alumno: "J. Campos", estado: "pendiente" },
  ],
  "Sáb 8": [
    { hora: "09:00", alumno: "B. Navarro", estado: "pendiente" },
    { hora: "11:00", alumno: "D. Ortiz", estado: "pendiente" },
  ],
};

const estadoBadge: Record<string, { label: string; class: string }> = {
  confirmada: { label: "Confirmada", class: "bg-green-100 text-green-800" },
  en_curso: { label: "En Curso", class: "bg-blue-100 text-blue-800" },
  pendiente: { label: "Pendiente", class: "bg-orange-100 text-orange-800" },
  completada: { label: "Completada", class: "bg-gray-100 text-gray-800" },
  cancelada: { label: "Cancelada", class: "bg-red-100 text-red-800" },
};
---

<!-- Header -->
<div class="mb-8">
  <div class="flex items-center gap-2 text-sm text-secondary mb-2">
    <a href={`${basePath}/dashboard`} class="hover:text-gray-900">Inicio</a>
    <span>/</span>
    <span class="text-gray-900 font-medium">Agenda</span>
  </div>
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-semibold text-gray-900">Agenda de Clases</h1>
      <p class="text-secondary mt-1">Planificación de clases prácticas y teóricas</p>
    </div>
    <div class="flex gap-2">
      <Button variant="secondary">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
        </svg>
        Filtros
      </Button>
      <Button href={`${basePath}/agenda/nueva-clase`} variant="primary">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Agendar Clase
      </Button>
    </div>
  </div>
</div>

<!-- Filtros (RF-018: por instructor, vehículo, fecha, estado) -->
<Card class="p-4 mb-6">
  <div class="flex flex-wrap items-end gap-4">
    <div class="min-w-[180px]">
      <label for="filtro-instructor" class="block text-xs font-medium text-secondary mb-1">Instructor</label>
      <select id="filtro-instructor" name="instructor" class="w-full h-11 px-4 rounded-md border border-gray-300 bg-white text-gray-900 text-base focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 focus:outline-none" aria-label="Filtrar por instructor">
        {instructoresMock.map((i) => (
          <option value={i.id}>{i.nombre}</option>
        ))}
      </select>
    </div>
    <div class="min-w-[160px]">
      <label for="filtro-vehiculo" class="block text-xs font-medium text-secondary mb-1">Vehículo</label>
      <select id="filtro-vehiculo" name="vehiculo" class="w-full h-11 px-4 rounded-md border border-gray-300 bg-white text-gray-900 text-base focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 focus:outline-none" aria-label="Filtrar por vehículo">
        {vehiculosMock.map((v) => (
          <option value={v.id}>{v.patente}</option>
        ))}
      </select>
    </div>
    <div class="min-w-[160px]">
      <label for="filtro-estado" class="block text-xs font-medium text-secondary mb-1">Estado</label>
      <select id="filtro-estado" name="estado" class="w-full h-11 px-4 rounded-md border border-gray-300 bg-white text-gray-900 text-base focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 focus:outline-none" aria-label="Filtrar por estado">
        {estadosMock.map((e) => (
          <option value={e.id}>{e.label}</option>
        ))}
      </select>
    </div>
    <div class="min-w-[160px]">
      <label for="filtro-fecha" class="block text-xs font-medium text-secondary mb-1">Fecha</label>
      <input type="date" id="filtro-fecha" name="fecha" value="2026-02-05" class="w-full h-11 px-4 rounded-md border border-gray-300 bg-white text-gray-900 text-base focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 focus:outline-none" aria-label="Filtrar por fecha" />
    </div>
    <Button variant="secondary" type="button">Aplicar</Button>
  </div>
</Card>

<!-- Stats rápidos -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
  <Card class="p-4">
    <p class="text-xs text-secondary">Hoy</p>
    <p class="text-2xl font-semibold text-gray-900 mt-1">18</p>
  </Card>
  <Card class="p-4">
    <p class="text-xs text-secondary">Esta semana</p>
    <p class="text-2xl font-semibold text-blue-600 mt-1">87</p>
  </Card>
  <Card class="p-4">
    <p class="text-xs text-secondary">Pendientes</p>
    <p class="text-2xl font-semibold text-orange-600 mt-1">12</p>
  </Card>
  <Card class="p-4">
    <p class="text-xs text-secondary">Completadas</p>
    <p class="text-2xl font-semibold text-green-600 mt-1">234</p>
  </Card>
</div>

<!-- Vista de agenda -->
<div class="grid lg:grid-cols-3 gap-6">
  <div class="lg:col-span-2">
    <Card>
      <div class="flex flex-col gap-2 mb-6">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-gray-900">Semana del 3 al 8 de Febrero, 2026</h2>
          <div class="flex gap-2">
            <Button variant="ghost" class="text-sm">← Anterior</Button>
            <Button variant="ghost" class="text-sm">Siguiente →</Button>
          </div>
        </div>
        <p class="text-sm text-secondary" aria-live="polite">Mostrando: todos los instructores · todos los vehículos</p>
      </div>

      <div class="grid grid-cols-6 gap-2 mb-4">
        {diasSemana.map((dia) => (
          <div class="text-center">
            <p class={`text-sm font-semibold ${dia === "Mié 5" ? "text-gray-900" : "text-secondary"}`}>{dia}</p>
          </div>
        ))}
      </div>

      <div class="grid grid-cols-6 gap-2">
        {diasSemana.map((dia) => {
          const clases = clasesPorDia[dia] ?? [];
          const esHoy = dia === "Mié 5";
          const blockClass = (estado: string) => {
            if (estado === "en_curso") return "bg-blue-100 border-blue-300 text-blue-900";
            if (estado === "confirmada") return "bg-green-100 border-green-300 text-green-800";
            if (estado === "pendiente") return "bg-orange-100 border-orange-300 text-orange-800";
            return "bg-gray-100 border-gray-200 text-gray-700";
          };
          return (
            <div class={`min-h-[400px] border rounded-lg p-2 ${esHoy ? "bg-blue-50 border-blue-200" : "bg-white border-gray-200"}`}>
              <div class="space-y-2">
                {clases.length > 0 ? (
                  clases.map((c) => (
                    <div class={`border rounded p-2 text-xs ${blockClass(c.estado)}`}>
                      <p class="font-semibold">{c.hora}</p>
                      <p class="truncate">{c.alumno}</p>
                    </div>
                  ))
                ) : (
                  <p class="text-xs text-gray-400 py-2">Sin clases</p>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </Card>

    <!-- Vista Hoy por instructor (franjas 1h, RF-014) -->
    <Card class="mt-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Hoy por instructor</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm border-collapse" role="table" aria-label="Agenda de hoy por instructor y franja horaria">
          <thead>
            <tr class="border-b border-gray-200">
              <th scope="col" class="text-left py-3 px-2 font-semibold text-gray-700">Instructor</th>
              {franjasHoy.map((h) => (
                <th scope="col" class="text-center py-3 px-2 font-semibold text-gray-700">{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {instructoresHoy.map((inst) => (
              <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                <td class="py-2 px-2 font-medium text-gray-900">{inst}</td>
                {franjasHoy.map((hora) => {
                  const clase = claseEnSlot(inst, hora);
                  return (
                    <td class="py-2 px-2 text-center align-middle">
                      {clase ? (
                        <div class={`inline-block rounded-lg px-2 py-1 text-xs text-left min-w-[4rem] ${clase.estado === "en_curso" ? "bg-blue-100 border border-blue-300 text-blue-900" : "bg-gray-100 border border-gray-200 text-gray-800"}`}>
                          <span class="font-medium block truncate max-w-[5rem]" title={clase.alumno}>{clase.alumno.split(" ").map((n) => n[0]).join(".")}</span>
                          <span class="text-gray-600">{clase.vehiculo}</span>
                        </div>
                      ) : (
                        <span class="text-gray-400" aria-hidden="true">—</span>
                      )}
                    </td>
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </Card>
  </div>

  <div class="space-y-4">
    <Card>
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-semibold text-gray-900">Clases de Hoy</h3>
        <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full font-medium">{clasesHoy.length} clases</span>
      </div>

      <div class="space-y-3">
        {clasesHoy.map((clase) => (
          <div class={`p-3 rounded-lg transition-colors ${clase.estado === "en_curso" ? "bg-blue-50 border-2 border-blue-500 shadow-sm ring-2 ring-blue-500/20" : "bg-gray-50 border border-gray-200 hover:border-gray-300"}`}>
            <div class="flex items-start justify-between mb-2">
              <p class="text-sm font-semibold text-gray-900">{clase.hora}</p>
              <span class={`text-xs px-2 py-0.5 rounded-full font-medium ${clase.estado === "en_curso" ? "bg-blue-600 text-white" : estadoBadge[clase.estado].class}`}>
                {estadoBadge[clase.estado].label}
              </span>
            </div>
            <div class="space-y-1 text-xs text-secondary">
              <div class="flex items-center gap-2">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span class="font-medium text-gray-700">{clase.alumno}</span>
              </div>
              <div class="flex items-center gap-2">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <span>{clase.instructor}</span>
              </div>
              <div class="flex items-center gap-2">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
                </svg>
                <span>{clase.vehiculo}</span>
              </div>
            </div>
          </div>
        ))}
      </div>
    </Card>

    <Card>
      <h3 class="text-sm font-semibold text-gray-900 mb-4">Recursos Disponibles</h3>
      <div class="space-y-3 text-sm">
        <div>
          <p class="text-xs text-secondary mb-1">Instructores</p>
          <div class="flex items-center gap-2">
            <div class="flex-1 bg-gray-200 rounded-full h-2">
              <div class="bg-green-500 h-2 rounded-full" style="width: 75%"></div>
            </div>
            <span class="text-xs font-medium">3/4</span>
          </div>
        </div>
        <div>
          <p class="text-xs text-secondary mb-1">Vehículos</p>
          <div class="flex items-center gap-2">
            <div class="flex-1 bg-gray-200 rounded-full h-2">
              <div class="bg-green-500 h-2 rounded-full" style="width: 83%"></div>
            </div>
            <span class="text-xs font-medium">10/12</span>
          </div>
        </div>
      </div>
    </Card>

    <Card class="bg-orange-50 border-orange-200">
      <div class="flex gap-3">
        <svg class="w-5 h-5 text-orange-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
        <div>
          <p class="text-sm font-medium text-orange-900 mb-1">Conflictos</p>
          <p class="text-xs text-orange-800">2 clases sin vehículo asignado para mañana</p>
          <Button href={`${basePath}/agenda/conflictos`} variant="ghost" class="text-xs mt-2 p-0 h-auto">Resolver →</Button>
        </div>
      </div>
    </Card>
  </div>
</div>

<style>
  .overflow-auto {
    scrollbar-width: thin;
    scrollbar-color: rgb(209, 213, 219) transparent;
  }
</style>
